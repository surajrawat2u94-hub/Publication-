<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Publication Data</title>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: .25rem; }
    .sub { color:#666; font-size:.9rem; margin-bottom:1rem; }
    .controls { display:flex; flex-wrap:wrap; gap:.5rem 1rem; align-items:end; margin: 10px 0 6px; }
    .controls label { display:block; font-size:.8rem; color:#333; margin-bottom:2px; }
    .controls select, .controls input { padding:6px 8px; font-size:.9rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: .9rem; vertical-align: top; }
    th { background: #f6f7f8; text-align: left; }
    a { color:#2058d6; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .meta { margin:6px 0 12px; color:#444; font-size:.9rem; }
    .pager { display:flex; gap:.5rem; align-items:center; margin: 10px 0; flex-wrap:wrap; }
    .pager button { padding:6px 10px; font-size:.9rem; }
    .pager .muted { color:#666; font-size:.9rem; }
    .row { display:flex; gap:1rem; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .right { margin-left:auto; display:flex; gap:.75rem; align-items:center; }
    .kpis { display:flex; gap:1rem; flex-wrap:wrap; margin:.5rem 0 1rem; }
    .kpi { background:#f6f9ff; border:1px solid #e2e8ff; padding:10px 12px; border-radius:8px; }
    .kpi b{ font-size:1.05rem; }
    .hidden { display:none; }
  </style>
</head>
<body>

  <h1>Publication Data</h1>
  <div class="sub" id="lastSynced">Loading…</div>

  <div class="controls">
    <div>
      <label for="searchBox">Search (title / author / journal)</label>
      <input id="searchBox" type="text" placeholder="Type to filter…" oninput="applyFilters(1)" />
    </div>
    <div>
      <label for="yearFilter">Year</label>
      <select id="yearFilter" onchange="applyFilters(1)">
        <option value="">All years</option>
      </select>
    </div>
    <div>
      <label for="retractionFilter">Retraction</label>
      <select id="retractionFilter" onchange="applyFilters(1)">
        <option value="">All</option>
        <option value="exclude">Exclude retracted</option>
        <option value="only">Only retracted</option>
      </select>
    </div>
    <div class="right">
      <div>
        <label for="pageSize">Rows per page</label>
        <select id="pageSize" onchange="changePageSize()">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
          <option value="200">200</option>
        </select>
      </div>
      <button onclick="exportCSV()">Export CSV (current view)</button>
      <button onclick="exportJSON()">Export JSON (current view)</button>
    </div>
  </div>

  <div class="kpis">
    <div class="kpi"><div>Total items</div><b id="kpiTotal">—</b></div>
    <div class="kpi"><div>Current view</div><b id="kpiView">—</b></div>
    <div class="kpi"><div>Retracted (view)</div><b id="kpiRetr">—</b></div>
  </div>

  <canvas id="yearChart" height="180"></canvas>

  <div class="row">
    <div class="meta" id="rangeText"></div>
    <div class="pager">
      <button onclick="goFirst()">« First</button>
      <button onclick="goPrev()">‹ Prev</button>
      <span class="muted" id="pageInfo">Page 1 / 1</span>
      <button onclick="goNext()">Next ›</button>
      <button onclick="goLast()">Last »</button>
    </div>
  </div>

  <table id="pubTable">
    <thead>
      <tr>
        <th style="width:70px;">Year</th>
        <th>Title</th>
        <th style="width:22%;">Journal</th>
        <th style="width:28%;">Authors</th>
        <th style="width:90px;">Citations</th>
        <th style="width:95px;">Retracted?</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="row">
    <div class="meta" id="countInfo"></div>
    <div class="pager">
      <button onclick="goFirst()">« First</button>
      <button onclick="goPrev()">‹ Prev</button>
      <span class="muted" id="pageInfoBottom">Page 1 / 1</span>
      <button onclick="goNext()">Next ›</button>
      <button onclick="goLast()">Last »</button>
    </div>
  </div>

<script>
let all = [];             // full dataset
let filtered = [];        // after search/filters
let currentPage = 1;
let pageSize = 50;
let chartObj = null;

function fmt(n){ return n.toLocaleString(); }

async function autoLoad() {
  try {
    const res = await fetch('institution_data.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('institution_data.json not found');
    const j = await res.json();

    // header info
    if (j.updated) {
      document.getElementById('lastSynced').textContent =
        'Last synced: ' + dayjs(j.updated).format('DD MMM YYYY, HH:mm');
    } else {
      document.getElementById('lastSynced').textContent = '';
    }

    all = Array.isArray(j.items) ? j.items : [];
    document.getElementById('kpiTotal').textContent = fmt(all.length);

    // populate year filter
    const years = [...new Set(all.map(x => x.year).filter(Boolean))].sort((a,b)=>b-a);
    const yearSel = document.getElementById('yearFilter');
    yearSel.innerHTML = '<option value="">All years</option>' + years.map(y=>`<option>${y}</option>`).join('');

    // set default page size from select
    pageSize = parseInt(document.getElementById('pageSize').value,10) || 50;

    // apply filters & render page 1
    applyFilters(1);
  } catch (e) {
    document.getElementById('lastSynced').textContent = 'Error: ' + e.message;
    console.error(e);
  }
}

function applyFilters(goToPage=1) {
  const q = (document.getElementById('searchBox').value || '').trim().toLowerCase();
  const y = document.getElementById('yearFilter').value;
  const rx = document.getElementById('retractionFilter').value;

  filtered = all.filter(p => {
    if (y && String(p.year) !== y) return false;
    if (rx === 'exclude' && p.is_retracted) return false;
    if (rx === 'only' && !p.is_retracted) return false;
    if (q) {
      const hay = [
        p.title || '',
        (p.journal || ''),
        ...(p.authors || [])
      ].join(' ').toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  document.getElementById('kpiView').textContent = fmt(filtered.length);
  document.getElementById('kpiRetr').textContent = fmt(filtered.filter(p=>p.is_retracted).length);

  // reset to page 1 if requested
  if (goToPage === 1) currentPage = 1;

  renderPage();
  renderChart();
}

function changePageSize() {
  pageSize = parseInt(document.getElementById('pageSize').value, 10) || 50;
  currentPage = 1;
  renderPage();
}

function totalPages() {
  return Math.max(1, Math.ceil(filtered.length / pageSize));
}

function goFirst(){ currentPage = 1; renderPage(); }
function goPrev(){ if (currentPage > 1) currentPage--; renderPage(); }
function goNext(){ if (currentPage < totalPages()) currentPage++; renderPage(); }
function goLast(){ currentPage = totalPages(); renderPage(); }

function renderPage() {
  const start = (currentPage - 1) * pageSize;
  const end = Math.min(start + pageSize, filtered.length);
  const pageRows = filtered.slice(start, end);

  // table
  const tbody = document.querySelector('#pubTable tbody');
  tbody.innerHTML = '';
  for (const p of pageRows) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.year ?? ''}</td>
      <td>${p.url ? `<a target="_blank" href="${p.url}">${escapeHtml(p.title||'')}</a>` : escapeHtml(p.title||'')}</td>
      <td>${escapeHtml(p.journal||'')}</td>
      <td>${escapeHtml((p.authors||[]).join(', '))}</td>
      <td>${p.citations ?? 0}</td>
      <td>${p.is_retracted ? 'Yes' : 'No'}</td>
    `;
    tbody.appendChild(tr);
  }

  // page info + range
  const info = `Page ${currentPage} / ${totalPages()}`;
  document.getElementById('pageInfo').textContent = info;
  document.getElementById('pageInfoBottom').textContent = info;

  const rangeText = filtered.length
    ? `Showing ${fmt(start+1)}–${fmt(end)} of ${fmt(filtered.length)} (filtered)`
    : `Showing 0 of 0`;
  document.getElementById('countInfo').textContent = rangeText;
  document.getElementById('rangeText').textContent = rangeText;
}

function renderChart() {
  const grouped = {};
  for (const p of filtered) {
    if (!p.year) continue;
    grouped[p.year] = (grouped[p.year] || 0) + 1;
  }
  const labels = Object.keys(grouped).sort((a,b)=>a-b);
  const data = labels.map(y => grouped[y]);

  const ctx = document.getElementById('yearChart').getContext('2d');
  if (chartObj) chartObj.destroy();
  chartObj = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label: 'Publications by year', data }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } }
    }
  });
}

function exportCSV() {
  if (!filtered.length) return;
  const rows = filtered.slice((currentPage-1)*pageSize, (currentPage-1)*pageSize + pageSize);
  const header = ['year','title','journal','authors','citations','retracted','doi','url'];
  const csv = [header.join(',')].concat(
    rows.map(r => [
      r.year || '',
      q(r.title || ''),
      q(r.journal || ''),
      q((r.authors||[]).join('; ')),
      r.citations ?? 0,
      r.is_retracted ? 'Yes' : 'No',
      r.doi || '',
      r.url || ''
    ].join(','))
  ).join('\n');
  downloadBlob('publications_view.csv', csv, 'text/csv');
}

function exportJSON() {
  const rows = filtered.slice((currentPage-1)*pageSize, (currentPage-1)*pageSize + pageSize);
  downloadBlob('publications_view.json', JSON.stringify(rows, null, 2), 'application/json');
}

// utils
function q(s){ return `"${String(s).replace(/"/g,'""')}"`; }
function downloadBlob(filename, content, mime){
  const blob = new Blob([content], {type: mime});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ '&':'&nbsp;&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

// ✅ auto-load on page ready
document.addEventListener('DOMContentLoaded', autoLoad);
</script>
</body>
</html>
