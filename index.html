<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI Publications Portal</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- Day.js + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .glass { background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(248,250,252,.85)); backdrop-filter: blur(10px); }
    .card  { background: rgba(255,255,255,.85); border:1px solid rgba(226,232,240,.9); border-radius:16px; box-shadow: 0 10px 20px rgba(2,6,23,.06); }
    .thin-scrollbar::-webkit-scrollbar{height:8px;width:8px}
    .thin-scrollbar::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:6px}
    .thin-scrollbar::-webkit-scrollbar-track{background:#F8FAFC}
    .tab-active{color:#111827;border-color:#7c3aed;background:linear-gradient(180deg,#fff,#f8fafc)}
    .tab-inactive{color:#6B7280;border-color:transparent}
    .dropdown{position:relative}
    .dropdown-panel{position:absolute;right:0;top:100%;z-index:40}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .5rem;border-radius:999px;font-size:.72rem;border:1px solid #e2e8f0;background:#f8fafc}
  </style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900">

  <!-- Header -->
  <header class="sticky top-0 z-30 bg-gradient-to-r from-indigo-600/90 via-fuchsia-600/90 to-sky-600/90 text-white backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-white/15 grid place-content-center shadow-inner">
          <i data-lucide="brain" class="text-white"></i>
        </div>
        <div>
          <h1 class="text-lg font-semibold tracking-tight">AI Publications Portal</h1>
          <div id="lastSynced" class="text-xs text-white/80">Loading…</div>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-2 text-xs">
        <span class="px-2 py-1 rounded-lg bg-white/10 border border-white/20">Static JSON · No live API</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white">
      <div class="max-w-7xl mx-auto px-4">
        <nav class="flex gap-2">
          <button id="tabOverview"     class="px-4 py-3 text-sm border-b-2 tab-active"   onclick="switchTab('overview')">Overview</button>
          <button id="tabPublications" class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('publications')">Publications</button>
          <button id="tabQuartiles"    class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('quartiles')">Quartiles</button>
          <button id="tabSDG"          class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('sdg')">SDGs</button>
        </nav>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- OVERVIEW -->
    <section id="view-overview" class="space-y-6">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="card p-4"><div class="text-xs text-slate-500">Total items</div><div id="kpiTotal" class="mt-1 text-2xl font-semibold">—</div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Current view</div><div id="kpiView" class="mt-1 text-2xl font-semibold">—</div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Retracted (view)</div><div id="kpiRetr" class="mt-1 text-2xl font-semibold">—</div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Distinct journals (view)</div><div id="kpiJournals" class="mt-1 text-2xl font-semibold">—</div></div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Publications by Year</h3>
            <span id="rangeText" class="text-xs text-slate-500"></span>
          </div>
          <div class="mt-2 h-[260px]"><canvas id="chartByYear"></canvas></div>
        </div>
        <div class="card p-4">
          <h3 class="font-semibold">Top Journals (view)</h3>
          <div class="mt-2 h-[260px]"><canvas id="chartTopJournals"></canvas></div>
        </div>
      </div>
    </section>

    <!-- PUBLICATIONS -->
    <section id="view-publications" class="hidden space-y-4">
      <div class="card p-4">
        <div class="flex flex-wrap items-end gap-3">
          <div>
            <label class="block text-xs font-medium text-slate-600">Search</label>
            <input id="searchBox" class="px-3 py-2 rounded-xl border border-slate-300 text-sm"
                   placeholder="Title / author / journal / DOI" oninput="applyFilters(1)"/>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-600">Year</label>
            <select id="yearFilter" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="applyFilters(1)">
              <option value="">All years</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-600">Retraction mode</label>
            <select id="retractionFilter" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="applyFilters(1)">
              <option value="">All</option>
              <option value="exclude">Exclude retracted</option>
              <option value="only_retracted">Only retracted (OpenAlex)</option>
              <option value="only_notices">Only retraction notices (title-based)</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-600">SDG</label>
            <select id="sdgFilter" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="applyFilters(1)">
              <option value="">All SDGs</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-600">Rows per page</label>
            <select id="pageSize" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="changePageSize()">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
          </div>

          <!-- Column chooser -->
          <div class="ml-auto dropdown">
            <button id="colBtn" class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-300 text-sm flex items-center gap-2"
                    onclick="toggleColumnsPanel()">
              <i data-lucide="columns-3"></i> Columns
            </button>
            <div id="columnsPanel" class="dropdown-panel hidden mt-2 bg-white border border-slate-200 rounded-xl shadow-lg w-80 p-3">
              <div class="text-xs text-slate-500 mb-2">Choose fields to display</div>
              <div id="columnsList" class="grid grid-cols-2 gap-y-2 text-sm"></div>
              <div class="flex justify-end gap-2 mt-3">
                <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="resetColumns()">Reset</button>
                <button class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white" onclick="applyColumnSelection()">Apply</button>
              </div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm" onclick="exportCSV()">Export CSV</button>
            <button class="px-3 py-2 rounded-xl bg-indigo-50 text-indigo-700 border border-indigo-200 text-sm" onclick="exportJSON()">Export JSON</button>
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="card">
        <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
          <div class="font-semibold">All Publications</div>
          <div class="text-xs text-slate-500" id="countInfo"></div>
        </div>
        <div class="overflow-x-auto thin-scrollbar">
          <table class="w-full text-sm" id="pubTable">
            <thead class="bg-slate-50 text-slate-600">
              <tr id="pubHeadRow"></tr>
            </thead>
            <tbody id="pubBody"></tbody>
          </table>
        </div>
        <div class="px-4 py-3 flex items-center justify-between">
          <div class="text-xs text-slate-500" id="pageInfo">Page 1 / 1</div>
          <div class="flex gap-2">
            <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goFirst()">« First</button>
            <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goPrev()">‹ Prev</button>
            <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goNext()">Next ›</button>
            <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goLast()">Last »</button>
          </div>
        </div>
      </div>
    </section>

    <!-- QUARTILES -->
    <section id="view-quartiles" class="hidden space-y-4">
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold">Quartile Mapping</h3>
            <p class="text-xs text-slate-500">
              Upload SJR quartiles as <code>.csv</code> (columns: Title, ISSN, Quartile) or <code>.json</code>
              (array with <code>title</code>/<code>issn</code>/<code>quartile</code>).
            </p>
          </div>
          <div class="flex items-center gap-2">
            <input id="sjrFile" type="file" accept=".csv,.json" class="hidden"/>
            <button class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-300 text-sm"
                    onclick="document.getElementById('sjrFile').click()">
              <i data-lucide="upload"></i> Upload Quartiles
            </button>
          </div>
        </div>
        <div id="sjrStatus" class="mt-2 text-xs text-slate-500"></div>
      </div>

      <div class="card p-4">
        <h4 class="font-semibold mb-2">Coverage in current view</h4>
        <div class="text-sm" id="mapCoverage">—</div>
      </div>
    </section>

    <!-- SDG -->
    <section id="view-sdg" class="hidden space-y-4">
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold">Sustainable Development Goals (auto-mapped)</h3>
            <p class="text-xs text-slate-500">Titles (and subjects, if present) are heuristically mapped to SDGs.</p>
          </div>
          <div class="flex items-center gap-2">
            <select id="sdgOnlyFilter" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="applyFilters(1)">
              <option value="">All SDGs</option>
            </select>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4">
          <h4 class="font-semibold">SDG Distribution (view)</h4>
          <div class="mt-2 h-[260px]"><canvas id="chartSDG"></canvas></div>
        </div>
        <div class="card p-4">
          <h4 class="font-semibold mb-2">Legend</h4>
          <div id="sdgLegend" class="flex flex-wrap gap-2 text-sm"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="text-center text-xs text-slate-500 pb-8">
    Data from <code>institution_data.json</code> · Quartiles mapped client-side · SDG & Retraction notices are heuristic
  </footer>

<script>
  lucide.createIcons();

  // ----------------- STATE -----------------
  let all = [];
  let filtered = [];
  let currentPage = 1;
  let pageSize = 50;

  // Quartiles
  const sjrByIssn = new Map();
  const sjrByTitle = new Map();
  let haveSJR = false;

  // Columns (default)
  const ALL_COLUMNS = [
    { key:'year',         label:'Year',          default:true },
    { key:'title',        label:'Title',         default:true },
    { key:'journal',      label:'Journal',       default:true },
    { key:'authors',      label:'Authors',       default:true },
    { key:'citations',    label:'Citations',     default:true },
    { key:'quartile',     label:'Quartile',      default:true },
    { key:'retraction_info', label:'Retraction Info', default:true },
    // extras
    { key:'is_retracted', label:'Retracted (OpenAlex)', default:false },
    { key:'type',         label:'Type',          default:false },
    { key:'doi',          label:'DOI',           default:false },
    { key:'url',          label:'URL',           default:false },
    { key:'issns',        label:'ISSNs',         default:false },
    { key:'subjects',     label:'Subject areas', default:false },
    { key:'sdg_tags',     label:'SDGs',          default:false },
  ];
  let selectedColumns = loadSelectedColumns();

  // Charts
  let chartByYear=null, chartTopJournals=null, chartSDG=null;

  // ----------------- SDG KEYWORDS (heuristic) -----------------
  const SDG_LIST = [
    { id:1,  name:'No Poverty',                   kw:['poverty','low-income','income inequality'] },
    { id:2,  name:'Zero Hunger',                  kw:['hunger','food security','malnutrition','agriculture','crop','farm'] },
    { id:3,  name:'Good Health & Well-being',     kw:['health','disease','medicine','mental','epidemic','pandemic','hospital','clinical'] },
    { id:4,  name:'Quality Education',            kw:['education','school','teaching','learning','curriculum','literacy','students'] },
    { id:5,  name:'Gender Equality',              kw:['gender','women','female','girls','violence against women','equality'] },
    { id:6,  name:'Clean Water & Sanitation',     kw:['water','sanitation','wastewater','drinking water','hygiene'] },
    { id:7,  name:'Affordable & Clean Energy',    kw:['energy','renewable','solar','wind','battery','hydrogen'] },
    { id:8,  name:'Decent Work & Economic Growth',kw:['employment','workforce','productivity','economy','economic growth','entrepreneur'] },
    { id:9,  name:'Industry, Innovation & Infrastructure', kw:['industry','manufacturing','infrastructure','innovation','iot','robotics','blockchain'] },
    { id:10, name:'Reduced Inequalities',         kw:['inequality','social justice','marginalized','inclusion'] },
    { id:11, name:'Sustainable Cities & Communities', kw:['urban','smart city','transport','housing','resilience','disaster'] },
    { id:12, name:'Responsible Consumption & Production', kw:['circular economy','sustainability','recycling','waste','lifecycle','supply chain'] },
    { id:13, name:'Climate Action',               kw:['climate','carbon','ghg','emission','adaptation','mitigation','global warming'] },
    { id:14, name:'Life Below Water',             kw:['marine','ocean','sea','fisheries','aquatic','coral'] },
    { id:15, name:'Life on Land',                 kw:['biodiversity','forest','wildlife','ecosystem','soil','land use'] },
    { id:16, name:'Peace, Justice & Strong Institutions', kw:['governance','policy','corruption','crime','justice','conflict'] },
    { id:17, name:'Partnerships for the Goals',   kw:['partnership','collaboration','sdg','stakeholder','international'] },
  ];
  const SDG_COLORS = {1:'#E5243B',2:'#DDA63A',3:'#4C9F38',4:'#C5192D',5:'#FF3A21',6:'#26BDE2',7:'#FCC30B',8:'#A21942',9:'#FD6925',10:'#DD1367',11:'#FD9D24',12:'#BF8B2E',13:'#3F7E44',14:'#0A97D9',15:'#56C02B',16:'#00689D',17:'#19486A'};

  // ----------------- Retraction detection (heuristic for notices) -----------------
  const RETRACT_PREFIXES = [
    /^retraction\s*note\s*:/i,
    /^retraction\s*of\s*:/i,
    /^retraction\s*:/i,
    /^notice\s+of\s+retraction\s*:/i,
    /^withdrawn\s*:/i,
  ];
  const DOI_REGEX = /\b10\.\d{4,9}\/\S+\b/i;

  // ----------------- TABS -----------------
  function switchTab(name){
    const tabs=['overview','publications','quartiles','sdg'];
    for (const t of tabs){
      document.getElementById(`view-${t}`).classList.toggle('hidden', t!==name);
      const el = document.getElementById(`tab${t[0].toUpperCase()+t.slice(1)}`);
      el.classList.toggle('tab-active', t===name);
      el.classList.toggle('tab-inactive', t!==name);
    }
    if (name==='quartiles') updateCoverage();
    if (name==='sdg') renderSDGChart();
  }

  // ----------------- LOAD DATA -----------------
  async function autoLoad(){
    try{
      const res = await fetch('institution_data.json', { cache:'no-store' });
      if (!res.ok) throw new Error('institution_data.json not found');
      const j = await res.json();

      document.getElementById('lastSynced').textContent =
        j.updated ? `Last synced: ${dayjs(j.updated).format('DD MMM YYYY, HH:mm')}` : '';

      all = Array.isArray(j.items) ? j.items : [];

      // Heuristics: mark retraction_notice + pair
      buildRetractionIndex(all);

      // SDGs
      for (const p of all) p.sdg_tags = guessSDGs(p);

      document.getElementById('kpiTotal').textContent = num(all.length);

      // Year filter
      const years = [...new Set(all.map(x=>x.year).filter(Boolean))].sort((a,b)=>b-a);
      document.getElementById('yearFilter').innerHTML =
        '<option value="">All years</option>' + years.map(y=>`<option>${y}</option>`).join('');

      // SDG filter options
      const opts = SDG_LIST.map(s=>`<option value="${s.id}">${s.id}. ${s.name}</option>`).join('');
      document.getElementById('sdgFilter').innerHTML = '<option value="">All SDGs</option>' + opts;
      document.getElementById('sdgOnlyFilter').innerHTML = '<option value="">All SDGs</option>' + opts;

      // Page size
      pageSize = parseInt(document.getElementById('pageSize').value,10) || 50;

      // Build columns UI and render
      buildColumnsPanel();
      buildSDGLegend();
      applyFilters(1);
    }catch(e){
      document.getElementById('lastSynced').textContent = 'Error: '+e.message;
      console.error(e);
    }
  }

  // Build an index for retraction matching
  function buildRetractionIndex(items){
    // normalize title -> object
    const mapByTitle = new Map();
    const mapByDOI   = new Map();
    for (const p of items){
      if (p.doi) mapByDOI.set(p.doi.toLowerCase(), p);
      const nt = normTitle(p.title||'');
      if (nt) mapByTitle.set(nt, p);
    }

    for (const p of items){
      const title = p.title || '';
      const nt = normTitle(title);
      p.retraction_notice = isRetractionNotice(title);
      p.retracted_by = null;     // (for originals) -> DOI/title of its retraction notice
      p.retraction_of = null;    // (for notices)   -> DOI/title of original

      if (p.retraction_notice){
        // try to extract DOI of the original article from the notice title
        const m = title.match(DOI_REGEX);
        if (m){
          const target = mapByDOI.get(m[0].toLowerCase());
          if (target){
            p.retraction_of = { doi: target.doi, title: target.title };
            target.retracted_by = { doi: p.doi, title: p.title };
          }
        } else {
          // fallback: remove prefix and match by normalized title
          const stripped = stripRetractionPrefix(title);
          const candidate = mapByTitle.get(normTitle(stripped));
          if (candidate){
            p.retraction_of = { doi: candidate.doi, title: candidate.title };
            candidate.retracted_by = { doi: p.doi, title: p.title };
          }
        }
      }
    }
  }

  function isRetractionNotice(title){
    const t = String(title||'');
    return RETRACT_PREFIXES.some(rx => rx.test(t));
  }
  function stripRetractionPrefix(title){
    let t = String(title||'');
    for (const rx of RETRACT_PREFIXES){
      if (rx.test(t)) return t.replace(rx, '').trim();
    }
    return t;
  }

  // ----------------- FILTERS / SEARCH / PAGING -----------------
  function applyFilters(goToPage=1){
    const q = (document.getElementById('searchBox')?.value || '').toLowerCase().trim();
    const year = document.getElementById('yearFilter')?.value || '';
    const sdg = document.getElementById('sdgFilter')?.value || document.getElementById('sdgOnlyFilter')?.value || '';
    const retractMode = document.getElementById('retractionFilter')?.value || '';

    filtered = all.filter(p=>{
      if (year && String(p.year)!==year) return false;
      if (sdg && !(p.sdg_tags||[]).includes(Number(sdg))) return false;

      // retraction modes
      if (retractMode === 'exclude'){
        if (p.is_retracted || p.retraction_notice) return false;
      } else if (retractMode === 'only_retracted'){
        if (!p.is_retracted) return false;
      } else if (retractMode === 'only_notices'){
        if (!p.retraction_notice) return false;
      }

      if (q){
        const hay = [
          p.title||'',
          p.journal||'',
          p.doi||'',
          ...(p.authors||[])
        ].join(' ').toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });

    if (haveSJR){ for (const p of filtered) p.quartile = resolveQuartile(p); }

    // KPIs
    document.getElementById('kpiView').textContent = num(filtered.length);
    document.getElementById('kpiRetr').textContent = num(filtered.filter(x=>x.is_retracted || x.retraction_notice).length);
    const journals = new Set(filtered.map(x=>(x.journal||'').trim()).filter(Boolean));
    document.getElementById('kpiJournals').textContent = num(journals.size);

    if (goToPage===1) currentPage = 1;
    renderTable();
    renderOverviewCharts();
    renderSDGChart();
    updateCoverage();
  }

  function changePageSize(){ pageSize = parseInt(document.getElementById('pageSize').value,10) || 50; currentPage = 1; renderTable(); }
  function totalPages(){ return Math.max(1, Math.ceil(filtered.length / pageSize)); }
  function goFirst(){ currentPage = 1; renderTable(); }
  function goPrev(){ if (currentPage>1) currentPage--; renderTable(); }
  function goNext(){ if (currentPage<totalPages()) currentPage++; renderTable(); }
  function goLast(){ currentPage = totalPages(); renderTable(); }

  // ----------------- TABLE (dynamic columns) -----------------
  function renderTable(){
    // HEAD
    const head = document.getElementById('pubHeadRow');
    head.innerHTML = '';
    for (const col of selectedColumns) {
      const th = document.createElement('th');
      th.className = 'text-left px-4 py-2';
      th.textContent = col.label;
      head.appendChild(th);
    }

    // BODY
    const start = (currentPage-1)*pageSize;
    const end   = Math.min(start+pageSize, filtered.length);
    const rows  = filtered.slice(start,end);

    const body = document.getElementById('pubBody');
    body.innerHTML = '';
    for (const p of rows){
      const tds = selectedColumns.map(col => `<td class="px-4 py-2">${renderCell(col.key, p)}</td>`).join('');
      const tr = document.createElement('tr');
      tr.className = 'border-b border-slate-100 hover:bg-slate-50';
      tr.innerHTML = tds;
      body.appendChild(tr);
    }

    // Info
    const info = `Page ${currentPage} / ${totalPages()}`;
    document.getElementById('pageInfo').textContent = info;

    const rangeText = filtered.length
      ? `Showing ${num(start+1)}–${num(end)} of ${num(filtered.length)} (filtered)`
      : `Showing 0 of 0`;
    document.getElementById('countInfo').textContent = rangeText;
    document.getElementById('rangeText').textContent = rangeText;
  }

  function renderCell(key, p){
    switch(key){
      case 'year': return p.year ?? '';
      case 'title':
        return p.url ? `<a class="text-indigo-600 hover:underline" href="${p.url}" target="_blank">${esc(p.title||'')}</a>` : esc(p.title||'');
      case 'journal': return esc(p.journal||'');
      case 'authors': return esc((p.authors||[]).join(', '));
      case 'citations': return p.citations ?? 0;
      case 'quartile': return esc(p.quartile || '');
      case 'retraction_info': return renderRetractionInfo(p);
      case 'is_retracted':
        return p.is_retracted
          ? '<span class="px-2 py-0.5 rounded-md bg-rose-50 text-rose-700 border border-rose-200 text-xs">Yes</span>'
          : 'No';
      case 'type': return esc(p.type || '');
      case 'doi': return esc(p.doi || '');
      case 'url': return p.url ? `<a class="text-indigo-600" href="${p.url}" target="_blank">Open</a>` : '';
      case 'issns': return esc((p.issns||[]).join(', '));
      case 'subjects': return esc(extractSubjects(p));
      case 'sdg_tags': return renderSDGBadges(p.sdg_tags||[]);
      default: return '';
    }
  }

  function renderRetractionInfo(p){
    const parts = [];
    if (p.retraction_notice){
      parts.push('<span class="badge" style="border-color:#ef4444;background:#fff;color:#b91c1c">Retraction notice</span>');
      if (p.retraction_of){
        const t = esc(p.retraction_of.title || '');
        const d = p.retraction_of.doi ? `<a href="https://doi.org/${p.retraction_of.doi}" target="_blank">${esc(p.retraction_of.doi)}</a>` : '';
        parts.push(`<div class="text-xs text-slate-600 mt-1">of: ${t} ${d}</div>`);
      }
    }
    if (p.is_retracted){
      parts.push('<span class="badge" style="border-color:#ef4444;background:#fff;color:#b91c1c">Retracted (OpenAlex)</span>');
      if (p.retracted_by){
        const t = esc(p.retracted_by.title || '');
        const d = p.retracted_by.doi ? `<a href="https://doi.org/${p.retracted_by.doi}" target="_blank">${esc(p.retracted_by.doi)}</a>` : '';
        parts.push(`<div class="text-xs text-slate-600 mt-1">by: ${t} ${d}</div>`);
      }
    }
    return parts.join(' ') || '';
  }

  // ----------------- COLUMNS UI -----------------
  function buildColumnsPanel(){
    const container = document.getElementById('columnsList');
    container.innerHTML = '';
    const selectedKeys = new Set(selectedColumns.map(c=>c.key));
    for (const col of ALL_COLUMNS){
      const id = `col_${col.key}`;
      const checked = selectedKeys.has(col.key) ? 'checked' : '';
      container.insertAdjacentHTML('beforeend', `
        <label class="flex items-center gap-2">
          <input type="checkbox" id="${id}" ${checked}/>
          <span>${col.label}</span>
        </label>
      `);
    }
  }
  function toggleColumnsPanel(){ document.getElementById('columnsPanel').classList.toggle('hidden'); }
  function applyColumnSelection(){
    const chosen=[];
    for (const col of ALL_COLUMNS){
      const box=document.getElementById(`col_${col.key}`);
      if (box && box.checked) chosen.push({key:col.key,label:col.label});
    }
    selectedColumns = chosen.length ? chosen : ALL_COLUMNS.filter(c=>c.default).map(c=>({key:c.key,label:c.label}));
    saveSelectedColumns(); toggleColumnsPanel(); renderTable();
  }
  function resetColumns(){
    selectedColumns = ALL_COLUMNS.filter(c=>c.default).map(c=>({key:c.key,label:c.label}));
    saveSelectedColumns(); buildColumnsPanel(); renderTable();
  }
  function saveSelectedColumns(){ try{ localStorage.setItem('pub_columns', JSON.stringify(selectedColumns)); }catch{} }
  function loadSelectedColumns(){
    try{
      const s=localStorage.getItem('pub_columns');
      if (s){
        const arr=JSON.parse(s);
        const valid=new Map(ALL_COLUMNS.map(c=>[c.key,c.label]));
        return arr.filter(x=>valid.has(x.key)).map(x=>({key:x.key,label:valid.get(x.key)}));
      }
    }catch{}
    return ALL_COLUMNS.filter(c=>c.default).map(c=>({key:c.key,label:c.label}));
  }

  // ----------------- CHARTS -----------------
  function renderOverviewCharts(){
    const byYear={}; for (const p of filtered){ if (p.year) byYear[p.year]=(byYear[p.year]||0)+1; }
    const labelsY = Object.keys(byYear).sort((a,b)=>a-b);
    const dataY   = labelsY.map(y=>byYear[y]);
    if (chartByYear) chartByYear.destroy();
    chartByYear = new Chart(document.getElementById('chartByYear'), {
      type:'bar', data:{ labels:labelsY, datasets:[{ label:'Publications', data:dataY }] },
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
    });

    const counts={}; for (const p of filtered){ const j=(p.journal||'').trim(); if (j) counts[j]=(counts[j]||0)+1; }
    const top = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const labelsJ = top.map(x=>x[0]), dataJ = top.map(x=>x[1]);
    if (chartTopJournals) chartTopJournals.destroy();
    chartTopJournals = new Chart(document.getElementById('chartTopJournals'), {
      type:'bar', data:{ labels:labelsJ, datasets:[{ label:'Count', data:dataJ }] },
      options:{ responsive:true, maintainAspectRatio:false, indexAxis:'y', scales:{ x:{ beginAtZero:true } } }
    });
  }

  // ----------------- SDG MAPPING -----------------
  function guessSDGs(p){
    const text = [
      (p.title||''),
      (p.journal||''),
      extractSubjects(p)
    ].join(' ').toLowerCase();
    const hits=[];
    for (const s of SDG_LIST){
      for (const kw of s.kw){
        if (text.includes(kw.toLowerCase())){ hits.push(s.id); break; }
      }
    }
    return Array.from(new Set(hits)).slice(0,2);
  }
  function renderSDGBadges(ids){
    if (!ids.length) return '';
    return ids.map(id=>`<span class="badge" style="border-color:${SDG_COLORS[id]};background-color:#fff">${id}</span>`).join(' ');
  }
  function buildSDGLegend(){
    const box=document.getElementById('sdgLegend'); box.innerHTML='';
    for (const s of SDG_LIST){
      box.insertAdjacentHTML('beforeend', `
        <span class="badge" title="${s.name}" style="border-color:${SDG_COLORS[s.id]};background-color:#fff">
          ${s.id} — ${s.name}
        </span>
      `);
    }
  }
  function renderSDGChart(){
    const counts = new Array(18).fill(0);
    for (const p of filtered){ for (const id of (p.sdg_tags||[])) counts[id]++; }
    const labels = SDG_LIST.map(s=>`${s.id}`), data = SDG_LIST.map(s=>counts[s.id]||0);
    if (chartSDG) chartSDG.destroy();
    chartSDG = new Chart(document.getElementById('chartSDG'), {
      type:'bar', data:{ labels, datasets:[{ label:'Count', data }] },
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
    });
  }

  // ----------------- QUARTILES (upload & mapping) -----------------
  document.getElementById('sjrFile').addEventListener('change', async (e)=>{
    const file=e.target.files[0]; if(!file) return;
    const name=file.name.toLowerCase(); const text=await file.text();
    sjrByIssn.clear(); sjrByTitle.clear(); haveSJR=false;

    try{
      if (name.endsWith('.json')) { const arr=JSON.parse(text); for (const row of arr) addQuartileRow(row); }
      else if (name.endsWith('.csv')){ parseCSV(text, addQuartileRow); }
      else { throw new Error('Unsupported file type'); }
      haveSJR = (sjrByIssn.size + sjrByTitle.size) > 0;
      document.getElementById('sjrStatus').textContent =
        `Loaded ${sjrByIssn.size} ISSN entries and ${sjrByTitle.size} title entries`;
      applyFilters();
      updateCoverage();
    }catch(err){
      document.getElementById('sjrStatus').textContent = 'Failed: ' + err.message;
    }
  });

  function addQuartileRow(row){
    const q = normQuartile(row.quartile || row.Quarter || row.Q || row.q || '');
    const title = normTitle(row.title || row.Title || row.Journal || '');
    const issn  = normIssn (row.issn  || row.ISSN  || row.issn_print || row.ISSN_print || '');
    if (issn && q)  sjrByIssn.set(issn, q);
    if (title && q) sjrByTitle.set(title, q);
  }
  function parseCSV(text, onRow){
    const lines = text.split(/\r?\n/).filter(Boolean);
    const header = lines.shift().split(',').map(h=>h.trim().toLowerCase());
    const idxTitle = header.findIndex(h=>/title|journal/.test(h));
    const idxIssn  = header.findIndex(h=>/issn/.test(h));
    const idxQuart = header.findIndex(h=>/quartile|q$/.test(h));
    if (idxQuart<0 || (idxTitle<0 && idxIssn<0)) throw new Error('CSV must include Title/ISSN and Quartile columns');
    for (const line of lines){
      const cols = splitCsv(line);
      onRow({ title: idxTitle>=0?cols[idxTitle]:'', issn: idxIssn>=0?cols[idxIssn]:'', quartile: idxQuart>=0?cols[idxQuart]:'' });
    }
  }
  function splitCsv(line){
    const out=[]; let cur=''; let inQ=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (ch==='\"'){ inQ=!inQ; continue; }
      if (ch===',' && !inQ){ out.push(cur.trim()); cur=''; continue; }
      cur+=ch;
    }
    out.push(cur.trim()); return out;
  }
  function resolveQuartile(p){
    const issns=(p.issns||[]).map(normIssn).filter(Boolean);
    for (const id of issns){ if (sjrByIssn.has(id)) return sjrByIssn.get(id); }
    const t=normTitle(p.journal||''); if (t && sjrByTitle.has(t)) return sjrByTitle.get(t);
    return '';
  }
  function updateCoverage(){
    let mapped=0, total=filtered.length; for (const p of filtered) if (p.quartile) mapped++;
    const pct = total? Math.round(mapped*100/total):0;
    const el=document.getElementById('mapCoverage'); if (el) el.textContent = `${mapped} / ${total} in current view mapped (${pct}%)`;
  }

  // ----------------- EXPORT -----------------
  function exportCSV(){
    if (!filtered.length) return;
    const start=(currentPage-1)*pageSize, end=Math.min(start+pageSize, filtered.length);
    const rows = filtered.slice(start,end);
    const header = selectedColumns.map(c=>c.label);
    const csv = [header.join(',')].concat(
      rows.map(r => selectedColumns.map(c => q(textForExport(c.key, r))).join(','))
    ).join('\n');
    downloadBlob('publications_view.csv', csv, 'text/csv');
  }
  function exportJSON(){
    const start=(currentPage-1)*pageSize, end=Math.min(start+pageSize, filtered.length);
    const rows = filtered.slice(start,end).map(r=>{
      const obj={}; for (const c of selectedColumns){ obj[c.key] = rawForExport(c.key, r); }
      return obj;
    });
    downloadBlob('publications_view.json', JSON.stringify(rows,null,2), 'application/json');
  }
  function textForExport(key, p){
    switch(key){
      case 'authors': return (p.authors||[]).join('; ');
      case 'issns':   return (p.issns||[]).join('; ');
      case 'subjects':return extractSubjects(p);
      case 'sdg_tags':return (p.sdg_tags||[]).join('; ');
      case 'retraction_info': return stripHtml(renderRetractionInfo(p));
      case 'is_retracted': return p.is_retracted ? 'Yes' : 'No';
      default: return rawForExport(key, p) ?? '';
    }
  }
  function rawForExport(key, p){
    if (key==='subjects') return extractSubjects(p);
    if (key==='retraction_info') return stripHtml(renderRetractionInfo(p));
    return p[key];
  }

  // ----------------- UTILS -----------------
  function esc(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function q(s){ return `"${String(s).replace(/"/g,'""')}"`; }
  function downloadBlob(name, content, type){
    const blob = new Blob([content],{type}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
  }
  function num(n){ return (n||0).toLocaleString(); }
  function normTitle(t){ return String(t||'').toLowerCase().replace(/\s+/g,' ').trim(); }
  function normIssn(s){ const x=String(s||'').replace(/[^0-9xX]/g,'').toUpperCase(); return x.length===8? x.slice(0,4)+'-'+x.slice(4): (x.length===7? x.slice(0,3)+'-'+x.slice(3): ''); }
  function normQuartile(q){ const s=String(q||'').toUpperCase().trim(); return /^Q[1-4]$/.test(s)? s : ''; }
  function extractSubjects(p){
    if (Array.isArray(p.subjects) && p.subjects.length) return p.subjects.slice(0,3).join(', ');
    if (Array.isArray(p.concepts) && p.concepts.length){
      const arr = p.concepts.map(c=>c.display_name||c.name||'').filter(Boolean).slice(0,3);
      return arr.join(', ');
    }
    return '';
  }
  function stripHtml(html){ const d=document.createElement('div'); d.innerHTML=html; return d.textContent||d.innerText||''; }

  // Close dropdown on outside click
  document.addEventListener('click', (e)=>{
    const panel=document.getElementById('columnsPanel'); const btn=document.getElementById('colBtn');
    if (!panel || panel.classList.contains('hidden')) return;
    if (!panel.contains(e.target) && !btn.contains(e.target)) panel.classList.add('hidden');
  });

  // Init
  document.addEventListener('DOMContentLoaded', ()=>{
    buildSDGLegend();
    autoLoad();
  });
</script>
</body>
</html>
