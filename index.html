<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI Publications Portal</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- Day.js + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-7xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">AI Publications Portal</h1>
    <p id="lastSynced" class="text-sm text-gray-500 mb-6">Loading data…</p>

    <!-- Tabs -->
    <div class="flex space-x-4 border-b mb-6">
      <button class="tabBtn font-semibold py-2 px-4 border-b-2 border-purple-500" data-tab="overview">Overview</button>
      <button class="tabBtn font-semibold py-2 px-4" data-tab="publications">Publications</button>
      <button class="tabBtn font-semibold py-2 px-4" data-tab="quartiles">Quartiles</button>
      <button class="tabBtn font-semibold py-2 px-4" data-tab="sdgs">SDGs</button>
    </div>

    <!-- Overview -->
    <div id="tab-overview" class="tab">
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="p-4 bg-white rounded shadow text-center">
          <div class="text-xl font-bold" id="kpi-total">-</div>
          <div class="text-sm text-gray-500">Total items</div>
        </div>
        <div class="p-4 bg-white rounded shadow text-center">
          <div class="text-xl font-bold" id="kpi-distinct">-</div>
          <div class="text-sm text-gray-500">Distinct journals</div>
        </div>
        <div class="p-4 bg-white rounded shadow text-center">
          <div class="text-xl font-bold" id="kpi-retracted">-</div>
          <div class="text-sm text-gray-500">Retracted</div>
        </div>
      </div>

      <div class="bg-white rounded shadow p-4 mb-6">
        <h2 class="text-lg font-semibold mb-2">Publishers — Distinct Journals (view)</h2>
        <canvas id="chartPublishers" height="200"></canvas>
        <p class="text-xs text-gray-500 mt-2">Counts unique journal titles per publishing house.</p>
      </div>
    </div>

    <!-- Publications -->
    <div id="tab-publications" class="tab hidden">
      <h2 class="text-lg font-semibold mb-4">All Publications</h2>
      <table class="min-w-full bg-white border border-gray-200 rounded shadow text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2 border">Year</th>
            <th class="px-3 py-2 border">Title</th>
            <th class="px-3 py-2 border">Journal</th>
            <th class="px-3 py-2 border">Publisher</th>
            <th class="px-3 py-2 border">Home authors</th>
            <th class="px-3 py-2 border">Citations</th>
            <th class="px-3 py-2 border">Quartile</th>
          </tr>
        </thead>
        <tbody id="pubTable"></tbody>
      </table>
    </div>

    <!-- Quartiles -->
    <div id="tab-quartiles" class="tab hidden">
      <p class="text-gray-600">Quartile analysis view (placeholder)</p>
    </div>

    <!-- SDGs -->
    <div id="tab-sdgs" class="tab hidden">
      <p class="text-gray-600">SDGs mapping view (placeholder)</p>
    </div>
  </div>

<script>
let all = [];
let chartPublishers;

async function loadJson() {
  const url = new URL('institution_data.json', window.location.href).href;
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error(`HTTP ${res.status} while fetching ${url}`);
  return res.json();
}

async function autoLoad() {
  try {
    const j = await loadJson();
    all = Array.isArray(j.items) ? j.items : [];
    document.getElementById('lastSynced').textContent =
      j.updated ? `Last synced: ${dayjs(j.updated).format('DD MMM YYYY, HH:mm')}` : 'Loaded data';
    renderKPIs();
    renderPublishersChart();
    renderPublicationsTable();
  } catch (e) {
    console.error(e);
    document.getElementById('lastSynced').textContent =
      "❌ Could not load institution_data.json. Please ensure it's deployed next to index.html";
  }
}

function renderKPIs() {
  document.getElementById('kpi-total').textContent = all.length;
  const distinctJournals = new Set(all.map(x => x.journal||'')).size;
  document.getElementById('kpi-distinct').textContent = distinctJournals;
  const retracted = all.filter(x => x.is_retracted).length;
  document.getElementById('kpi-retracted').textContent = retracted;
}

function renderPublishersChart() {
  const byPub = {};
  all.forEach(x => {
    const pub = (x.publisher||'Other/Unknown').trim();
    if (!byPub[pub]) byPub[pub] = new Set();
    if (x.journal) byPub[pub].add(x.journal);
  });
  const labels = Object.keys(byPub);
  const data = labels.map(k => byPub[k].size);
  if (chartPublishers) chartPublishers.destroy();
  chartPublishers = new Chart(document.getElementById('chartPublishers'), {
    type: 'bar',
    data: { labels, datasets: [{ data, backgroundColor: 'rgba(139,92,246,0.7)' }] },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { x: { ticks: { precision:0 } } }
    }
  });
}

function renderPublicationsTable() {
  const body = document.getElementById('pubTable');
  body.innerHTML = "";
  all.slice(0,50).forEach(x => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border px-3 py-2">${x.year||''}</td>
      <td class="border px-3 py-2 text-blue-600 hover:underline"><a href="${x.url||'#'}" target="_blank">${x.title||''}</a></td>
      <td class="border px-3 py-2">${x.journal||''}</td>
      <td class="border px-3 py-2">${x.publisher||'Other/Unknown'}</td>
      <td class="border px-3 py-2">${(x.authorships||[]).map(a=>a.author?.display_name).filter(Boolean).join(", ")}</td>
      <td class="border px-3 py-2">${x.citations||0}</td>
      <td class="border px-3 py-2">${x.quartile||''}</td>
    `;
    body.appendChild(tr);
  });
}

// Tab switching
document.querySelectorAll('.tabBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabBtn').forEach(b=>b.classList.remove('border-purple-500'));
    btn.classList.add('border-purple-500');
    const tab = btn.dataset.tab;
    document.querySelectorAll('.tab').forEach(t=>t.classList.add('hidden'));
    document.getElementById('tab-'+tab).classList.remove('hidden');
  });
});

autoLoad();
</script>
</body>
</html>
