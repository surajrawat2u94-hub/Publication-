<!DOCTYPE html>
<html lang="en">
<head>
  <meta
charset="UTF-8"/>
  <meta
name="viewport" content="width=device-width,
initial-scale=1"/>
  <title>AI
Publications Portal</title>
 
    <script
src="https://cdn.tailwindcss.com"></script>
    <script
src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script
src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script
src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script
src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1"></script>
 
  <style>
    .card{
background:rgba(255,255,255,.92); border:1px solid rgba(226,232,240,.92);
          border-radius:16px; box-shadow:0 12px 24px rgba(15,23,42,.08) }
   .thin-scrollbar::-webkit-scrollbar{height:8px;width:8px}
   .thin-scrollbar::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:6px}
   .thin-scrollbar::-webkit-scrollbar-track{background:#F8FAFC}
   .tab-active{color:#111827;border-color:#7c3aed;background:linear-gradient(180deg,#fff,#f8fafc)}
   .tab-inactive{color:#6B7280;border-color:transparent}
   .dropdown{position:relative}
   .dropdown-panel{position:absolute;right:0;top:100%;z-index:40}
   .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem
.5rem;border-radius:999px;font-size:.72rem;border:1px solid
#e2e8f0;background:#f8fafc}
    .muted{
color:#64748b }
   .icon-btn{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem
.5rem;
      border:1px solid
#e5e7eb;border-radius:10px;background:#f8fafc}
   .icon-btn:hover{background:#eef2ff;border-color:#c7d2fe}
   .focus-overlay{position:fixed;inset:0;background:rgba(2,6,23,.7);backdrop-filter:blur(2px);z-index:60}
  </style>
</head>
<body class="bg-gradient-to-b from-slate-50
to-slate-100 text-slate-900">
 
    <header
class="sticky top-0 z-30 bg-gradient-to-r from-indigo-600/90
via-fuchsia-600/90 to-sky-600/90 text-white backdrop-blur">
    <div
class="max-w-7xl mx-auto px-4 py-4 flex items-center
justify-between">
      <div
class="flex items-center gap-3">
        <div
class="h-10 w-10 rounded-2xl bg-white/15 grid place-content-center
shadow-inner">
          <i
data-lucide="panel-top" class="text-white"></i>
        </div>
        <div>
          <h1
class="text-lg font-semibold tracking-tight">AI Publications
Portal</h1>
          <div
id="lastSynced" class="text-xs
text-white/80">Loading…</div>
        </div>
      </div>
      <div
class="hidden md:flex items-center gap-2 text-xs">
        <span
class="px-2 py-1 rounded-lg bg-white/10 border
border-white/20">Static JSON · No live API</span>
      </div>
    </div>
 
        <div
class="bg-white">
      <div
class="max-w-7xl mx-auto px-4">
        <nav
class="flex gap-2">
          <button
id="tabOverview"    class="px-4 py-3 text-sm border-b-2 tab-active"   onclick="switchTab('overview')">Overview</button>
          <button
id="tabPublications" class="px-4 py-3 text-sm border-b-2
tab-inactive"
onclick="switchTab('publications')">Publications</button>
          <button
id="tabQuartiles"   class="px-4 py-3 text-sm border-b-2 tab-inactive"
onclick="switchTab('quartiles')">Quartiles</button>
          <button
id="tabSDG"         class="px-4 py-3 text-sm border-b-2 tab-inactive"
onclick="switchTab('sdg')">SDGs</button>
        </nav>
      </div>
    </div>
  </header>
 
    <main
class="max-w-7xl mx-auto px-4 py-6 space-y-6">
 
        <section
id="view-overview" class="space-y-6">
      <div
class="grid grid-cols-2 md:grid-cols-6 gap-4">
        <div
class="card p-4"><div class="text-xs
text-slate-500">Total items</div><div id="kpiTotal"
class="mt-1 text-2xl font-semibold">—</div></div>
        <div
class="card p-4"><div class="text-xs
text-slate-500">Current view</div><div id="kpiView"
class="mt-1 text-2xl font-semibold">—</div></div>
        <div
class="card p-4"><div class="text-xs
text-slate-500">Retracted (view)</div><div
id="kpiRetr" class="mt-1 text-2xl
font-semibold">—</div></div>
        <div
class="card p-4"><div class="text-xs
text-slate-500">Distinct journals (view)</div><div
id="kpiJournals" class="mt-1 text-2xl font-semibold">—</div></div>
        <div
class="card p-4"><div class="text-xs
text-slate-500">IF records loaded</div><div
id="kpiIF" class="mt-1 text-2xl font-semibold">—</div></div>
        <div
class="card p-4"><div class="text-xs
text-slate-500">Quartile-mapped (view)</div><div
id="kpiQMap" class="mt-1 text-2xl font-semibold">—</div></div>
      </div>
 
            <div
class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div
class="card p-4">
          <div
class="flex items-center justify-between">
            <h3
class="font-semibold">Publications by Year (with
cumulative)</h3>
            <div
class="flex items-center gap-2">
              <span
id="rangeText" class="text-xs
text-slate-500"></span>
                          <button id="dataBtn-chartByYear"
class="icon-btn text-xs"
onclick="toggleChartData('chartByYear')"><i
data-lucide="list-tree" class="w-4 h-4"></i><span
class="hidden sm:inline">Data</span></button>
             <button id="chartBtn-chartByYear"
class="icon-btn text-xs"
onclick="toggleChartData('chartByYear')"><i
data-lucide="bar-chart" class="w-4 h-4"></i><span
class="hidden sm:inline">Chart</span></button>
             <button class="icon-btn"
onclick="focusCanvas('chartByYear','Publications by Year (with
cumulative)')">
                <i
data-lucide="maximize-2"></i><span class="hidden
sm:inline">Focus</span>
             </button>
                        </div>
          </div>
          <div id="container-chartByYear" class="mt-2
h-[280px]">
            <canvas id="chartByYear"
class=""></canvas>
                        <div id="dataTable-chartByYear"
class="hidden h-96 overflow-y-auto w-full"></div>
                      </div>
        </div>
 
                <div
class="space-y-4">
          <div
class="card p-4">
            <div
class="flex items-center justify-between">
              <h3
class="font-semibold">Top Journals — Quartiles (view)</h3>
                          <button id="dataBtn-chartTopJournalsQ"
class="icon-btn text-xs"
onclick="toggleChartData('chartTopJournalsQ')"><i
data-lucide="list-tree" class="w-4 h-4"></i><span
class="hidden sm:inline">Data</span></button>
             <button id="chartBtn-chartTopJournalsQ"
class="icon-btn text-xs"
onclick="toggleChartData('chartTopJournalsQ')"><i
data-lucide="bar-chart" class="w-4 h-4"></i><span
class="hidden sm:inline">Chart</span></button>
             <button class="icon-btn"
onclick="focusCanvas('chartTopJournalsQ','Top Journals — Quartiles
(view)')">
                <i
data-lucide="maximize-2"></i><span class="hidden
sm:inline">Focus</span>
             </button>
                        </div>
            <div id="container-chartTopJournalsQ"
class="mt-2 h-[240px]">
              <canvas
id="chartTopJournalsQ"></canvas>
                          <div
id="dataTable-chartTopJournalsQ" class="hidden h-96 overflow-y-auto
w-full"></div>
                         </div>
          </div>
 
          <div
class="card p-4">
            <div
class="flex items-center justify-between">
              <h3
class="font-semibold">Top Journals — Total Citations
(view)</h3>
                          <button id="dataBtn-chartTopJournalsC"
class="icon-btn text-xs"
onclick="toggleChartData('chartTopJournalsC')"><i
data-lucide="list-tree" class="w-4 h-4"></i><span
class="hidden sm:inline">Data</span></button>
             <button id="chartBtn-chartTopJournalsC"
class="icon-btn text-xs"
onclick="toggleChartData('chartTopJournalsC')"><i
data-lucide="bar-chart" class="w-4 h-4"></i><span
class="hidden sm:inline">Chart</span></button>
             <button class="icon-btn"
onclick="focusCanvas('chartTopJournalsC','Top Journals — Publications vs
Citations')">
                <i
data-lucide="maximize-2"></i><span class="hidden
sm:inline">Focus</span>
             </button>
                        </div>
            <div id="container-chartTopJournalsC"
class="mt-2 h-[240px]">
              <canvas
id="chartTopJournalsC"></canvas>
                           <div
id="dataTable-chartTopJournalsC" class="hidden h-96 overflow-y-auto
w-full"></div>
                          </div>
            <div
class="text-xs text-slate-500 mt-2">
             Clustered bars: Publications (left axis) vs Total Citations (right
axis).
           </div>
          </div>
        </div>
      </div>
 
      <div
class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div
class="card p-4">
          <div
class="flex items-center justify-between">
            <h3
class="font-semibold">Journal Impact — Top by IF (from
upload)</h3>
                        <button id="dataBtn-chartIFTop"
class="icon-btn text-xs"
onclick="toggleChartData('chartIFTop')"><i
data-lucide="list-tree" class="w-4 h-4"></i><span
class="hidden sm:inline">Data</span></button>
            <button id="chartBtn-chartIFTop"
class="icon-btn text-xs"
onclick="toggleChartData('chartIFTop')"><i
data-lucide="bar-chart" class="w-4 h-4"></i><span
class="hidden sm:inline">Chart</span></button>
            <button
class="icon-btn" onclick="focusCanvas('chartIFTop','Journal
Impact — Top by IF')">
              <i
data-lucide="maximize-2"></i><span class="hidden
sm:inline">Focus</span>
           </button>
                      </div>
          <div id="container-chartIFTop" class="mt-2
h-[320px]">
            <canvas id="chartIFTop"></canvas>
                        <div id="dataTable-chartIFTop"
class="hidden h-96 overflow-y-auto w-full"></div>
                      </div>
          <div
id="ifTopNote" class="text-xs text-slate-500
mt-2"></div>
        </div>
        <div
class="card p-4">
          <div
class="flex items-center justify-between">
            <h3
class="font-semibold">Journal Impact — IF vs Publications
(heatmap)</h3>
                        <button id="dataBtn-chartIFBubble"
class="icon-btn text-xs"
onclick="toggleChartData('chartIFBubble')"><i
data-lucide="list-tree" class="w-4 h-4"></i><span
class="hidden sm:inline">Data</span></button>
            <button id="chartBtn-chartIFBubble"
class="icon-btn text-xs"
onclick="toggleChartData('chartIFBubble')"><i
data-lucide="bar-chart" class="w-4 h-4"></i><span
class="hidden sm:inline">Chart</span></button>
            <button
class="icon-btn" onclick="focusCanvas('chartIFBubble','Journal
Impact — IF vs Publications')">
              <i
data-lucide="maximize-2"></i><span class="hidden
sm:inline">Focus</span>
           </button>
                      </div>
          <div id="container-chartIFBubble" class="mt-2
h-[320px]">
            <canvas
id="chartIFBubble"></canvas>
                        <div id="dataTable-chartIFBubble"
class="hidden h-96 overflow-y-auto w-full"></div>
                      </div>
          <div
id="ifBubNote" class="text-xs text-slate-500
mt-2"></div>
        </div>
      </div>
 
      <div
class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div
class="card p-4">
          <div
class="flex items-center justify-between">
            <h3
class="font-semibold">Types by Year (view)</h3>
                        <button id="dataBtn-chartTypesYear"
class="icon-btn text-xs"
onclick="toggleChartData('chartTypesYear')"><i
data-lucide="list-tree" class="w-4 h-4"></i><span
class="hidden sm:inline">Data</span></button>
            <button id="chartBtn-chartTypesYear"
class="icon-btn text-xs"
onclick="toggleChartData('chartTypesYear')"><i
data-lucide="bar-chart" class="w-4 h-4"></i><span
class="hidden sm:inline">Chart</span></button>
            <button
class="icon-btn" onclick="focusCanvas('chartTypesYear','Types by
Year (view)')">
              <i
data-lucide="maximize-2"></i><span class="hidden
sm:inline">Focus</span>
           </button>
                      </div>
          <div id="container-chartTypesYear" class="mt-2
h-[300px]">
            <canvas
id="chartTypesYear"></canvas>
                        <div id="dataTable-chartTypesYear"
class="hidden h-96 overflow-y-auto w-full"></div>
                      </div>
        </div>
        <div
class="card p-4">
          <div
class="flex items-center justify-between">
            <h3
class="font-semibold">Top Subjects / Concepts (view)</h3>
                        <button id="dataBtn-chartSubjects"
class="icon-btn text-xs"
onclick="toggleChartData('chartSubjects')"><i
data-lucide="list-tree" class="w-4 h-4"></i><span
class="hidden sm:inline">Data</span></button>
            <button id="chartBtn-chartSubjects"
class="icon-btn text-xs"
onclick="toggleChartData('chartSubjects')"><i
data-lucide="bar-chart" class="w-4 h-4"></i><span
class="hidden sm:inline">Chart</span></button>
            <button
class="icon-btn" onclick="focusCanvas('chartSubjects','Top
Subjects / Concepts (view)')">
              <i
data-lucide="maximize-2"></i><span class="hidden
sm:inline">Focus</span>
           </button>
                      </div>
          <div id="container-chartSubjects" class="mt-2
h-[300px]">
            <canvas
id="chartSubjects"></canvas>
                        <div id="dataTable-chartSubjects"
class="hidden h-96 overflow-y-auto w-full"></div>
                      </div>
        </div>
      </div>
 
      <div
class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div
class="card p-4">
          <div
class="flex items-center justify-between">
            <h3
class="font-semibold">Top Home Authors (institution
authors)</h3>
                        <button id="dataBtn-chartHomeAuthors"
class="icon-btn text-xs"
onclick="toggleChartData('chartHomeAuthors')"><i
data-lucide="list-tree" class="w-4 h-4"></i><span
class="hidden sm:inline">Data</span></button>
            <button id="chartBtn-chartHomeAuthors"
class="icon-btn text-xs"
onclick="toggleChartData('chartHomeAuthors')"><i
data-lucide="bar-chart" class="w-4 h-4"></i><span
class="hidden sm:inline">Chart</span></button>
            <button
class="icon-btn" onclick="focusCanvas('chartHomeAuthors','Top
Home Authors (institution authors)')">
              <i
data-lucide="maximize-2"></i><span class="hidden
sm:inline">Focus</span>
           </button>
                      </div>
          <div id="container-chartHomeAuthors"
class="mt-2 h-[300px]">
            <canvas
id="chartHomeAuthors"></canvas>
                        <div id="dataTable-chartHomeAuthors"
class="hidden h-96 overflow-y-auto w-full"></div>
                      </div>
        </div>
        <div
class="card p-4">
          <div
class="flex items-center justify-between">
            <h3
class="font-semibold">Retractions by Year (OpenAlex flag +
notices)</h3>
                        <button id="dataBtn-chartRetract"
class="icon-btn text-xs"
onclick="toggleChartData('chartRetract')"><i
data-lucide="list-tree" class="w-4 h-4"></i><span
class="hidden sm:inline">Data</span></button>
            <button id="chartBtn-chartRetract"
class="icon-btn text-xs"
onclick="toggleChartData('chartRetract')"><i
data-lucide="bar-chart" class="w-4 h-4"></i><span
class="hidden sm:inline">Chart</span></button>
            <button
class="icon-btn"
onclick="focusCanvas('chartRetract','Retractions by Year')">
              <i
data-lucide="maximize-2"></i><span class="hidden
sm:inline">Focus</span>
           </button>
                      </div>
          <div id="container-chartRetract" class="mt-2
h-[300px]">
            <canvas
id="chartRetract"></canvas>
                        <div id="dataTable-chartRetract"
class="hidden h-96 overflow-y-auto w-full"></div>
                      </div>
        </div>
      </div>
 
            <div
class="grid grid-cols-1 gap-4">
        <div
class="card p-4">
          <div
class="flex items-center justify-between">
            <h3
class="font-semibold">Publishers — Distinct Journals
(view)</h3>
                        <button id="dataBtn-chartPublishers"
class="icon-btn text-xs"
onclick="toggleChartData('chartPublishers')"><i
data-lucide="list-tree" class="w-4 h-4"></i><span
class="hidden sm:inline">Data</span></button>
            <button id="chartBtn-chartPublishers"
class="icon-btn text-xs"
onclick="toggleChartData('chartPublishers')"><i
data-lucide="bar-chart" class="w-4 h-4"></i><span
class="hidden sm:inline">Chart</span></button>
            <button
class="icon-btn"
onclick="focusCanvas('chartPublishers','Publishers — Distinct Journals
(view)')">
              <i
data-lucide="maximize-2"></i><span class="hidden
sm:inline">Focus</span>
           </button>
                      </div>
          <div id="container-chartPublishers"
class="mt-2 h-[300px]">
            <canvas
id="chartPublishers"></canvas>
                        <div id="dataTable-chartPublishers"
class="hidden h-96 overflow-y-auto w-full"></div>
                      </div>
          <div
class="text-xs text-slate-500 mt-2">Counts unique journal titles
per publishing house (heuristic mapping).</div>
        </div>
      </div>
 
            <div
class="card p-4">
        <div
class="flex items-center justify-between">
          <div>
            <h3
class="font-semibold">Sustainable Development Goals
(auto-mapped)</h3>
            <p
class="text-xs text-slate-500">Titles (and subjects, if present)
are heuristically mapped to SDGs.</p>
          </div>
          <div
class="flex items-center gap-2">
            <select
id="sdgOnlyFilter" class="px-3 py-2 rounded-xl border
border-slate-300 text-sm" onchange="applyFilters(1)">
             <option value="">All SDGs</option>
           </select>
                        <button id="dataBtn-chartSDG"
class="icon-btn text-xs"
onclick="toggleChartData('chartSDG')"><i
data-lucide="list-tree" class="w-4 h-4"></i><span
class="hidden sm:inline">Data</span></button>
            <button id="chartBtn-chartSDG"
class="icon-btn text-xs"
onclick="toggleChartData('chartSDG')"><i
data-lucide="bar-chart" class="w-4 h-4"></i><span
class="hidden sm:inline">Chart</span></button>
                        <button
class="icon-btn" onclick="focusCanvas('chartSDG','SDG
Distribution (view)')">
              <i
data-lucide="maximize-2"></i><span class="hidden
sm:inline">Focus</span>
           </button>
          </div>
        </div>
 
      <div
class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div
class="card p-4">
          <h4
class="font-semibold flex items-center justify-between">
           <span>SDG Distribution (view)</span>
                        <div class="flex items-center gap-2">
              <button id="dataBtn-chartSDG"
class="icon-btn text-xs"
onclick="toggleChartData('chartSDG')"><i
data-lucide="list-tree" class="w-4 h-4"></i></button>
              <button id="chartBtn-chartSDG"
class="icon-btn text-xs"
onclick="toggleChartData('chartSDG')"><i
data-lucide="bar-chart" class="w-4 h-4"></i></button>
              <button
class="icon-btn" onclick="focusCanvas('chartSDG','SDG
Distribution (view)')"><i
data-lucide="maximize-2"></i></button>
            </div>
                      </h4>
          <div id="container-chartSDG" class="mt-2
h-[280px]">
            <canvas
id="chartSDG"></canvas>
                        <div id="dataTable-chartSDG"
class="hidden h-96 overflow-y-auto w-full"></div>
                      </div>
        </div>
        <div
class="card p-4">
          <h4
class="font-semibold mb-2">Legend</h4>
          <div
id="sdgLegend" class="flex flex-wrap gap-2
text-sm"></div>
        </div>
      </div>
    </section>
  </main>
 
  <footer
class="text-center text-xs text-slate-500 pb-8">
    Data from
<code>institution_data.json</code> · Quartiles/IF mapped
client-side · SDG & Retraction notices are heuristic
  </footer>
 
    <div
id="focusOverlay" class="focus-overlay hidden">
    <div
class="absolute inset-0 grid place-items-center p-4"
onclick="closeFocus()">
      <div
class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[85vh] p-4
relative overflow-hidden" onclick="event.stopPropagation()">
        <button
class="icon-btn absolute top-3 right-3"
onclick="closeFocus()"><i
data-lucide="x"></i></button>
        <div
class="flex items-center justify-between border-b pb-2 mb-3">
          <div
id="focusTitle" class="font-semibold"></div>
        </div>
        <img
id="focusImg" class="w-full h-[calc(100%-3rem)] object-contain
select-none" alt="Chart preview"/>
      </div>
    </div>
  </div>
 
<script>
 lucide.createIcons();
 
  /* -------- Chart.js
helpers -------- */
 Chart.defaults.font.family = "'Inter', system-ui, -apple-system,
Segoe UI, Roboto, Helvetica, Arial";
 Chart.defaults.plugins.tooltip.backgroundColor = '#0f172a';
 Chart.defaults.plugins.tooltip.borderColor = '#334155';
 Chart.defaults.plugins.tooltip.borderWidth = 1;
 Chart.defaults.plugins.tooltip.padding = 12;
 Chart.defaults.plugins.legend.labels.boxWidth = 10;
 
  const shadowPlugin =
{
    id:
'shadowPlugin',
   beforeDatasetsDraw(chart){ const {ctx}=chart; ctx.save();
ctx.shadowColor='rgba(2,6,23,.12)'; ctx.shadowBlur=14; ctx.shadowOffsetY=6; },
   afterDatasetsDraw(chart){ chart.ctx.restore(); }
  };
 Chart.register(shadowPlugin);
 
  const clr = {
    indigo:'#6366f1',
purple:'#a855f7', teal:'#14b8a6', cyan:'#06b6d4',
    q1:'#16a34a',
q2:'#3b82f6', q3:'#f59e0b', q4:'#ef4444', gray:'#334155'
  };
  const gradV =
(ctx,a,b)=>{ const g=ctx.createLinearGradient(0,0,0,ctx.canvas.height);
g.addColorStop(0,a); g.addColorStop(1,b); return g; };
  const gradH =
(ctx,a,b)=>{ const g=ctx.createLinearGradient(0,0,ctx.canvas.width,0);
g.addColorStop(0,a); g.addColorStop(1,b); return g; };
 
  /*
--------------------- STATE --------------------- */
  let all=[],
filtered=[], currentPage=1, pageSize=50;
 
  const HOME_ROR =
"04q2jes40";
  const HOME_KEYWORDS
= ['university of petroleum','energy studies','upes'];
 
  const selectedTypes
= new Set();
  let knownTypes = [];
 
  const sjrByIssn =
new Map(), sjrByTitle = new Map();
  const sjrMetaByIssn
= new Map(), sjrMetaByTitle = new Map();
  let haveSJR=false;
let IFcount=0;
 
  /* ----- COLUMNS
(Publisher added here) ----- */
  const ALL_COLUMNS =
[
    {
key:'year',label:'Year',default:true },
    {
key:'title',label:'Title',default:true },
    {
key:'journal',label:'Journal',default:true },
    {
key:'publisher',label:'Publisher',default:true },              /* ✅ NEW */
    {
key:'home_authors',label:'Home authors',default:true },
    {
key:'authors',label:'Authors',default:false },
    {
key:'citations',label:'Citations',default:true },
    {
key:'quartile',label:'Quartile',default:true },
    {
key:'retraction_info',label:'Retraction Info',default:true },
    {
key:'is_retracted',label:'Retracted (OpenAlex)',default:false },
    {
key:'type',label:'Type',default:false },
    {
key:'doi',label:'DOI',default:false },
    {
key:'url',label:'URL',default:false },
    {
key:'issns',label:'ISSNs',default:false },
    {
key:'subjects',label:'Subject areas',default:false },
    {
key:'sdg_tags',label:'SDGs',default:false },
  ];
  let selectedColumns
= loadSelectedColumns();
 
  let
chartByYear=null, chartTopJournalsQ=null, chartTopJournalsC=null,
      chartIFTop=null,
chartIFBubble=null, chartTypesYear=null,
     chartSubjects=null, chartHomeAuthors=null, chartRetract=null,
      chartSDG=null,
chartPublishers=null;
 
  const SDG_LIST = [
    { id:1,  name:'No Poverty',
kw:['poverty','low-income','income inequality'] },
    { id:2,  name:'Zero Hunger', kw:['hunger','food
security','malnutrition','agriculture','crop','farm'] },
    { id:3,  name:'Good Health & Well-being',
kw:['health','disease','medicine','mental','epidemic','pandemic','hospital','clinical']
},
    { id:4,  name:'Quality Education',
kw:['education','school','teaching','learning','curriculum','literacy','students']
},
    { id:5,  name:'Gender Equality',
kw:['gender','women','female','girls','violence against women','equality'] },
    { id:6,  name:'Clean Water & Sanitation',
kw:['water','sanitation','wastewater','drinking water','hygiene'] },
    { id:7,  name:'Affordable & Clean Energy',
kw:['energy','renewable','solar','wind','battery','hydrogen'] },
    { id:8,  name:'Decent Work & Economic Growth',
kw:['employment','workforce','productivity','economy','growth','entrepreneur']
},
    { id:9,  name:'Industry, Innovation &
Infrastructure',
kw:['industry','manufacturing','infrastructure','innovation','iot','robotics','blockchain']
},
    { id:10,
name:'Reduced Inequalities', kw:['inequality','social
justice','marginalized','inclusion'] },
    { id:11,
name:'Sustainable Cities & Communities', kw:['urban','smart
city','transport','housing','resilience','disaster'] },
    { id:12,
name:'Responsible Consumption & Production', kw:['circular
economy','sustainability','recycling','waste','lifecycle','supply chain'] },
    { id:13,
name:'Climate Action',
kw:['climate','carbon','ghg','emission','adaptation','mitigation','global
warming'] },
    { id:14,
name:'Life Below Water',
kw:['marine','ocean','sea','fisheries','aquatic','coral'] },
    { id:15,
name:'Life on Land',
kw:['biodiversity','forest','wildlife','ecosystem','soil','land use'] },
    { id:16,
name:'Peace, Justice & Strong Institutions',
kw:['governance','policy','corruption','crime','justice','conflict'] },
    { id:17,
name:'Partnerships for the Goals',
kw:['partnership','collaboration','sdg','stakeholder','international'] },
  ];
  const SDG_COLORS =
{1:'#E5243B',2:'#DDA63A',3:'#4C9F38',4:'#C5192D',5:'#FF3A21',6:'#26BDE2',7:'#FCC30B',8:'#A21942',
                     9:'#FD6925',10:'#DD1367',11:'#FD9D24',12:'#BF8B2E',13:'#3F7E44',14:'#0A97D9',15:'#56C02B',16:'#00689D',17:'#19486A'};
 
  const
RETRACT_PREFIXES = [
   /^retraction\s*note\s*:/i,/^retraction\s*of\s*:/i,/^retraction\s*:/i,/^notice\s+of\s+retraction\s*:/i,/^withdrawn\s*:/i,
   /^retracted\s+paper\s*:/i,/^retracted\s+article\s*:/i,/^article\s+retracted\s*:/i
  ];
  const DOI_REGEX =
/\b(10\.\d{4,9}\/\S+)\b/i;
 
  /* ----------------
Tabs ---------------- */
  function
switchTab(name){
    const
tabs=['overview','publications','quartiles','sdg'];
    for (const t of
tabs){
     document.getElementById(`view-${t}`).classList.toggle('hidden',
t!==name);
      const el =
document.getElementById(`tab${t[0].toUpperCase()+t.slice(1)}`);
     el.classList.toggle('tab-active', t===name);
     el.classList.toggle('tab-inactive', t!==name);
    }
    if
(name==='quartiles') updateCoverage();
    if (name==='sdg')
renderSDGChart();
  }
 
  /* ---------------
Load data --------------- */
  async function
autoLoad(){
    try{
      const res =
await fetch('institution_data.json', { cache:'no-store' });
      if (!res.ok)
throw new Error('institution_data.json not found');
      const j = await
res.json();
 
     document.getElementById('lastSynced').textContent =
        j.updated ?
`Last synced: ${dayjs(j.updated).format('DD MMM YYYY, HH:mm')}` : '';
 
      all =
Array.isArray(j.items) ? j.items : [];
 
      // Normalize
authors + home authors
      for (const p of
all){
        if
(!Array.isArray(p.authors)) p.authors = deriveAuthors(p);
        p.home_authors
= deriveHomeAuthors(p);
      }
 
      // Retraction
links + SDGs
     buildRetractionIndex(all);
      for (const p of
all) p.sdg_tags = guessSDGs(p);
 
     document.getElementById('kpiTotal').textContent = num(all.length);
 
      // Year options
      const years =
[...new Set(all.map(x=>x.year).filter(y=>y!=null))].sort((a,b)=>a-b);
      const opts =
(arr) => ['<option
value="">All</option>'].concat(arr.map(y=>`<option
value="${y}">${y}</option>`)).join('');
     document.getElementById('yearFrom').innerHTML = opts(years);
     document.getElementById('yearTo').innerHTML   = opts(years);
 
      // SDG options
     buildSDGOptions();
 
      // Types
     computeKnownTypes();
     buildTypePanel();
 
      pageSize =
parseInt(document.getElementById('pageSize').value,10) || 50;
 
     buildColumnsPanel();
     buildSDGLegend();
      applyFilters(1);
    }catch(e){
     document.getElementById('lastSynced').textContent = 'Error: '+e.message;
     console.error(e);
    }
  }
 
  /* --------- Authors
helpers --------- */
  function
deriveAuthors(p){
    const out=[];
    if
(Array.isArray(p.authorships)){
      for (const a of
p.authorships){
        const nm =
a?.author?.display_name || a?.display_name;
        if (nm)
out.push(String(nm));
      }
    }
    if (!out.length
&& typeof p.authors === 'string' && p.authors.trim()){
      return
p.authors.split(/[,;]\s*/).filter(Boolean);
    }
    return out;
  }
  function
deriveHomeAuthors(p){
    const out=[];
    if
(!Array.isArray(p.authorships)) return out;
    for (const a of
p.authorships){
      const nm =
a?.author?.display_name || a?.display_name;
      const insts =
Array.isArray(a?.institutions) ? a.institutions : [];
      const matchROR =
insts.some(i => (i?.ror||'').split('/').pop() === HOME_ROR);
      const
matchKW  = insts.some(i =>
HOME_KEYWORDS.some(k => (i?.display_name||'').toLowerCase().includes(k)));
      if (nm
&& (matchROR || matchKW)) out.push(String(nm));
    }
    return [...new
Set(out)];
  }
 
  function
buildRetractionIndex(items){
    const byTitle =
new Map(), byDOI = new Map();
    for (const p of
items){
      if (p.doi)
byDOI.set(String(p.doi).toLowerCase(), p);
      const nt =
normTitle(p.title||''); if (nt) byTitle.set(nt, p);
    }
    for (const p of
items){
      const title =
p.title || '';
     p.retraction_notice = isRetractionNotice(title);
      p.retracted_by =
null; p.retraction_of = null;
      if
(p.retraction_notice){
        const m =
title.match(DOI_REGEX);
        if (m){
          const target
= byDOI.get(m[1].toLowerCase());
          if (target){
p.retraction_of = { doi: target.doi, title: target.title }; target.retracted_by
= { doi: p.doi, title: p.title }; }
        } else {
          const
stripped = stripRetractionPrefix(title);
          const
candidate = byTitle.get(normTitle(stripped));
          if
(candidate){ p.retraction_of = { doi: candidate.doi, title: candidate.title };
candidate.retracted_by = { doi: p.doi, title: p.title }; }
        }
      }
    }
  }
  const
isRetractionNotice = title => RETRACT_PREFIXES.some(rx =>
rx.test(String(title||'')));
  const
stripRetractionPrefix = title => { let t=String(title||''); for (const rx of
RETRACT_PREFIXES){ if (rx.test(t)) return t.replace(rx,'').trim(); } return t;
};
 
  /* ---------------
SDG options --------------- */
  function
buildSDGOptions(){
    const opts =
SDG_LIST.map(s=>`<option value="${s.id}">${s.id}.
${s.name}</option>`).join('');
    const sel1 =
document.getElementById('sdgFilter');
    const sel2 =
document.getElementById('sdgOnlyFilter');
    if (sel1)
sel1.innerHTML = '<option value="">All SDGs</option>' +
opts;
    if (sel2)
sel2.innerHTML = '<option value="">All SDGs</option>' +
opts;
  }
 
  /* ---------------
Type multi-select --------------- */
  const normalizeType
= t => {
    const
s=String(t||'').toLowerCase();
    if
(s==='journal-article') return 'article';
    if
(s.includes('proceed')) return 'proceedings-article';
    if
(s.startsWith('book'))  return 'book';
    return s ||
'unknown';
  };
  const labelForType =
key => ({
   'article':'Article','proceedings-article':'Proceedings','book':'Book/Chapter','dataset':'Dataset','report':'Report',
   'preprint':'Preprint','letter':'Letter','review':'Review','editorial':'Editorial','unknown':'Other'
  }[key] ||
key.replace(/(^|\-)(\w)/g,(m,_,c)=>' '+c.toUpperCase()).trim());
 
  function
computeKnownTypes(){
    const counts=new
Map();
    for (const p of
all){ const k=normalizeType(p.type || p.type_crossref);
counts.set
you have a working data tab.

The user wants to add a "Data" tab to each chart. The plan is to modify the HTML to add a button for the new tab and a container for the data table. Then, update the JavaScript to populate these tables and add a function to toggle between the chart and the table view. This is a significant code change. I will provide the full, updated HTML script.

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>AI Publications Portal</title>
    
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <script src="[https://unpkg.com/lucide@latest/dist/umd/lucide.js](https://unpkg.com/lucide@latest/dist/umd/lucide.js)"></script>
    <script src="[https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js](https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js)"></script>
    <script src="[https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js](https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js)"></script>
    <script src="[https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1](https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1)"></script>
    
    <style>
        .card{
            background:rgba(255,255,255,.92);
            border:1px solid rgba(226,232,240,.92);
            border-radius:16px;
            box-shadow:0 12px 24px rgba(15,23,42,.08)
        }
        .thin-scrollbar::-webkit-scrollbar{
            height:8px;
            width:8px
        }
        .thin-scrollbar::-webkit-scrollbar-thumb{
            background:#CBD5E1;
            border-radius:6px
        }
        .thin-scrollbar::-webkit-scrollbar-track{
            background:#F8FAFC
        }
        .tab-active{
            color:#111827;
            border-color:#7c3aed;
            background:linear-gradient(180deg,#fff,#f8fafc)
        }
        .tab-inactive{
            color:#6B7280;
            border-color:transparent
        }
        .dropdown{
            position:relative
        }
        .dropdown-panel{
            position:absolute;
            right:0;
            top:100%;
            z-index:40
        }
        .badge{
            display:inline-flex;
            align-items:center;
            gap:.35rem;
            padding:.2rem .5rem;
            border-radius:999px;
            font-size:.72rem;
            border:1px solid #e2e8f0;
            background:#f8fafc
        }
        .muted{
            color:#64748b
        }
        .icon-btn{
            display:inline-flex;
            align-items:center;
            gap:.35rem;
            padding:.25rem .5rem;
            border:1px solid #e5e7eb;
            border-radius:10px;
            background:#f8fafc
        }
        .icon-btn:hover{
            background:#eef2ff;
            border-color:#c7d2fe
        }
        .focus-overlay{
            position:fixed;
            inset:0;
            background:rgba(2,6,23,.7);
            backdrop-filter:blur(2px);
            z-index:60
        }
    </style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900">
    
    <header class="sticky top-0 z-30 bg-gradient-to-r from-indigo-600/90 via-fuchsia-600/90 to-sky-600/90 text-white backdrop-blur">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-2xl bg-white/15 grid place-content-center shadow-inner">
                    <i data-lucide="panel-top" class="text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-semibold tracking-tight">AI Publications Portal</h1>
                    <div id="lastSynced" class="text-xs text-white/80">Loading…</div>
                </div>
            </div>
            <div class="hidden md:flex items-center gap-2 text-xs">
                <span class="px-2 py-1 rounded-lg bg-white/10 border border-white/20">Static JSON · No live API</span>
            </div>
        </div>
        
        <div class="bg-white">
            <div class="max-w-7xl mx-auto px-4">
                <nav class="flex gap-2">
                    <button id="tabOverview"   class="px-4 py-3 text-sm border-b-2 tab-active"   onclick="switchTab('overview')">Overview</button>
                    <button id="tabPublications" class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('publications')">Publications</button>
                    <button id="tabQuartiles"  class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('quartiles')">Quartiles</button>
                    <button id="tabSDG"        class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('sdg')">SDGs</button>
                </nav>
            </div>
        </div>
    </header>
    
    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        
        <section id="view-overview" class="space-y-6">
            <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
                <div class="card p-4"><div class="text-xs text-slate-500">Total items</div><div id="kpiTotal" class="mt-1 text-2xl font-semibold">—</div></div>
                <div class="card p-4"><div class="text-xs text-slate-500">Current view</div><div id="kpiView" class="mt-1 text-2xl font-semibold">—</div></div>
                <div class="card p-4"><div class="text-xs text-slate-500">Retracted (view)</div><div id="kpiRetr" class="mt-1 text-2xl font-semibold">—</div></div>
                <div class="card p-4"><div class="text-xs text-slate-500">Distinct journals (view)</div><div id="kpiJournals" class="mt-1 text-2xl font-semibold">—</div></div>
                <div class="card p-4"><div class="text-xs text-slate-500">IF records loaded</div><div id="kpiIF" class="mt-1 text-2xl font-semibold">—</div></div>
                <div class="card p-4"><div class="text-xs text-slate-500">Quartile-mapped (view)</div><div id="kpiQMap" class="mt-1 text-2xl font-semibold">—</div></div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold">Publications by Year (with cumulative)</h3>
                        <div class="flex items-center gap-2">
                            <span id="rangeText" class="text-xs text-slate-500"></span>
                            <button id="dataBtn-chartByYear" class="icon-btn text-xs" onclick="toggleChartData('chartByYear')"><i data-lucide="list-tree" class="w-4 h-4"></i><span class="hidden sm:inline">Data</span></button>
                            <button id="chartBtn-chartByYear" class="icon-btn text-xs" onclick="toggleChartData('chartByYear')" style="display: none;"><i data-lucide="bar-chart" class="w-4 h-4"></i><span class="hidden sm:inline">Chart</span></button>
                            <button class="icon-btn" onclick="focusCanvas('chartByYear','Publications by Year (with cumulative)')">
                                <i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span>
                            </button>
                        </div>
                    </div>
                    <div id="container-chartByYear" class="mt-2 h-[280px]">
                        <canvas id="chartByYear" class=""></canvas>
                        <div id="dataTable-chartByYear" class="hidden h-96 overflow-y-auto w-full"></div>
                        </div>
                </div>
                
                <div class="space-y-4">
                    <div class="card p-4">
                        <div class="flex items-center justify-between">
                            <h3 class="font-semibold">Top Journals — Quartiles (view)</h3>
                            <button id="dataBtn-chartTopJournalsQ" class="icon-btn text-xs" onclick="toggleChartData('chartTopJournalsQ')"><i data-lucide="list-tree" class="w-4 h-4"></i><span class="hidden sm:inline">Data</span></button>
                            <button id="chartBtn-chartTopJournalsQ" class="icon-btn text-xs" onclick="toggleChartData('chartTopJournalsQ')" style="display: none;"><i data-lucide="bar-chart" class="w-4 h-4"></i><span class="hidden sm:inline">Chart</span></button>
                            <button class="icon-btn" onclick="focusCanvas('chartTopJournalsQ','Top Journals — Quartiles (view)')">
                                <i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span>
                            </button>
                        </div>
                        <div id="container-chartTopJournalsQ" class="mt-2 h-[240px]">
                            <canvas id="chartTopJournalsQ"></canvas>
                            <div id="dataTable-chartTopJournalsQ" class="hidden h-96 overflow-y-auto w-full"></div>
                            </div>
                    </div>
                    
                    <div class="card p-4">
                        <div class="flex items-center justify-between">
                            <h3 class="font-semibold">Top Journals — Total Citations (view)</h3>
                            <button id="dataBtn-chartTopJournalsC" class="icon-btn text-xs" onclick="toggleChartData('chartTopJournalsC')"><i data-lucide="list-tree" class="w-4 h-4"></i><span class="hidden sm:inline">Data</span></button>
                            <button id="chartBtn-chartTopJournalsC" class="icon-btn text-xs" onclick="toggleChartData('chartTopJournalsC')" style="display: none;"><i data-lucide="bar-chart" class="w-4 h-4"></i><span class="hidden sm:inline">Chart</span></button>
                            <button class="icon-btn" onclick="focusCanvas('chartTopJournalsC','Top Journals — Publications vs Citations')">
                                <i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span>
                            </button>
                        </div>
                        <div id="container-chartTopJournalsC" class="mt-2 h-[240px]">
                            <canvas id="chartTopJournalsC"></canvas>
                            <div id="dataTable-chartTopJournalsC" class="hidden h-96 overflow-y-auto w-full"></div>
                            </div>
                        <div class="text-xs text-slate-500 mt-2">
                            Clustered bars: Publications (left axis) vs Total Citations (right axis).
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold">Journal Impact — Top by IF (from upload)</h3>
                        <button id="dataBtn-chartIFTop" class="icon-btn text-xs" onclick="toggleChartData('chartIFTop')"><i data-lucide="list-tree" class="w-4 h-4"></i><span class="hidden sm:inline">Data</span></button>
                        <button id="chartBtn-chartIFTop" class="icon-btn text-xs" onclick="toggleChartData('chartIFTop')" style="display: none;"><i data-lucide="bar-chart" class="w-4 h-4"></i><span class="hidden sm:inline">Chart</span></button>
                        <button class="icon-btn" onclick="focusCanvas('chartIFTop','Journal Impact — Top by IF')">
                            <i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span>
                        </button>
                    </div>
                    <div id="container-chartIFTop" class="mt-2 h-[320px]">
                        <canvas id="chartIFTop"></canvas>
                        <div id="dataTable-chartIFTop" class="hidden h-96 overflow-y-auto w-full"></div>
                        </div>
                    <div id="ifTopNote" class="text-xs text-slate-500 mt-2"></div>
                </div>
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold">Journal Impact — IF vs Publications (heatmap)</h3>
                        <button id="dataBtn-chartIFBubble" class="icon-btn text-xs" onclick="toggleChartData('chartIFBubble')"><i data-lucide="list-tree" class="w-4 h-4"></i><span class="hidden sm:inline">Data</span></button>
                        <button id="chartBtn-chartIFBubble" class="icon-btn text-xs" onclick="toggleChartData('chartIFBubble')" style="display: none;"><i data-lucide="bar-chart" class="w-4 h-4"></i><span class="hidden sm:inline">Chart</span></button>
                        <button class="icon-btn" onclick="focusCanvas('chartIFBubble','Journal Impact — IF vs Publications')">
                            <i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span>
                        </button>
                    </div>
                    <div id="container-chartIFBubble" class="mt-2 h-[320px]">
                        <canvas id="chartIFBubble"></canvas>
                        <div id="dataTable-chartIFBubble" class="hidden h-96 overflow-y-auto w-full"></div>
                        </div>
                    <div id="ifBubNote" class="text-xs text-slate-500 mt-2"></div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold">Types by Year (view)</h3>
                        <button id="dataBtn-chartTypesYear" class="icon-btn text-xs" onclick="toggleChartData('chartTypesYear')"><i data-lucide="list-tree" class="w-4 h-4"></i><span class="hidden sm:inline">Data</span></button>
                        <button id="chartBtn-chartTypesYear" class="icon-btn text-xs" onclick="toggleChartData('chartTypesYear')" style="display: none;"><i data-lucide="bar-chart" class="w-4 h-4"></i><span class="hidden sm:inline">Chart</span></button>
                        <button class="icon-btn" onclick="focusCanvas('chartTypesYear','Types by Year (view)')">
                            <i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span>
                        </button>
                    </div>
                    <div id="container-chartTypesYear" class="mt-2 h-[300px]">
                        <canvas id="chartTypesYear"></canvas>
                        <div id="dataTable-chartTypesYear" class="hidden h-96 overflow-y-auto w-full"></div>
                        </div>
                </div>
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold">Top Subjects / Concepts (view)</h3>
                        <button id="dataBtn-chartSubjects" class="icon-btn text-xs" onclick="toggleChartData('chartSubjects')"><i data-lucide="list-tree" class="w-4 h-4"></i><span class="hidden sm:inline">Data</span></button>
                        <button id="chartBtn-chartSubjects" class="icon-btn text-xs" onclick="toggleChartData('chartSubjects')" style="display: none;"><i data-lucide="bar-chart" class="w-4 h-4"></i><span class="hidden sm:inline">Chart</span></button>
                        <button class="icon-btn" onclick="focusCanvas('chartSubjects','Top Subjects / Concepts (view)')">
                            <i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span>
                        </button>
                    </div>
                    <div id="container-chartSubjects" class="mt-2 h-[300px]">
                        <canvas id="chartSubjects"></canvas>
                        <div id="dataTable-chartSubjects" class="hidden h-96 overflow-y-auto w-full"></div>
                        </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold">Top Home Authors (institution authors)</h3>
                        <button id="dataBtn-chartHomeAuthors" class="icon-btn text-xs" onclick="toggleChartData('chartHomeAuthors')"><i data-lucide="list-tree" class="w-4 h-4"></i><span class="hidden sm:inline">Data</span></button>
                        <button id="chartBtn-chartHomeAuthors" class="icon-btn text-xs" onclick="toggleChartData('chartHomeAuthors')" style="display: none;"><i data-lucide="bar-chart" class="w-4 h-4"></i><span class="hidden sm:inline">Chart</span></button>
                        <button class="icon-btn" onclick="focusCanvas('chartHomeAuthors','Top Home Authors (institution authors)')">
                            <i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span>
                        </button>
                    </div>
                    <div id="container-chartHomeAuthors" class="mt-2 h-[300px]">
                        <canvas id="chartHomeAuthors"></canvas>
                        <div id="dataTable-chartHomeAuthors" class="hidden h-96 overflow-y-auto w-full"></div>
                        </div>
                </div>
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold">Retractions by Year (OpenAlex flag + notices)</h3>
                        <button id="dataBtn-chartRetract" class="icon-btn text-xs" onclick="toggleChartData('chartRetract')"><i data-lucide="list-tree" class="w-4 h-4"></i><span class="hidden sm:inline">Data</span></button>
                        <button id="chartBtn-chartRetract" class="icon-btn text-xs" onclick="toggleChartData('chartRetract')" style="display: none;"><i data-lucide="bar-chart" class="w-4 h-4"></i><span class="hidden sm:inline">Chart</span></button>
                        <button class="icon-btn" onclick="focusCanvas('chartRetract','Retractions by Year')">
                            <i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span>
                        </button>
                    </div>
                    <div id="container-chartRetract" class="mt-2 h-[300px]">
                        <canvas id="chartRetract"></canvas>
                        <div id="dataTable-chartRetract" class="hidden h-96 overflow-y-auto w-full"></div>
                        </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 gap-4">
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold">Publishers — Distinct Journals (view)</h3>
                        <button id="dataBtn-chartPublishers" class="icon-btn text-xs" onclick="toggleChartData('chartPublishers')"><i data-lucide="list-tree" class="w-4 h-4"></i><span class="hidden sm:inline">Data</span></button>
                        <button id="chartBtn-chartPublishers" class="icon-btn text-xs" onclick="toggleChartData('chartPublishers')" style="display: none;"><i data-lucide="bar-chart" class="w-4 h-4"></i><span class="hidden sm:inline">Chart</span></button>
                        <button class="icon-btn" onclick="focusCanvas('chartPublishers','Publishers — Distinct Journals (view)')">
                            <i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span>
                        </button>
                    </div>
                    <div id="container-chartPublishers" class="mt-2 h-[300px]">
                        <canvas id="chartPublishers"></canvas>
                        <div id="dataTable-chartPublishers" class="hidden h-96 overflow-y-auto w-full"></div>
                        </div>
                    <div class="text-xs text-slate-500 mt-2">Counts unique journal titles per publishing house (heuristic mapping).</div>
                </div>
            </div>
            
            <div class="card p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-semibold">Sustainable Development Goals (auto-mapped)</h3>
                        <p class="text-xs text-slate-500">Titles (and subjects, if present) are heuristically mapped to SDGs.</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="sdgOnlyFilter" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="applyFilters(1)">
                           <option value="">All SDGs</option>
                        </select>
                        <button id="dataBtn-chartSDG" class="icon-btn text-xs" onclick="toggleChartData('chartSDG')"><i data-lucide="list-tree" class="w-4 h-4"></i><span class="hidden sm:inline">Data</span></button>
                        <button id="chartBtn-chartSDG" class="icon-btn text-xs" onclick="toggleChartData('chartSDG')" style="display: none;"><i data-lucide="bar-chart" class="w-4 h-4"></i><span class="hidden sm:inline">Chart</span></button>
                        <button class="icon-btn" onclick="focusCanvas('chartSDG','SDG Distribution (view)')">
                            <i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span>
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="card p-4">
                        <h4 class="font-semibold flex items-center justify-between">
                            <span>SDG Distribution (view)</span>
                            <div class="flex items-center gap-2">
                                <button id="dataBtn-chartSDG" class="icon-btn text-xs" onclick="toggleChartData('chartSDG')"><i data-lucide="list-tree" class="w-4 h-4"></i></button>
                                <button id="chartBtn-chartSDG" class="icon-btn text-xs" onclick="toggleChartData('chartSDG')" style="display: none;"><i data-lucide="bar-chart" class="w-4 h-4"></i></button>
                                <button class="icon-btn" onclick="focusCanvas('chartSDG','SDG Distribution (view)')"><i data-lucide="maximize-2"></i></button>
                            </div>
                            </h4>
                        <div id="container-chartSDG" class="mt-2 h-[280px]">
                            <canvas id="chartSDG"></canvas>
                            <div id="dataTable-chartSDG" class="hidden h-96 overflow-y-auto w-full"></div>
                            </div>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-semibold mb-2">Legend</h4>
                        <div id="sdgLegend" class="flex flex-wrap gap-2 text-sm"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="text-center text-xs text-slate-500 pb-8">
        Data from <code>institution_data.json</code> · Quartiles/IF mapped client-side · SDG & Retraction notices are heuristic
    </footer>
    
    <div id="focusOverlay" class="focus-overlay hidden">
        <div class="absolute inset-0 grid place-items-center p-4" onclick="closeFocus()">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[85vh] p-4 relative overflow-hidden" onclick="event.stopPropagation()">
                <button class="icon-btn absolute top-3 right-3" onclick="closeFocus()"><i data-lucide="x"></i></button>
                <div class="flex items-center justify-between border-b pb-2 mb-3">
                    <div id="focusTitle" class="font-semibold"></div>
                </div>
                <img id="focusImg" class="w-full h-[calc(100%-3rem)] object-contain select-none" alt="Chart preview"/>
            </div>
        </div>
    </div>
    
<script>
    lucide.createIcons();
    
    /* -------- Chart.js helpers -------- */
    Chart.defaults.font.family = "'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    Chart.defaults.plugins.tooltip.backgroundColor = '#0f172a';
    Chart.defaults.plugins.tooltip.borderColor = '#334155';
    Chart.defaults.plugins.tooltip.borderWidth = 1;
    Chart.defaults.plugins.tooltip.padding = 12;
    Chart.defaults.plugins.legend.labels.boxWidth = 10;
    
    const shadowPlugin = {
        id: 'shadowPlugin',
        beforeDatasetsDraw(chart){ const {ctx}=chart; ctx.save(); ctx.shadowColor='rgba(2,6,23,.12)'; ctx.shadowBlur=14; ctx.shadowOffsetY=6; },
        afterDatasetsDraw(chart){ chart.ctx.restore(); }
    };
    Chart.register(shadowPlugin);
    
    const clr = {
        indigo:'#6366f1', purple:'#a855f7', teal:'#14b8a6', cyan:'#06b6d4',
        q1:'#16a34a', q2:'#3b82f6', q3:'#f59e0b', q4:'#ef4444', gray:'#334155'
    };
    const gradV = (ctx,a,b)=>{ const g=ctx.createLinearGradient(0,0,0,ctx.canvas.height); g.addColorStop(0,a); g.addColorStop(1,b); return g; };
    const gradH = (ctx,a,b)=>{ const g=ctx.createLinearGradient(0,0,ctx.canvas.width,0); g.addColorStop(0,a); g.addColorStop(1,b); return g; };
    
    /* --------------------- STATE --------------------- */
    let all=[], filtered=[], currentPage=1, pageSize=50;
    
    const HOME_ROR = "04q2jes40";
    const HOME_KEYWORDS = ['university of petroleum','energy studies','upes'];
    
    const selectedTypes = new Set();
    let knownTypes = [];
    
    const sjrByIssn = new Map(), sjrByTitle = new Map();
    const sjrMetaByIssn = new Map(), sjrMetaByTitle = new Map();
    let haveSJR=false; let IFcount=0;
    
    /* ----- COLUMNS (Publisher added here) ----- */
    const ALL_COLUMNS = [
        { key:'year',label:'Year',default:true },
        { key:'title',label:'Title',default:true },
        { key:'journal',label:'Journal',default:true },
        { key:'publisher',label:'Publisher',default:true },           /* ✅ NEW */
        { key:'home_authors',label:'Home authors',default:true },
        { key:'authors',label:'Authors',default:false },
        { key:'citations',label:'Citations',default:true },
        { key:'quartile',label:'Quartile',default:true },
        { key:'retraction_info',label:'Retraction Info',default:true },
        { key:'is_retracted',label:'Retracted (OpenAlex)',default:false },
        { key:'type',label:'Type',default:false },
        { key:'doi',label:'DOI',default:false },
        { key:'url',label:'URL',default:false },
        { key:'issns',label:'ISSNs',default:false },
        { key:'subjects',label:'Subject areas',default:false },
        { key:'sdg_tags',label:'SDGs',default:false },
    ];
    let selectedColumns = loadSelectedColumns();
    
    let chartByYear=null, chartTopJournalsQ=null, chartTopJournalsC=null,
        chartIFTop=null, chartIFBubble=null, chartTypesYear=null,
        chartSubjects=null, chartHomeAuthors=null, chartRetract=null,
        chartSDG=null, chartPublishers=null;
    
    const SDG_LIST = [
        { id:1,  name:'No Poverty', kw:['poverty','low-income','income inequality'] },
        { id:2,  name:'Zero Hunger', kw:['hunger','food security','malnutrition','agriculture','crop','farm'] },
        { id:3,  name:'Good Health & Well-being', kw:['health','disease','medicine','mental','epidemic','pandemic','hospital','clinical'] },
        { id:4,  name:'Quality Education', kw:['education','school','teaching','learning','curriculum','literacy','students'] },
        { id:5,  name:'Gender Equality', kw:['gender','women','female','girls','violence against women','equality'] },
        { id:6,  name:'Clean Water & Sanitation', kw:['water','sanitation','wastewater','drinking water','hygiene'] },
        { id:7,  name:'Affordable & Clean Energy', kw:['energy','renewable','solar','wind','battery','hydrogen'] },
        { id:8,  name:'Decent Work & Economic Growth', kw:['employment','workforce','productivity','economy','growth','entrepreneur'] },
        { id:9,  name:'Industry, Innovation & Infrastructure', kw:['industry','manufacturing','infrastructure','innovation','iot','robotics','blockchain'] },
        { id:10, name:'Reduced Inequalities', kw:['inequality','social justice','marginalized','inclusion'] },
        { id:11, name:'Sustainable Cities & Communities', kw:['urban','smart city','transport','housing','resilience','disaster'] },
        { id:12, name:'Responsible Consumption & Production', kw:['circular economy','sustainability','recycling','waste','lifecycle','supply chain'] },
        { id:13, name:'Climate Action', kw:['climate','carbon','ghg','emission','adaptation','mitigation','global warming'] },
        { id:14, name:'Life Below Water', kw:['marine','ocean','sea','fisheries','aquatic','coral'] },
        { id:15, name:'Life on Land', kw:['biodiversity','forest','wildlife','ecosystem','soil','land use'] },
        { id:16, name:'Peace, Justice & Strong Institutions', kw:['governance','policy','corruption','crime','justice','conflict'] },
        { id:17, name:'Partnerships for the Goals', kw:['partnership','collaboration','sdg','stakeholder','international'] },
    ];
    const SDG_COLORS = {1:'#E5243B',2:'#DDA63A',3:'#4C9F38',4:'#C5192D',5:'#FF3A21',6:'#26BDE2',7:'#FCC30B',8:'#A21942',
                        9:'#FD6925',10:'#DD1367',11:'#FD9D24',12:'#BF8B2E',13:'#3F7E44',14:'#0A97D9',15:'#56C02B',16:'#00689D',17:'#19486A'};
    
    const RETRACT_PREFIXES = [
        /^retraction\s*note\s*:/i, /^retraction\s*of\s*:/i, /^retraction\s*:/i, /^notice\s+of\s+retraction\s*:/i, /^withdrawn\s*:/i,
        /^retracted\s+paper\s*:/i, /^retracted\s+article\s*:/i, /^article\s+retracted\s*:/i
    ];
    const DOI_REGEX = /\b(10\.\d{4,9}\/\S+)\b/i;
    
    /* ---------------- Tabs ---------------- */
    function switchTab(name){
        const tabs=['overview','publications','quartiles','sdg'];
        for (const t of tabs){
            document.getElementById(`view-${t}`).classList.toggle('hidden', t!==name);
            const el = document.getElementById(`tab${t[0].toUpperCase()+t.slice(1)}`);
            el.classList.toggle('tab-active', t===name);
            el.classList.toggle('tab-inactive', t!==name);
        }
        if (name==='quartiles') updateCoverage();
        if (name==='sdg') renderSDGChart();
    }
    
    /* --------------- Load data --------------- */
    async function autoLoad(){
        try{
            const res = await fetch('institution_data.json', { cache:'no-store' });
            if (!res.ok) throw new Error('institution_data.json not found');
            const j = await res.json();
            
            document.getElementById('lastSynced').textContent = 
                j.updated ? `Last synced: ${dayjs(j.updated).format('DD MMM YYYY, HH:mm')}` : '';
            
            all = Array.isArray(j.items) ? j.items : [];
            
            // Normalize authors + home authors
            for (const p of all){
                if (!Array.isArray(p.authors)) p.authors = deriveAuthors(p);
                p.home_authors = deriveHomeAuthors(p);
            }
            
            // Retraction links + SDGs
            buildRetractionIndex(all);
            for (const p of all) p.sdg_tags = guessSDGs(p);
            
            document.getElementById('kpiTotal').textContent = num(all.length);
            
            // Year options
            const years = [...new Set(all.map(x=>x.year).filter(y=>y!=null))].sort((a,b)=>a-b);
            const opts = (arr) => ['<option value="">All</option>'].concat(arr.map(y=>`<option value="${y}">${y}</option>`)).join('');
            document.getElementById('yearFrom').innerHTML = opts(years);
            document.getElementById('yearTo').innerHTML  = opts(years);
            
            // SDG options
            buildSDGOptions();
            
            // Types
            computeKnownTypes();
            buildTypePanel();
            
            pageSize = parseInt(document.getElementById('pageSize').value,10) || 50;
            
            buildColumnsPanel();
            buildSDGLegend();
            applyFilters(1);
        }catch(e){
            document.getElementById('lastSynced').textContent = 'Error: '+e.message;
            console.error(e);
        }
    }
    
    /* --------- Authors helpers --------- */
    function deriveAuthors(p){
        const out=[];
        if (Array.isArray(p.authorships)){
            for (const a of p.authorships){
                const nm = a?.author?.display_name || a?.display_name;
                if (nm) out.push(String(nm));
            }
        }
        if (!out.length && typeof p.authors === 'string' && p.authors.trim()){
            return p.authors.split(/[,;]\s*/).filter(Boolean);
        }
        return out;
    }
    function deriveHomeAuthors(p){
        const out=[];
        if (!Array.isArray(p.authorships)) return out;
        for (const a of p.authorships){
            const nm = a?.author?.display_name || a?.display_name;
            const insts = Array.isArray(a?.institutions) ? a.institutions : [];
            const matchROR = insts.some(i => (i?.ror||'').split('/').pop() === HOME_ROR);
            const matchKW  = insts.some(i => HOME_KEYWORDS.some(k => (i?.display_name||'').toLowerCase().includes(k)));
            if (nm && (matchROR || matchKW)) out.push(String(nm));
        }
        return [...new Set(out)];
    }
    
    function buildRetractionIndex(items){
        const byTitle = new Map(), byDOI = new Map();
        for (const p of items){
            if (p.doi) byDOI.set(String(p.doi).toLowerCase(), p);
            const nt = normTitle(p.title||''); if (nt) byTitle.set(nt, p);
        }
        for (const p of items){
            const title = p.title || '';
            p.retraction_notice = isRetractionNotice(title);
            p.retracted_by = null; p.retraction_of = null;
            if (p.retraction_notice){
                const m = title.match(DOI_REGEX);
                if (m){
                    const target = byDOI.get(m[1].toLowerCase());
                    if (target){ p.retraction_of = { doi: target.doi, title: target.title }; target.retracted_by = { doi: p.doi, title: p.title }; }
                } else {
                    const stripped = stripRetractionPrefix(title);
                    const candidate = byTitle.get(normTitle(stripped));
                    if (candidate){ p.retraction_of = { doi: candidate.doi, title: candidate.title }; candidate.retracted_by = { doi: p.doi, title: p.title }; }
                }
            }
        }
    }
    const isRetractionNotice = title => RETRACT_PREFIXES.some(rx => rx.test(String(title||'')));
    const stripRetractionPrefix = title => { let t=String(title||''); for (const rx of RETRACT_PREFIXES){ if (rx.test(t)) return t.replace(rx,'').trim(); } return t; };
    
    /* --------------- SDG options --------------- */
    function buildSDGOptions(){
        const opts = SDG_LIST.map(s=>`<option value="${s.id}">${s.id}. ${s.name}</option>`).join('');
        const sel1 = document.getElementById('sdgFilter');
        const sel2 = document.getElementById('sdgOnlyFilter');
        if (sel1) sel1.innerHTML = '<option value="">All SDGs</option>' + opts;
        if (sel2) sel2.innerHTML = '<option value="">All SDGs</option>' + opts;
    }
    
    /* --------------- Type multi-select --------------- */
    const normalizeType = t => {
        const s=String(t||'').toLowerCase();
        if (s==='journal-article') return 'article';
        if (s.includes('proceed')) return 'proceedings-article';
        if (s.startsWith('book'))  return 'book';
        return s || 'unknown';
    };
    const labelForType = key => ({
        'article':'Article','proceedings-article':'Proceedings','book':'Book/Chapter','dataset':'Dataset','report':'Report',
        'preprint':'Preprint','letter':'Letter','review':'Review','editorial':'Editorial','unknown':'Other'
    }[key] || key.replace(/(^|\-)(\w)/g,(m,_,c)=>' '+c.toUpperCase()).trim());
    
    function computeKnownTypes(){
        const counts=new Map();
        for (const p of all){
            const k=normalizeType(p.type || p.type_crossref);
            counts.set(k, (counts.get(k)||0)+1);
        }
        knownTypes = [...counts.keys()].sort((a,b)=>counts.get(b)-counts.get(a));
    }
    
    /* --------------- Data tabs START --------------- */
    function toggleChartData(chartId){
        const canvas = document.getElementById(chartId);
        const dataTable = document.getElementById(`dataTable-${chartId}`);
        const chartBtn = document.getElementById(`chartBtn-${chartId}`);
        const dataBtn = document.getElementById(`dataBtn-${chartId}`);

        if (canvas.classList.contains('hidden')){
            // Currently showing data, switch to chart
            canvas.classList.remove('hidden');
            dataTable.classList.add('hidden');
            chartBtn.style.display = 'none';
            dataBtn.style.display = '';
        } else {
            // Currently showing chart, switch to data
            canvas.classList.add('hidden');
            dataTable.classList.remove('hidden');
            chartBtn.style.display = '';
            dataBtn.style.display = 'none';
        }
    }

    function renderDataTable(tableId, columns, data){
        const container = document.getElementById(tableId);
        if (!container) return;

        let html = `
            <table class="w-full text-left text-sm table-auto border-separate border-spacing-0 overflow-hidden rounded-xl border border-slate-200">
                <thead>
                    <tr class="bg-slate-50">
                        ${columns.map(col => `<th class="px-4 py-3 font-semibold text-slate-500">${col}</th>`).join('')}
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200">
                    ${data.map(row => `
                        <tr class="hover:bg-slate-100">
                            ${row.map(cell => `<td class="px-4 py-2 text-slate-900">${cell}</td>`).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        container.innerHTML = html;
    }
    /* --------------- Data tabs END --------------- */
    
    /* --------------- Render charts --------------- */
    function renderCharts(){
        // Destroy old charts
        for (const c of [chartByYear,chartTopJournalsQ,chartTopJournalsC,chartIFTop,chartIFBubble,chartTypesYear,chartSubjects,chartHomeAuthors,chartRetract,chartSDG,chartPublishers]){
            if (c) c.destroy();
        }
        
        // Data for charts
        const publicationsByYear = {};
        for (const p of filtered){ publicationsByYear[p.year] = (publicationsByYear[p.year] || 0) + 1; }
        const years = Object.keys(publicationsByYear).sort((a,b)=>a-b);
        const countData = years.map(y=>publicationsByYear[y]);
        const cumulData = countData.reduce((acc,curr,i)=>{ acc.push((acc[i-1]||0)+curr); return acc; },[]);
        
        // Year range text
        if (years.length > 0) document.getElementById('rangeText').textContent = `Showing ${years[0]} - ${years[years.length-1]}`;
        
        // Chart 1: By Year
        const ctxYear = document.getElementById('chartByYear').getContext('2d');
        chartByYear = new Chart(ctxYear, {
            type:'bar', data:{ labels:years, datasets:[
                { type:'bar', label:'Publications', data:countData, backgroundColor:clr.indigo, borderColor:clr.indigo, yAxisID:'y'},
                { type:'line', label:'Cumulative', data:cumulData, backgroundColor:clr.teal, borderColor:clr.teal, borderWidth:2, yAxisID:'y1', tension:0.4, fill:false, pointRadius:2}
            ]},
            options:{
                responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}},
                scales:{
                    y:{type:'linear', display:true, position:'left', title:{display:true, text:'Publications'}},
                    y1:{type:'linear', display:true, position:'right', grid:{drawOnChartArea:false}, title:{display:true, text:'Cumulative'}}
                }
            }
        });
        // START OF CHANGES: Render data table for Chart 1
        renderDataTable('dataTable-chartByYear', ['Year', 'Publications', 'Cumulative'], years.map((y, i) => [y, countData[i], cumulData[i]]));
        // END OF CHANGES
        
        // Top Journals by Quartile
        const journalQuartiles = new Map();
        for (const p of filtered.filter(p=>p.quartile)){
            const q = p.quartile.slice(0,2).toUpperCase();
            if (!journalQuartiles.has(p.journal)) journalQuartiles.set(p.journal, new Map());
            const counts = journalQuartiles.get(p.journal);
            counts.set(q, (counts.get(q)||0)+1);
        }
        const topJournalsQ = [...journalQuartiles.entries()].sort((a,b)=>{
            const totalA = [...a[1].values()].reduce((sum,v)=>sum+v,0);
            const totalB = [...b[1].values()].reduce((sum,v)=>sum+v,0);
            return totalB-totalA;
        }).slice(0,10);
        
        const journalLabelsQ = topJournalsQ.map(j=>j[0]);
        const q1Data = topJournalsQ.map(j=>j[1].get('Q1')||0);
        const q2Data = topJournalsQ.map(j=>j[1].get('Q2')||0);
        const q3Data = topJournalsQ.map(j=>j[1].get('Q3')||0);
        const q4Data = topJournalsQ.map(j=>j[1].get('Q4')||0);
        
        const ctxQ = document.getElementById('chartTopJournalsQ').getContext('2d');
        chartTopJournalsQ = new Chart(ctxQ, {
            type:'bar', data:{ labels:journalLabelsQ, datasets:[
                { label:'Q1', data:q1Data, backgroundColor:clr.q1},
                { label:'Q2', data:q2Data, backgroundColor:clr.q2},
                { label:'Q3', data:q3Data, backgroundColor:clr.q3},
                { label:'Q4', data:q4Data, backgroundColor:clr.q4},
            ]},
            options:{
                responsive:true, maintainAspectRatio:false, indexAxis:'y',
                scales:{ x:{stacked:true}, y:{stacked:true, reverse:true} }
            }
        });
        // START OF CHANGES: Render data table for Chart 2
        const journalDataQ = journalLabelsQ.map((journal, i) => [journal, q1Data[i], q2Data[i], q3Data[i], q4Data[i]]);
        renderDataTable('dataTable-chartTopJournalsQ', ['Journal', 'Q1', 'Q2', 'Q3', 'Q4'], journalDataQ);
        // END OF CHANGES
        
        // Top Journals by Publications vs Citations
        const journalCitations = new Map();
        for (const p of filtered){
            if (!p.journal) continue;
            const data = journalCitations.get(p.journal) || {pubs:0, cites:0};
            data.pubs++;
            data.cites += p.citations || 0;
            journalCitations.set(p.journal, data);
        }
        const topJournalsC = [...journalCitations.entries()].sort((a,b)=>b[1].pubs-a[1].pubs).slice(0,10);
        
        const journalLabelsC = topJournalsC.map(j=>j[0]);
        const pubCountData = topJournalsC.map(j=>j[1].pubs);
        const totalCitationsData = topJournalsC.map(j=>j[1].cites);
        
        const ctxC = document.getElementById('chartTopJournalsC').getContext('2d');
        chartTopJournalsC = new Chart(ctxC, {
            type:'bar', data:{ labels:journalLabelsC, datasets:[
                { label:'Publications', data:pubCountData, backgroundColor:clr.indigo, yAxisID:'y'},
                { label:'Total Citations', data:totalCitationsData, backgroundColor:clr.teal, yAxisID:'y1'}
            ]},
            options:{
                responsive:true, maintainAspectRatio:false, indexAxis:'y',
                scales:{
                    y:{ type:'linear', display:true, position:'left', title:{display:true, text:'Publications'}},
                    y1:{ type:'linear', display:true, position:'right', grid:{drawOnChartArea:false}, title:{display:true, text:'Total Citations'}}
                }
            }
        });
        // START OF CHANGES: Render data table for Chart 3
        const journalDataC = journalLabelsC.map((journal, i) => [journal, pubCountData[i], totalCitationsData[i]]);
        renderDataTable('dataTable-chartTopJournalsC', ['Journal', 'Publications', 'Total Citations'], journalDataC);
        // END OF CHANGES
        
        // Journal Impact Factor (from IF file)
        const journalIFs = [...sjrByTitle.entries(), ...sjrByIssn.entries()];
        const ifMap = new Map();
        for (const [key, value] of journalIFs){
            const title = sjrMetaByTitle.get(key)?.journal || sjrMetaByIssn.get(key)?.journal || key;
            ifMap.set(title, value.if);
        }
        
        const topIFs = [...ifMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
        const ifTopLabels = topIFs.map(j=>j[0]);
        const ifTopData = topIFs.map(j=>j[1]);
        
        const ctxIF = document.getElementById('chartIFTop').getContext('2d');
        chartIFTop = new Chart(ctxIF, {
            type:'bar', data:{ labels:ifTopLabels, datasets:[
                { label:'Impact Factor', data:ifTopData, backgroundColor:clr.purple}
            ]},
            options:{
                responsive:true, maintainAspectRatio:false, indexAxis:'y',
                scales:{ x:{beginAtZero:true}}
            }
        });
        document.getElementById('ifTopNote').textContent = `Note: The Impact Factor data is from an external file, not from the core publication data. IF records loaded: ${num(IFcount)}`;
        // START OF CHANGES: Render data table for Chart 4
        renderDataTable('dataTable-chartIFTop', ['Journal', 'Impact Factor'], topIFs);
        // END OF CHANGES
        
        // Journal Impact Factor (Bubble chart)
        const ifBubbleData = topIFs.map(([title, ifValue]) => {
            const pubCount = journalCitations.get(title)?.pubs || 0;
            return {
                x: ifValue,
                y: pubCount,
                r: Math.sqrt(pubCount) * 4,
                title: title
            }
        });
        
        const ctxIFBubble = document.getElementById('chartIFBubble').getContext('2d');
        chartIFBubble = new Chart(ctxIFBubble, {
            type: 'bubble', data: { datasets: [{
                label: 'Journal Impact vs Publications',
                data: ifBubbleData,
                backgroundColor: 'rgba(102, 126, 234, 0.7)',
            }]},
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'Impact Factor' },
                        grid: { display: false }
                    },
                    y: {
                        title: { display: true, text: 'Publications' },
                        grid: { display: false }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const data = context.raw;
                                return `${data.title}: Pubs: ${data.y}, IF: ${data.x}`;
                            }
                        }
                    }
                }
            }
        });
        // START OF CHANGES: Render data table for Chart 5
        const ifBubbleTableData = ifBubbleData.map(d => [d.title, d.x, d.y]);
        renderDataTable('dataTable-chartIFBubble', ['Journal', 'Impact Factor', 'Publications'], ifBubbleTableData);
        // END OF CHANGES
        
        // Types by Year
        const typesByYear = {};
        for (const p of filtered){
            if (!p.year) continue;
            const year = p.year;
            const type = normalizeType(p.type || p.type_crossref);
            if (!typesByYear[year]) typesByYear[year] = {};
            typesByYear[year][type] = (typesByYear[year][type] || 0) + 1;
        }
        
        const yearsForTypes = Object.keys(typesByYear).sort((a,b)=>a-b);
        const datasetsForTypes = knownTypes.map(type => ({
            label: labelForType(type),
            data: yearsForTypes.map(year => typesByYear[year][type] || 0),
            backgroundColor: getColorForType(type),
        }));
        
        const ctxTypes = document.getElementById('chartTypesYear').getContext('2d');
        chartTypesYear = new Chart(ctxTypes, {
            type:'bar', data:{ labels:yearsForTypes, datasets:datasetsForTypes },
            options:{
                responsive:true, maintainAspectRatio:false,
                scales:{ x:{stacked:true}, y:{stacked:true, beginAtZero:true}}
            }
        });
        // START OF CHANGES: Render data table for Chart 6
        const typesTableHeaders = ['Year', ...datasetsForTypes.map(d => d.label)];
        const typesTableData = yearsForTypes.map(year => {
            const row = [year];
            for (const type of knownTypes){
                row.push(typesByYear[year][type] || 0);
            }
            return row;
        });
        renderDataTable('dataTable-chartTypesYear', typesTableHeaders, typesTableData);
        // END OF CHANGES
        
        // Subjects
        const subjectCounts = new Map();
        for (const p of filtered){
            if (!Array.isArray(p.subjects)) continue;
            for (const subj of p.subjects){
                const k = subj.display_name;
                subjectCounts.set(k, (subjectCounts.get(k)||0)+1);
            }
        }
        const topSubjects = [...subjectCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
        
        const ctxSubjects = document.getElementById('chartSubjects').getContext('2d');
        chartSubjects = new Chart(ctxSubjects, {
            type:'bar', data:{ labels:topSubjects.map(s=>s[0]), datasets:[
                { label:'Publications', data:topSubjects.map(s=>s[1]), backgroundColor:gradH(ctxSubjects, clr.indigo, clr.purple)}
            ]},
            options:{
                responsive:true, maintainAspectRatio:false, indexAxis:'y',
                scales:{ x:{beginAtZero:true}}
            }
        });
        // START OF CHANGES: Render data table for Chart 7
        renderDataTable('dataTable-chartSubjects', ['Subject', 'Publications'], topSubjects);
        // END OF CHANGES
        
        // Home Authors
        const homeAuthorCounts = new Map();
        for (const p of filtered){
            if (!Array.isArray(p.home_authors)) continue;
            for (const author of p.home_authors){
                homeAuthorCounts.set(author, (homeAuthorCounts.get(author)||0)+1);
            }
        }
        const topHomeAuthors = [...homeAuthorCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
        
        const ctxHomeAuthors = document.getElementById('chartHomeAuthors').getContext('2d');
        chartHomeAuthors = new Chart(ctxHomeAuthors, {
            type:'bar', data:{ labels:topHomeAuthors.map(s=>s[0]), datasets:[
                { label:'Publications', data:topHomeAuthors.map(s=>s[1]), backgroundColor:gradH(ctxHomeAuthors, clr.cyan, clr.teal)}
            ]},
            options:{
                responsive:true, maintainAspectRatio:false, indexAxis:'y',
                scales:{ x:{beginAtZero:true}}
            }
        });
        // START OF CHANGES: Render data table for Chart 8
        renderDataTable('dataTable-chartHomeAuthors', ['Author', 'Publications'], topHomeAuthors);
        // END OF CHANGES
        
        // Retractions
        const retractedByYear = {};
        const retractionNoticesByYear = {};
        for (const p of filtered){
            const year = p.year || 'unknown';
            if (p.is_retracted) retractedByYear[year] = (retractedByYear[year]||0)+1;
            if (p.retraction_notice) retractionNoticesByYear[year] = (retractionNoticesByYear[year]||0)+1;
        }
        const retractYears = Object.keys(retractedByYear).concat(Object.keys(retractionNoticesByYear)).sort((a,b)=>a-b);
        
        const ctxRetract = document.getElementById('chartRetract').getContext('2d');
        chartRetract = new Chart(ctxRetract, {
            type:'bar', data:{ labels:retractYears, datasets:[
                { label:'OpenAlex Retracted', data:retractYears.map(y=>retractedByYear[y]||0), backgroundColor:clr.q4},
                { label:'Retraction Notice', data:retractYears.map(y=>retractionNoticesByYear[y]||0), backgroundColor:clr.gray}
            ]},
            options:{
                responsive:true, maintainAspectRatio:false,
                scales:{ x:{stacked:true}, y:{stacked:true, beginAtZero:true}}
            }
        });
        // START OF CHANGES: Render data table for Chart 9
        const retractTableData = retractYears.map(y => [y, retractedByYear[y]||0, retractionNoticesByYear[y]||0]);
        renderDataTable('dataTable-chartRetract', ['Year', 'OpenAlex Retracted', 'Retraction Notice'], retractTableData);
        // END OF CHANGES
        
        // Publishers
        const publisherCounts = new Map();
        for (const p of filtered){
            if (!p.publisher) continue;
            const k = p.publisher;
            publisherCounts.set(k, (publisherCounts.get(k)||0)+1);
        }
        const topPublishers = [...publisherCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
        
        const ctxPublishers = document.getElementById('chartPublishers').getContext('2d');
        chartPublishers = new Chart(ctxPublishers, {
            type:'bar', data:{ labels:topPublishers.map(s=>s[0]), datasets:[
                { label:'Distinct Journals', data:topPublishers.map(s=>s[1]), backgroundColor:gradH(ctxPublishers, clr.indigo, clr.teal)}
            ]},
            options:{
                responsive:true, maintainAspectRatio:false, indexAxis:'y',
                scales:{ x:{beginAtZero:true}}
            }
        });
        // START OF CHANGES: Render data table for Chart 10
        renderDataTable('dataTable-chartPublishers', ['Publisher', 'Distinct Journals'], topPublishers);
        // END OF CHANGES
    }
    
    // SDG is a separate tab/view, so it has its own function
    function renderSDGChart(){
        if(chartSDG) chartSDG.destroy();
        
        const sdgCounts = {};
        for (const p of filtered){
            if (!Array.isArray(p.sdg_tags)) continue;
            for (const sdgId of p.sdg_tags){
                sdgCounts[sdgId] = (sdgCounts[sdgId] || 0) + 1;
            }
        }
        
        const sortedSDGs = SDG_LIST.sort((a,b)=>(sdgCounts[b.id]||0)-(sdgCounts[a.id]||0));
        const labels = sortedSDGs.map(s => `${s.id}. ${s.name}`);
        const data = sortedSDGs.map(s => sdgCounts[s.id] || 0);
        const colors = sortedSDGs.map(s => SDG_COLORS[s.id]);
        
        const ctxSDG = document.getElementById('chartSDG').getContext('2d');
        chartSDG = new Chart(ctxSDG, {
            type:'bar', data:{ labels:labels, datasets:[
                { label:'Publications', data:data, backgroundColor:colors}
            ]},
            options:{
                responsive:true, maintainAspectRatio:false, indexAxis:'y',
                scales:{ x:{beginAtZero:true}}
            }
        });
        // START OF CHANGES: Render data table for SDG Chart
        const sdgTableData = sortedSDGs.map(s => [`${s.id}. ${s.name}`, sdgCounts[s.id] || 0]);
        renderDataTable('dataTable-chartSDG', ['SDG', 'Publications'], sdgTableData);
        // END OF CHANGES
    }
    
    /* ---------------- Filters etc ---------------- */
    function applyFilters(page=1){
        const searchVal = document.getElementById('searchBar').value.toLowerCase();
        const yearFrom = document.getElementById('yearFrom').value;
        const yearTo = document.getElementById('yearTo').value;
        const retractionFilter = document.getElementById('retractionFilter').value;
        const sdgFilter = document.getElementById('sdgFilter').value;
        const sdgOnlyFilter = document.getElementById('sdgOnlyFilter').value;
        
        filtered = all.filter(p=>{
            const matchesSearch = !searchVal || 
                (p.title || '').toLowerCase().includes(searchVal) ||
                (p.journal || '').toLowerCase().includes(searchVal) ||
                (p.publisher || '').toLowerCase().includes(searchVal) ||
                (p.authors || []).some(a=>a.toLowerCase().includes(searchVal));
                
            const matchesYears = (!yearFrom || (p.year || 0) >= parseInt(yearFrom,10)) &&
                                 (!yearTo || (p.year || 0) <= parseInt(yearTo,10));
            
            const matchesTypes = selectedTypes.size === 0 || selectedTypes.has(normalizeType(p.type || p.type_crossref));
            
            const matchesRetraction = retractionFilter === '' ||
                                      (retractionFilter === 'true' && p.is_retracted) ||
                                      (retractionFilter === 'false' && !p.is_retracted);
                                      
            const matchesSDG = sdgFilter === '' || (p.sdg_tags && p.sdg_tags.includes(parseInt(sdgFilter,10)));
            
            const matchesSDGOnly = sdgOnlyFilter === '' || (p.sdg_tags && p.sdg_tags.includes(parseInt(sdgOnlyFilter,10)));
            
            return matchesSearch && matchesYears && matchesTypes && matchesRetraction && matchesSDG && matchesSDGOnly;
        });
        
        document.getElementById('kpiView').textContent = num(filtered.length);
        document.getElementById('kpiRetr').textContent = num(filtered.filter(p=>p.is_retracted).length);
        document.getElementById('kpiJournals').textContent = num([...new Set(filtered.map(p=>p.journal))].length);
        
        renderCharts();
        renderSDGChart();
        renderTable(page);
    }
    
    function renderTable(page=1){
        const start = (page - 1) * pageSize;
        const end = start + pageSize;
        const data = filtered.slice(start, end);
        
        const tableBody = document.getElementById('publicationTableBody');
        const emptyState = document.getElementById('emptyState');
        const tableFooter = document.getElementById('tableFooter');
        
        if (filtered.length === 0){
            emptyState.classList.remove('hidden');
            tableFooter.classList.add('hidden');
            tableBody.innerHTML = '';
            return;
        }
        
        emptyState.classList.add('hidden');
        tableFooter.classList.remove('hidden');
        
        const html = data.map(p=>`
            <tr class="hover:bg-slate-50">
                ${selectedColumns.map(col => `
                    <td class="px-4 py-3 text-sm text-slate-900 border-b border-slate-200">
                        ${formatData(p, col.key)}
                    </td>
                `).join('')}
            </tr>
        `).join('');
        
        tableBody.innerHTML = html;
        
        updatePagination(page);
    }
    
    function updatePagination(page){
        currentPage = page;
        const totalPages = Math.ceil(filtered.length / pageSize);
        const pageInfo = document.getElementById('pageInfo');
        pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${num(filtered.length)} items)`;
        
        const prevBtn = document.getElementById('prevPage');
        const nextBtn = document.getElementById('nextPage');
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
    }
    
    function changePage(delta){
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= Math.ceil(filtered.length / pageSize)){
            renderTable(newPage);
        }
    }
    
    function num(n){
        return n.toLocaleString();
    }
    
    function formatData(p, key){
        let val = p[key];
        if (val === null || val === undefined) return '<span class="muted">—</span>';
        
        switch(key){
            case 'title': return `<a href="${p.url}" target="_blank" class="font-semibold text-indigo-700 hover:underline">${val}</a>`;
            case 'citations': return num(val);
            case 'year': return val;
            case 'authors': return Array.isArray(val) ? val.slice(0,3).join(', ') + (val.length > 3 ? ` et al.` : '') : val;
            case 'home_authors': return Array.isArray(val) ? val.join(', ') : val;
            case 'is_retracted': return p.is_retracted ? `<span class="text-red-600 font-semibold">Yes</span>` : 'No';
            case 'retraction_info':
                const parts = [];
                if (p.retraction_notice) parts.push('Notice');
                if (p.retracted_by) parts.push(`Retracted by <a href="${p.retracted_by.doi?'https://doi.org/'+p.retracted_by.doi:p.retracted_by.url}" target="_blank" class="underline">this paper</a>`);
                if (p.retraction_of) parts.push(`Retraction of <a href="${p.retraction_of.doi?'https://doi.org/'+p.retraction_of.doi:p.retraction_of.url}" target="_blank" class="underline">this paper</a>`);
                if (p.is_retracted && !parts.length) parts.push('OpenAlex flag only');
                return parts.length ? parts.join('<br>') : '<span class="muted">—</span>';
            case 'type': return labelForType(normalizeType(val));
            case 'journal': return val;
            case 'doi': return `<a href="https://doi.org/${val}" target="_blank" class="underline">${val}</a>`;
            case 'url': return `<a href="${val}" target="_blank" class="underline">Link</a>`;
            case 'issns': return Array.isArray(val) ? val.join(', ') : val;
            case 'subjects': return Array.isArray(val) ? val.map(s=>s.display_name).join(', ') : val;
            case 'sdg_tags':
                if (!Array.isArray(val) || val.length === 0) return '<span class="muted">—</span>';
                return val.map(id => {
                    const sdg = SDG_LIST.find(s => s.id === id);
                    if (!sdg) return `SDG ${id}`;
                    return `<span class="badge" style="border-color:${SDG_COLORS[id]}">${id}</span>`;
                }).join(' ');
            default: return val;
        }
    }
    
    /* ---------------- Columns etc ---------------- */
    function buildColumnsPanel(){
        const container = document.getElementById('columnsPanel');
        const html = ALL_COLUMNS.map(col => `
            <label class="flex items-center gap-2 text-sm text-slate-600">
                <input type="checkbox" data-key="${col.key}" ${col.default ? 'checked' : ''} onchange="toggleColumn(this)">
                ${col.label}
            </label>
        `).join('');
        container.innerHTML = html;
        
        selectedColumns = loadSelectedColumns();
        document.querySelectorAll('#columnsPanel input[type="checkbox"]').forEach(input => {
            input.checked = selectedColumns.some(c => c.key === input.dataset.key);
        });
        
        updateTableHeaders();
    }
    
    function loadSelectedColumns(){
        try{
            const saved = JSON.parse(localStorage.getItem('selectedColumns'));
            if (Array.isArray(saved) && saved.length > 0) return saved;
        }catch(e){}
        return ALL_COLUMNS.filter(c=>c.default);
    }
    
    function toggleColumn(checkbox){
        const key = checkbox.dataset.key;
        if (checkbox.checked){
            const col = ALL_COLUMNS.find(c=>c.key===key);
            if (col) selectedColumns.push(col);
        } else {
            selectedColumns = selectedColumns.filter(c=>c.key!==key);
        }
        localStorage.setItem('selectedColumns', JSON.stringify(selectedColumns));
        updateTableHeaders();
        renderTable(currentPage);
    }
    
    function updateTableHeaders(){
        const table = document.getElementById('publicationTable');
        const headers = document.getElementById('tableHeader');
        
        const html = selectedColumns.map(col => `
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase text-slate-500">${col.label}</th>
        `).join('');
        
        headers.innerHTML = html;
        table.style.gridTemplateColumns = `repeat(${selectedColumns.length}, minmax(0, 1fr))`;
    }
    
    /* ---------------- Type Panel ---------------- */
    function buildTypePanel(){
        const container = document.getElementById('typesPanel');
        const html = knownTypes.map(type => `
            <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" value="${type}" onchange="toggleType(this)">
                <span style="color:${getColorForType(type)}">${labelForType(type)}</span>
            </label>
        `).join('');
        container.innerHTML = html;
    }
    
    function getColorForType(type){
        const baseColors = ['#6366f1', '#a855f7', '#14b8a6', '#06b6d4', '#ef4444', '#f59e0b', '#3b82f6'];
        const hash = type.split('').reduce((acc, char) => char.charCodeAt(0) + acc, 0);
        return baseColors[hash % baseColors.length];
    }
    
    function toggleType(checkbox){
        if (checkbox.checked){
            selectedTypes.add(checkbox.value);
        } else {
            selectedTypes.delete(checkbox.value);
        }
        applyFilters(1);
    }
    
    /* ---------------- SDG Legend ---------------- */
    function buildSDGLegend(){
        const container = document.getElementById('sdgLegend');
        const html = SDG_LIST.map(sdg => `
            <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full" style="background-color:${SDG_COLORS[sdg.id]}"></span>
                <span>${sdg.id}. ${sdg.name}</span>
            </div>
        `).join('');
        container.innerHTML = html;
    }
    
    /* ---------------- Misc functions ---------------- */
    const normTitle = (title) => String(title||'').toLowerCase().replace(/[.,!?'"`:;()\[\]{}—–-]/g, ' ').replace(/\s+/g,' ').trim();
    const guessSDGs = (p) => {
        const keywords = (p.title || '').toLowerCase() + ' ' + (p.subjects || []).map(s=>s.display_name.toLowerCase()).join(' ');
        const matched = new Set();
        for (const sdg of SDG_LIST){
            if (sdg.kw.some(k=>keywords.includes(k))) matched.add(sdg.id);
        }
        return [...matched];
    };
    
    /* ---------------- Focus modal ---------------- */
    function focusCanvas(chartId, title){
        const canvas = document.getElementById(chartId);
        if (!canvas) return;
        
        const focusOverlay = document.getElementById('focusOverlay');
        const focusImg = document.getElementById('focusImg');
        const focusTitle = document.getElementById('focusTitle');
        
        focusOverlay.classList.remove('hidden');
        focusTitle.textContent = title;
        
        // Render chart to a new temporary canvas to get a high-quality image
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width * 2; // High-res
        tempCanvas.height = canvas.height * 2;
        const tempCtx = tempCanvas.getContext('2d');
        const chart = Chart.getChart(chartId);
        if(chart){
             chart.draw(tempCtx);
             focusImg.src = tempCanvas.toDataURL('image/png', 1.0);
        }
    }
    function closeFocus(){
        document.getElementById('focusOverlay').classList.add('hidden');
    }
    
    // Initial call to load everything
    autoLoad();
</script>
</body>
</html>
