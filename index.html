<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AI Publications Portal</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Icons -->
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<!-- Day.js + Chart.js + Matrix plugin -->
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.min.js"></script>

<style>
  .card{ background:rgba(255,255,255,.92); border:1px solid rgba(226,232,240,.92);
         border-radius:16px; box-shadow:0 12px 24px rgba(15,23,42,.08) }
  .thin-scrollbar::-webkit-scrollbar{height:8px;width:8px}
  .thin-scrollbar::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:6px}
  .thin-scrollbar::-webkit-scrollbar-track{background:#F8FAFC}
  .tab-active{color:#111827;border-color:#7c3aed;background:linear-gradient(180deg,#fff,#f8fafc)}
  .tab-inactive{color:#6B7280;border-color:transparent}
  .dropdown{position:relative}
  .dropdown-panel{position:absolute;right:0;top:100%;z-index:40}
  .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .5rem;border-radius:999px;font-size:.72rem;border:1px solid #e2e8f0;background:#f8fafc}
  .muted{ color:#64748b }

  /* Focus overlay */
  .focus-overlay{position:fixed;inset:0;background:rgba(2,6,23,.7);backdrop-filter:blur(2px);z-index:1000;display:none;}
  .focus-panel{position:absolute;inset:4rem 2rem;background:white;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:1rem}
  .focus-close{position:absolute;top:.75rem;right:.75rem}
  .focus-title{font-weight:600;margin:.5rem 0 0 0.25rem}
  .focus-body{height:calc(100% - 3rem)}
  .btn-focus{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:.25rem .5rem;font-size:.85rem;display:flex;align-items:center;gap:.35rem}
  .btn-focus[disabled]{opacity:.4;cursor:not-allowed}
</style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900">

<!-- Header -->
<header class="sticky top-0 z-30 bg-gradient-to-r from-indigo-600/90 via-fuchsia-600/90 to-sky-600/90 text-white backdrop-blur">
  <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-2xl bg-white/15 grid place-content-center shadow-inner">
        <i data-lucide="panel-top" class="text-white"></i>
      </div>
      <div>
        <h1 class="text-lg font-semibold tracking-tight">AI Publications Portal</h1>
        <div id="lastSynced" class="text-xs text-white/80">Loading…</div>
      </div>
    </div>
    <div class="hidden md:flex items-center gap-2 text-xs">
      <span class="px-2 py-1 rounded-lg bg-white/10 border border-white/20">Static JSON · No live API</span>
    </div>
  </div>

  <!-- Tabs -->
  <div class="bg-white">
    <div class="max-w-7xl mx-auto px-4">
      <nav class="flex gap-2">
        <button id="tabOverview"     class="px-4 py-3 text-sm border-b-2 tab-active"   onclick="switchTab('overview')">Overview</button>
        <button id="tabPublications" class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('publications')">Publications</button>
        <button id="tabQuartiles"    class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('quartiles')">Quartiles</button>
        <button id="tabSDG"          class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('sdg')">SDGs</button>
      </nav>
    </div>
  </div>
</header>

<!-- CONTENT -->
<main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

  <!-- OVERVIEW -->
  <section id="view-overview" class="space-y-6">
    <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
      <div class="card p-4"><div class="text-xs text-slate-500">Total items</div><div id="kpiTotal" class="mt-1 text-2xl font-semibold">—</div></div>
      <div class="card p-4"><div class="text-xs text-slate-500">Current view</div><div id="kpiView" class="mt-1 text-2xl font-semibold">—</div></div>
      <div class="card p-4"><div class="text-xs text-slate-500">Retracted (view)</div><div id="kpiRetr" class="mt-1 text-2xl font-semibold">—</div></div>
      <div class="card p-4"><div class="text-xs text-slate-500">Distinct journals (view)</div><div id="kpiJournals" class="mt-1 text-2xl font-semibold">—</div></div>
      <div class="card p-4"><div class="text-xs text-slate-500">IF records loaded</div><div id="kpiIF" class="mt-1 text-2xl font-semibold">—</div></div>
      <div class="card p-4"><div class="text-xs text-slate-500">Quartile-mapped (view)</div><div id="kpiQMap" class="mt-1 text-2xl font-semibold">—</div></div>
    </div>

    <div class="card p-4">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">Publications by Year (with cumulative)</h3>
        <span id="rangeText" class="text-xs text-slate-500"></span>
      </div>
      <div class="mt-2 h-[280px]"><canvas id="chartByYear"></canvas></div>
    </div>

    <!-- Top journals: TOTAL CITATIONS (MATRIX) -->
    <div class="card p-4">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">Top Journals — Total Citations (matrix)</h3>
        <button id="focusCitMatrix" class="btn-focus" title="Focus">
          <i data-lucide="maximize-2" class="h-4 w-4"></i><span>Focus</span>
        </button>
      </div>
      <div class="mt-2 h-[320px]"><canvas id="chartCitMatrix"></canvas></div>
      <div class="text-xs text-slate-500 mt-2">Heatmap by journal (rows) vs citation ranges (columns). Darker = more publications in that range.</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- TOP BY IF (bar, colored by quartile) -->
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Journal Impact — Top by IF (from upload)</h3>
          <button id="focusIFTop" class="btn-focus" title="Focus">
            <i data-lucide="maximize-2" class="h-4 w-4"></i><span>Focus</span>
          </button>
        </div>
        <div class="mt-2 h-[340px]"><canvas id="chartIFTop"></canvas></div>
        <div id="ifTopNote" class="text-xs text-slate-500 mt-2"></div>
      </div>

      <!-- IF x Publications MATRIX -->
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Journal Impact — IF × Publications (matrix)</h3>
          <button id="focusIFMatrix" class="btn-focus" title="Focus">
            <i data-lucide="maximize-2" class="h-4 w-4"></i><span>Focus</span>
          </button>
        </div>
        <div class="mt-2 h-[340px]"><canvas id="chartIFMatrix"></canvas></div>
        <div id="ifBubNote" class="text-xs text-slate-500 mt-2"></div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card p-4">
        <h3 class="font-semibold">Types by Year (view)</h3>
        <div class="mt-2 h-[300px]"><canvas id="chartTypesYear"></canvas></div>
      </div>
      <div class="card p-4">
        <h3 class="font-semibold">Top Subjects / Concepts (view)</h3>
        <div class="mt-2 h-[300px]"><canvas id="chartSubjects"></canvas></div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card p-4">
        <h3 class="font-semibold">Top Home Authors (institution authors)</h3>
        <div class="mt-2 h-[300px]"><canvas id="chartHomeAuthors"></canvas></div>
      </div>
      <div class="card p-4">
        <h3 class="font-semibold">Retractions by Year (OpenAlex flag + notices)</h3>
        <div class="mt-2 h-[300px]"><canvas id="chartRetract"></canvas></div>
      </div>
    </div>
  </section>

  <!-- PUBLICATIONS -->
  <section id="view-publications" class="hidden space-y-4">
    <div class="card p-4">
      <div class="flex flex-wrap items-end gap-3">
        <div>
          <label class="block text-xs font-medium text-slate-600">Search</label>
          <input id="searchBox" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" placeholder="Title / author / journal / DOI" oninput="applyFilters(1)"/>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-600">Year (from)</label>
          <select id="yearFrom" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="applyFilters(1)"><option value="">All</option></select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600">Year (to)</label>
          <select id="yearTo" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="applyFilters(1)"><option value="">All</option></select>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-600">Retraction mode</label>
          <select id="retractionFilter" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="applyFilters(1)">
            <option value="">All</option>
            <option value="exclude">Exclude retracted</option>
            <option value="only_retracted">Only retracted (OpenAlex)</option>
            <option value="only_notices">Only retraction notices (title-based)</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-600">SDG</label>
          <select id="sdgFilter" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="applyFilters(1)">
            <option value="">All SDGs</option>
          </select>
        </div>

        <!-- Type multi-select -->
        <div class="dropdown">
          <label class="block text-xs font-medium text-slate-600">Type</label>
          <button id="typeBtn" class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-300 text-sm min-w-[170px]" onclick="toggleTypePanel()">
            <span id="typeBtnLabel">All types</span>
          </button>
          <div id="typePanel" class="dropdown-panel hidden mt-2 bg-white border border-slate-200 rounded-xl shadow-lg w-64 p-3">
            <div class="text-xs text-slate-500 mb-2">Select one or more</div>
            <div id="typeList" class="grid grid-cols-1 gap-y-1 text-sm max-h-64 overflow-auto pr-1"></div>
            <div class="flex justify-between gap-2 mt-3">
              <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="clearTypeSelection()">Clear</button>
              <button class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white" onclick="applyTypeSelection()">Apply</button>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-600">Rows per page</label>
          <select id="pageSize" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="changePageSize()">
            <option value="25">25</option><option value="50" selected>50</option><option value="100">100</option><option value="200">200</option>
          </select>
        </div>

        <!-- Column chooser -->
        <div class="ml-auto dropdown">
          <label class="block text-xs font-medium text-slate-600">&nbsp;</label>
          <button id="colBtn" class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-300 text-sm flex items-center gap-2" onclick="toggleColumnsPanel()">
            <i data-lucide="columns-3"></i> Columns
          </button>
          <div id="columnsPanel" class="dropdown-panel hidden mt-2 bg-white border border-slate-200 rounded-xl shadow-lg w-80 p-3">
            <div class="text-xs text-slate-500 mb-2">Choose fields to display</div>
            <div id="columnsList" class="grid grid-cols-2 gap-y-2 text-sm"></div>
            <div class="flex justify-end gap-2 mt-3">
              <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="resetColumns()">Reset</button>
              <button class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white" onclick="applyColumnSelection()">Apply</button>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <label class="block text-xs font-medium text-slate-600">&nbsp;</label>
          <button class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm" onclick="exportCSV()">Export CSV</button>
          <button class="px-3 py-2 rounded-xl bg-indigo-50 text-indigo-700 border border-indigo-200 text-sm" onclick="exportJSON()">Export JSON</button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
        <div class="font-semibold">All Publications</div>
        <div class="text-xs text-slate-500" id="countInfo"></div>
      </div>
      <div class="overflow-x-auto thin-scrollbar">
        <table class="w-full text-sm" id="pubTable">
          <thead class="bg-slate-50 text-slate-600">
            <tr id="pubHeadRow"></tr>
          </thead>
          <tbody id="pubBody"></tbody>
        </table>
      </div>
      <div class="px-4 py-3 flex items-center justify-between">
        <div class="text-xs text-slate-500" id="pageInfo">Page 1 / 1</div>
        <div class="flex gap-2">
          <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goFirst()">« First</button>
          <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goPrev()">‹ Prev</button>
          <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goNext()">Next ›</button>
          <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goLast()">Last »</button>
        </div>
      </div>
    </div>
  </section>

  <!-- QUARTILES -->
  <section id="view-quartiles" class="hidden space-y-4">
    <div class="card p-4">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-semibold">Quartile & IF Mapping</h3>
          <p class="text-xs text-slate-500">
            Upload SCImago/Clarivate data as <code>.csv</code> (must contain Title or ISSN; accept headers like
            <em>SJR Best Quartile</em>, <em>Best Quartile</em>, <em>JIF Quartile</em>, <em>Impact Factor</em>/<em>JIF</em>), or <code>.json</code>.
          </p>
        </div>
        <div class="flex items-center gap-2">
          <input id="sjrFile" type="file" accept=".csv,.json" class="hidden"/>
          <button class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-300 text-sm" onclick="document.getElementById('sjrFile').click()">
            <i data-lucide="upload"></i> Upload Quartiles
          </button>
        </div>
      </div>
      <div id="sjrStatus" class="mt-2 text-xs text-slate-500"></div>
    </div>

    <div class="card p-4">
      <h4 class="font-semibold mb-2">Coverage in current view</h4>
      <div class="text-sm" id="mapCoverage">—</div>
    </div>
  </section>

  <!-- SDG -->
  <section id="view-sdg" class="hidden space-y-4">
    <div class="card p-4">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-semibold">Sustainable Development Goals (auto-mapped)</h3>
          <p class="text-xs text-slate-500">Titles (and subjects, if present) are heuristically mapped to SDGs.</p>
        </div>
        <div class="flex items-center gap-2">
          <select id="sdgOnlyFilter" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="applyFilters(1)">
            <option value="">All SDGs</option>
          </select>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card p-4">
        <h4 class="font-semibold">SDG Distribution (view)</h4>
        <div class="mt-2 h-[280px]"><canvas id="chartSDG"></canvas></div>
      </div>
      <div class="card p-4">
        <h4 class="font-semibold mb-2">Legend</h4>
        <div id="sdgLegend" class="flex flex-wrap gap-2 text-sm"></div>
      </div>
    </div>
  </section>
</main>

<footer class="text-center text-xs text-slate-500 pb-8">
  Data from <code>institution_data.json</code> · Quartiles/IF mapped client-side · SDG & Retraction notices are heuristic
</footer>

<!-- Focus overlay -->
<div id="focusOverlay" class="focus-overlay">
  <div class="focus-panel">
    <button class="focus-close btn-focus" onclick="closeFocus()"><i data-lucide='x'></i>Close</button>
    <div id="focusTitle" class="focus-title"></div>
    <div class="focus-body"><canvas id="focusCanvas"></canvas></div>
  </div>
</div>

<script>
/* ---------- Base setup ---------- */
lucide.createIcons();

Chart.defaults.font.family = "'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
Chart.defaults.plugins.tooltip.backgroundColor = '#0f172a';
Chart.defaults.plugins.tooltip.borderColor = '#334155';
Chart.defaults.plugins.tooltip.borderWidth = 1;
Chart.defaults.plugins.tooltip.padding = 12;
Chart.defaults.plugins.legend.labels.boxWidth = 10;

const shadowPlugin = {
  id: 'shadowPlugin',
  beforeDatasetsDraw(chart){ const {ctx}=chart; ctx.save(); ctx.shadowColor='rgba(2,6,23,.12)'; ctx.shadowBlur=14; ctx.shadowOffsetY=6; },
  afterDatasetsDraw(chart){ chart.ctx.restore(); }
};
Chart.register(shadowPlugin);

const clr = {
  indigo:'#6366f1', purple:'#a855f7', teal:'#14b8a6', cyan:'#06b6d4',
  q1:'#16a34a', q2:'#3b82f6', q3:'#f59e0b', q4:'#ef4444', gray:'#334155'
};

/* ---------- Utilities (hoisted) ---------- */
function parseNum(v){
  let s = String(v ?? '').trim();
  if (!s) return null;
  s = s.replace(/\s+/g, '');
  if (/^\d{1,3}(\.\d{3})+(,\d+)?$/.test(s)) s = s.replace(/\./g, '').replace(',', '.');
  else if (/^\d{1,3}(,\d{3})+(\.\d+)?$/.test(s)) s = s.replace(/,/g, '');
  else { if (s.includes(',') && !s.includes('.')) s = s.replace(',', '.'); s = s.replace(/,/g, ''); }
  const m = s.match(/-?\d+(\.\d+)?/); return m ? parseFloat(m[0]) : null;
}
const esc = s => String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const num = n => (n||0).toLocaleString();
const normTitle = t => String(t||'').toLowerCase().replace(/\s+/g,' ').trim();
const normIssn = s => { const x=String(s||'').replace(/[^0-9xX]/g,'').toUpperCase(); const eight = x.length===8 ? x : (x.length===7 ? '0'+x : ''); return eight ? (eight.slice(0,4)+'-'+eight.slice(4)) : ''; };
const normQuartile = q => { const s=String(q||'').toUpperCase(); const m = s.match(/Q([1-4])/); return m ? `Q${m[1]}` : ''; };
const qColor = q => q==='Q1'?clr.q1:q==='Q2'?clr.q2:q==='Q3'?clr.q3:q==='Q4'?clr.q4:'#94a3b8';

/* ---------- State ---------- */
let all=[], filtered=[], currentPage=1, pageSize=50;

/* Home authors */
const HOME_ROR = "04q2jes40";
const HOME_KEYWORDS = ['university of petroleum','energy studies','upes'];

/* Types */
const selectedTypes = new Set();
let knownTypes = [];

/* Quartiles & IF */
const sjrByIssn = new Map(), sjrByTitle = new Map();
const sjrMetaByIssn = new Map(), sjrMetaByTitle = new Map(); // {q, if}
let haveSJR=false; let IFcount=0;

/* Columns */
const ALL_COLUMNS = [
  { key:'year', label:'Year', default:true },
  { key:'title', label:'Title', default:true },
  { key:'journal', label:'Journal', default:true },
  { key:'home_authors', label:'Home authors', default:true },
  { key:'authors', label:'Authors', default:false },
  { key:'citations', label:'Citations', default:true },
  { key:'quartile', label:'Quartile', default:true },
  { key:'retraction_info', label:'Retraction Info', default:true },
  { key:'is_retracted', label:'Retracted (OpenAlex)', default:false },
  { key:'type', label:'Type', default:false },
  { key:'doi', label:'DOI', default:false },
  { key:'url', label:'URL', default:false },
  { key:'issns', label:'ISSNs', default:false },
  { key:'subjects', label:'Subject areas', default:false },
  { key:'sdg_tags', label:'SDGs', default:false },
];
let selectedColumns = loadSelectedColumns();

/* Charts */
let chartByYear=null, chartCitMatrix=null, chartIFTop=null, chartIFMatrix=null,
    chartTypesYear=null, chartSubjects=null, chartHomeAuthors=null, chartRetract=null, chartSDG=null;

/* Focus management */
let currentFocusBuilder = null;
function openFocus(title, buildConfigFn){
  const overlay = document.getElementById('focusOverlay');
  document.getElementById('focusTitle').textContent = title;
  overlay.style.display='block';
  currentFocusBuilder = buildConfigFn;
  setTimeout(()=>{ // render after panel visible
    const ctx = document.getElementById('focusCanvas').getContext('2d');
    if (window.__focusChart) { window.__focusChart.destroy(); }
    const cfg = buildConfigFn(ctx, true);
    window.__focusChart = new Chart(ctx, cfg);
  }, 0);
}
function closeFocus(){
  const overlay = document.getElementById('focusOverlay');
  overlay.style.display='none';
  if (window.__focusChart) { window.__focusChart.destroy(); window.__focusChart=null; }
}
document.getElementById('focusOverlay').addEventListener('click',(e)=>{
  // click outside canvas closes
  const panel = e.currentTarget.querySelector('.focus-panel');
  if (!panel.contains(e.target)) closeFocus();
});
function setFocusEnabled(btnId, enabled, title, builder){
  const btn = document.getElementById(btnId);
  if (!btn) return;
  btn.disabled = !enabled;
  btn.onclick = enabled ? ()=>openFocus(title, builder) : null;
}

/* ---------- Tabs ---------- */
function switchTab(name){
  const tabs=['overview','publications','quartiles','sdg'];
  for (const t of tabs){
    document.getElementById(`view-${t}`).classList.toggle('hidden', t!==name);
    const el = document.getElementById(`tab${t[0].toUpperCase()+t.slice(1)}`);
    el.classList.toggle('tab-active', t===name);
    el.classList.toggle('tab-inactive', t!==name);
  }
  if (name==='quartiles') updateCoverage();
  if (name==='sdg') renderSDGChart();
}

/* ---------- Load data ---------- */
async function autoLoad(){
  try{
    const res = await fetch('institution_data.json', { cache:'no-store' });
    if (!res.ok) throw new Error('institution_data.json not found');
    const j = await res.json();

    document.getElementById('lastSynced').textContent =
      j.updated ? `Last synced: ${dayjs(j.updated).format('DD MMM YYYY, HH:mm')}` : '';

    all = Array.isArray(j.items) ? j.items : [];

    // Normalize authors + home authors
    for (const p of all){
      if (!Array.isArray(p.authors)) p.authors = deriveAuthors(p);
      p.home_authors = deriveHomeAuthors(p);
    }

    // Retraction links + SDGs
    buildRetractionIndex(all);
    for (const p of all) p.sdg_tags = guessSDGs(p);

    document.getElementById('kpiTotal').textContent = num(all.length);

    // Year options
    const years = [...new Set(all.map(x=>x.year).filter(y=>y!=null))].sort((a,b)=>a-b);
    const opts = (arr) => ['<option value="">All</option>'].concat(arr.map(y=>`<option value="${y}">${y}</option>`)).join('');
    document.getElementById('yearFrom').innerHTML = opts(years);
    document.getElementById('yearTo').innerHTML   = opts(years);

    // SDG options + legend
    buildSDGOptions(); buildSDGLegend();

    // Types
    computeKnownTypes(); buildTypePanel();

    pageSize = parseInt(document.getElementById('pageSize').value,10) || 50;

    buildColumnsPanel();
    applyFilters(1);
  }catch(e){
    document.getElementById('lastSynced').textContent = 'Error: '+e.message;
    console.error(e);
  }
}

/* ---------- Authors helpers ---------- */
function deriveAuthors(p){
  const out=[];
  if (Array.isArray(p.authorships)){
    for (const a of p.authorships){
      const nm = a?.author?.display_name || a?.display_name;
      if (nm) out.push(String(nm));
    }
  }
  if (!out.length && typeof p.authors === 'string' && p.authors.trim()){
    return p.authors.split(/[,;]\s*/).filter(Boolean);
  }
  return out;
}
function deriveHomeAuthors(p){
  const out=[];
  if (!Array.isArray(p.authorships)) return out;
  for (const a of p.authorships){
    const nm = a?.author?.display_name || a?.display_name;
    const insts = Array.isArray(a?.institutions) ? a.institutions : [];
    const matchROR = insts.some(i => (i?.ror||'').split('/').pop() === HOME_ROR);
    const matchKW  = insts.some(i => HOME_KEYWORDS.some(k => (i?.display_name||'').toLowerCase().includes(k)));
    if (nm && (matchROR || matchKW)) out.push(String(nm));
  }
  return [...new Set(out)];
}

/* ---------- Retractions ---------- */
const RETRACT_PREFIXES = [
  /^retraction\s*note\s*:/i,/^retraction\s*of\s*:/i,/^retraction\s*:/i,/^notice\s+of\s+retraction\s*:/i,/^withdrawn\s*:/i,
  /^retracted\s+paper\s*:/i,/^retracted\s+article\s*:/i,/^article\s+retracted\s*:/i
];
const DOI_REGEX = /\b(10\.\d{4,9}\/\S+)\b/i;
function buildRetractionIndex(items){
  const byTitle = new Map(), byDOI = new Map();
  for (const p of items){
    if (p.doi) byDOI.set(String(p.doi).toLowerCase(), p);
    const nt = normTitle(p.title||''); if (nt) byTitle.set(nt, p);
  }
  for (const p of items){
    const title = p.title || '';
    p.retraction_notice = isRetractionNotice(title);
    p.retracted_by = null; p.retraction_of = null;
    if (p.retraction_notice){
      const m = title.match(DOI_REGEX);
      if (m){
        const target = byDOI.get(m[1].toLowerCase());
        if (target){ p.retraction_of = { doi: target.doi, title: target.title }; target.retracted_by = { doi: p.doi, title: p.title }; }
      } else {
        const stripped = stripRetractionPrefix(title);
        const candidate = byTitle.get(normTitle(stripped));
        if (candidate){ p.retraction_of = { doi: candidate.doi, title: candidate.title }; candidate.retracted_by = { doi: p.doi, title: p.title }; }
      }
    }
  }
}
const isRetractionNotice = title => RETRACT_PREFIXES.some(rx => rx.test(String(title||'')));
const stripRetractionPrefix = title => { let t=String(title||''); for (const rx of RETRACT_PREFIXES){ if (rx.test(t)) return t.replace(rx,'').trim(); } return t; };

/* ---------- SDGs ---------- */
const SDG_LIST = [
  { id:1,  name:'No Poverty', kw:['poverty','low-income','income inequality'] },
  { id:2,  name:'Zero Hunger', kw:['hunger','food security','malnutrition','agriculture','crop','farm'] },
  { id:3,  name:'Good Health & Well-being', kw:['health','disease','medicine','mental','epidemic','pandemic','hospital','clinical'] },
  { id:4,  name:'Quality Education', kw:['education','school','teaching','learning','curriculum','literacy','students'] },
  { id:5,  name:'Gender Equality', kw:['gender','women','female','girls','violence against women','equality'] },
  { id:6,  name:'Clean Water & Sanitation', kw:['water','sanitation','wastewater','drinking water','hygiene'] },
  { id:7,  name:'Affordable & Clean Energy', kw:['energy','renewable','solar','wind','battery','hydrogen'] },
  { id:8,  name:'Decent Work & Economic Growth', kw:['employment','workforce','productivity','economy','growth','entrepreneur'] },
  { id:9,  name:'Industry, Innovation & Infrastructure', kw:['industry','manufacturing','infrastructure','innovation','iot','robotics','blockchain'] },
  { id:10, name:'Reduced Inequalities', kw:['inequality','social justice','marginalized','inclusion'] },
  { id:11, name:'Sustainable Cities & Communities', kw:['urban','smart city','transport','housing','resilience','disaster'] },
  { id:12, name:'Responsible Consumption & Production', kw:['circular economy','sustainability','recycling','waste','lifecycle','supply chain'] },
  { id:13, name:'Climate Action', kw:['climate','carbon','ghg','emission','adaptation','mitigation','global warming'] },
  { id:14, name:'Life Below Water', kw:['marine','ocean','sea','fisheries','aquatic','coral'] },
  { id:15, name:'Life on Land', kw:['biodiversity','forest','wildlife','ecosystem','soil','land use'] },
  { id:16, name:'Peace, Justice & Strong Institutions', kw:['governance','policy','corruption','crime','justice','conflict'] },
  { id:17, name:'Partnerships for the Goals', kw:['partnership','collaboration','sdg','stakeholder','international'] },
];
const SDG_COLORS = {1:'#E5243B',2:'#DDA63A',3:'#4C9F38',4:'#C5192D',5:'#FF3A21',6:'#26BDE2',7:'#FCC30B',8:'#A21942',
                    9:'#FD6925',10:'#DD1367',11:'#FD9D24',12:'#BF8B2E',13:'#3F7E44',14:'#0A97D9',15:'#56C02B',16:'#00689D',17:'#19486A'};

function buildSDGOptions(){
  const opts = SDG_LIST.map(s=>`<option value="${s.id}">${s.id}. ${s.name}</option>`).join('');
  const sel1 = document.getElementById('sdgFilter');
  const sel2 = document.getElementById('sdgOnlyFilter');
  if (sel1) sel1.innerHTML = '<option value="">All SDGs</option>' + opts;
  if (sel2) sel2.innerHTML = '<option value="">All SDGs</option>' + opts;
}
function guessSDGs(p){
  const text = [(p.title||''),(p.journal||''),extractSubjects(p)].join(' ').toLowerCase();
  const hits=[]; for (const s of SDG_LIST){ for (const kw of s.kw){ if (text.includes(kw.toLowerCase())){ hits.push(s.id); break; } } }
  return Array.from(new Set(hits)).slice(0,2);
}
function buildSDGLegend(){
  const box=document.getElementById('sdgLegend'); if(!box) return; box.innerHTML='';
  for (const s of SDG_LIST){
    box.insertAdjacentHTML('beforeend', `<span class="badge" title="${s.name}" style="border-color:${SDG_COLORS[s.id]};background:#fff">${s.id} — ${s.name}</span>`);
  }
}

/* ---------- Types ---------- */
const normalizeType = t => {
  const s=String(t||'').toLowerCase();
  if (s==='journal-article') return 'article';
  if (s.includes('proceed')) return 'proceedings-article';
  if (s.startsWith('book'))  return 'book';
  return s || 'unknown';
};
const labelForType = key => ({
  'article':'Article','proceedings-article':'Proceedings','book':'Book/Chapter','dataset':'Dataset','report':'Report',
  'preprint':'Preprint','letter':'Letter','review':'Review','editorial':'Editorial','unknown':'Other'
}[key] || key.replace(/(^|\-)(\w)/g,(m,_,c)=>' '+c.toUpperCase()).trim());

function computeKnownTypes(){
  const counts=new Map();
  for (const p of all){ const k=normalizeType(p.type || p.type_crossref); counts.set(k,(counts.get(k)||0)+1); }
  knownTypes = [...counts.entries()].sort((a,b)=>b[1]-a[1]).map(([key,count])=>({key,label:labelForType(key),count}));
}
function buildTypePanel(){
  const list=document.getElementById('typeList'); if (!list) return;
  list.innerHTML='';
  for (const t of knownTypes){
    const id='type_'+t.key.replace(/\W/g,'_');
    const checked = selectedTypes.has(t.key) ? 'checked' : '';
    list.insertAdjacentHTML('beforeend', `
      <label class="flex items-center gap-2">
        <input type="checkbox" id="${id}" ${checked}/>
        <span>${t.label} <span class="text-xs text-slate-400">(${num(t.count)})</span></span>
      </label>
    `);
  }
  updateTypeBtnLabel();
}
function toggleTypePanel(){ document.getElementById('typePanel').classList.toggle('hidden'); }
function applyTypeSelection(){
  selectedTypes.clear();
  for (const t of knownTypes){
    const id='type_'+t.key.replace(/\W/g,'_');
    const el=document.getElementById(id); if (el && el.checked) selectedTypes.add(t.key);
  }
  updateTypeBtnLabel(); toggleTypePanel(); applyFilters(1);
}
function clearTypeSelection(){ selectedTypes.clear(); buildTypePanel(); applyFilters(1); }
const updateTypeBtnLabel = () => document.getElementById('typeBtnLabel').textContent = selectedTypes.size ? `${selectedTypes.size} selected` : 'All types';

/* ---------- Filters / search / paging ---------- */
function applyFilters(goToPage=1){
  const q = (document.getElementById('searchBox')?.value || '').toLowerCase().trim();
  const yearFrom = document.getElementById('yearFrom')?.value || '';
  const yearTo   = document.getElementById('yearTo')?.value || '';
  const sdg = document.getElementById('sdgFilter')?.value || document.getElementById('sdgOnlyFilter')?.value || '';
  const retractMode = document.getElementById('retractionFilter')?.value || '';

  let yFrom = yearFrom ? parseInt(yearFrom,10) : null;
  let yTo   = yearTo   ? parseInt(yearTo,10)   : null;
  if (yFrom && yTo && yFrom > yTo){ const t=yFrom; yFrom=yTo; yTo=t; document.getElementById('yearFrom').value=yFrom; document.getElementById('yearTo').value=yTo; }

  filtered = all.filter(p=>{
    const y = p.year ?? null;
    if (yFrom && (y==null || y < yFrom)) return false;
    if (yTo   && (y==null || y > yTo))   return false;

    if (selectedTypes.size){
      const k = normalizeType(p.type || p.type_crossref);
      if (!selectedTypes.has(k)) return false;
    }

    if (sdg && !(p.sdg_tags||[]).includes(Number(sdg))) return false;

    if (retractMode === 'exclude'){ if (p.is_retracted || p.retraction_notice) return false; }
    else if (retractMode === 'only_retracted'){ if (!p.is_retracted) return false; }
    else if (retractMode === 'only_notices'){ if (!p.retraction_notice) return false; }

    if (q){
      const hay = [p.title||'',p.journal||'',p.doi||'',
                   ...(Array.isArray(p.home_authors)?p.home_authors:deriveHomeAuthors(p)),
                   ...(Array.isArray(p.authors)?p.authors:deriveAuthors(p))].join(' ').toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  if (haveSJR){ for (const p of filtered) p.quartile = resolveQuartile(p); }

  document.getElementById('kpiView').textContent = num(filtered.length);
  document.getElementById('kpiRetr').textContent = num(filtered.filter(x=>x.is_retracted || x.retraction_notice).length);
  document.getElementById('kpiQMap').textContent = num(filtered.filter(x=>quartileOf(x)).length);

  const journals = new Set(filtered.map(x=>(x.journal||'').trim()).filter(Boolean));
  document.getElementById('kpiJournals').textContent = num(journals.size);

  if (goToPage===1) currentPage = 1;
  renderTable();
  renderOverviewCharts();
  renderSDGChart();
  updateCoverage();
}

function changePageSize(){ pageSize = parseInt(document.getElementById('pageSize').value,10) || 50; currentPage=1; renderTable(); }
const totalPages = () => Math.max(1, Math.ceil(filtered.length/pageSize));
function goFirst(){ currentPage = 1; renderTable(); }
function goPrev(){ if (currentPage>1) currentPage--; renderTable(); }
function goNext(){ if (currentPage<totalPages()) currentPage++; renderTable(); }
function goLast(){ currentPage = totalPages(); renderTable(); }

/* ---------- Table ---------- */
function renderTable(){
  const head=document.getElementById('pubHeadRow'); head.innerHTML='';
  for (const col of selectedColumns){ const th=document.createElement('th'); th.className='text-left px-4 py-2'; th.textContent=col.label; head.appendChild(th); }

  const start=(currentPage-1)*pageSize, end=Math.min(start+pageSize, filtered.length);
  const rows=filtered.slice(start,end);

  const body=document.getElementById('pubBody'); body.innerHTML='';
  for (const p of rows){
    if (!Array.isArray(p.authors)) p.authors = deriveAuthors(p);
    if (!Array.isArray(p.home_authors)) p.home_authors = deriveHomeAuthors(p);
    const tds = selectedColumns.map(col=>`<td class="px-4 py-2 align-top">${renderCell(col.key,p)}</td>`).join('');
    const tr=document.createElement('tr'); tr.className='border-b border-slate-100 hover:bg-slate-50'; tr.innerHTML=tds; body.appendChild(tr);
  }

  document.getElementById('pageInfo').textContent = `Page ${currentPage} / ${totalPages()}`;
  document.getElementById('countInfo').textContent = filtered.length
    ? `Showing ${num(start+1)}–${num(end)} of ${num(filtered.length)} (filtered)` : `Showing 0 of 0`;
  document.getElementById('rangeText').textContent = document.getElementById('countInfo').textContent;
}
function renderCell(key,p){
  switch(key){
    case 'year': return p.year ?? '';
    case 'title': return p.url ? `<a class="text-indigo-600 hover:underline" href="${p.url}" target="_blank">${esc(p.title||'')}</a>` : esc(p.title||'');
    case 'journal': return esc(p.journal||'');
    case 'authors': return esc((Array.isArray(p.authors)?p.authors:deriveAuthors(p)).join(', '));
    case 'home_authors': {
      const a = Array.isArray(p.home_authors)?p.home_authors:deriveHomeAuthors(p);
      return a.length ? `<span class="text-slate-800">${esc(a.join(', '))}</span>` : '<span class="text-slate-400">—</span>';
    }
    case 'citations': return p.citations ?? 0;
    case 'quartile': return esc(p.quartile || '');
    case 'retraction_info': return renderRetractionInfo(p);
    case 'is_retracted': return p.is_retracted ? '<span class="badge" style="border-color:#ef4444;background:#fff;color:#b91c1c">Yes</span>' : 'No';
    case 'type': return esc(labelForType(normalizeType(p.type || p.type_crossref)));
    case 'doi': return esc(p.doi || '');
    case 'url': return p.url ? `<a class="text-indigo-600" href="${p.url}" target="_blank">Open</a>` : '';
    case 'issns': return esc((p.issns||[]).join(', '));
    case 'subjects': return esc(extractSubjects(p));
    case 'sdg_tags': return renderSDGBadges(p.sdg_tags||[]);
    default: return '';
  }
}

/* ---------- Columns chooser ---------- */
function buildColumnsPanel(){
  const container=document.getElementById('columnsList'); container.innerHTML='';
  const selectedKeys=new Set(selectedColumns.map(c=>c.key));
  for (const col of ALL_COLUMNS){
    const id=`col_${col.key}`, checked=selectedKeys.has(col.key)?'checked':'';
    container.insertAdjacentHTML('beforeend', `
      <label class="flex items-center gap-2"><input type="checkbox" id="${id}" ${checked}/><span>${col.label}</span></label>
    `);
  }
}
const toggleColumnsPanel = () => document.getElementById('columnsPanel').classList.toggle('hidden');
function applyColumnSelection(){
  const chosen=[]; for (const col of ALL_COLUMNS){ const box=document.getElementById(`col_${col.key}`); if (box && box.checked) chosen.push({key:col.key,label:col.label}); }
  selectedColumns = chosen.length ? chosen : ALL_COLUMNS.filter(c=>c.default).map(c=>({key:c.key,label:c.label}));
  saveSelectedColumns(); toggleColumnsPanel(); renderTable();
}
function resetColumns(){
  selectedColumns = ALL_COLUMNS.filter(c=>c.default).map(c=>({key:c.key,label:c.label}));
  saveSelectedColumns(); buildColumnsPanel(); renderTable();
}
function saveSelectedColumns(){ try{ localStorage.setItem('pub_columns', JSON.stringify(selectedColumns)); }catch{} }
function loadSelectedColumns(){
  try{
    const s=localStorage.getItem('pub_columns'); if (s){
      const arr=JSON.parse(s); const valid=new Map(ALL_COLUMNS.map(c=>[c.key,c.label]));
      return arr.filter(x=>valid.has(x.key)).map(x=>({key:x.key,label:valid.get(x.key)}));
    }
  }catch{}
  return ALL_COLUMNS.filter(c=>c.default).map(c=>({key:c.key,label:c.label}));
}

/* ---------- Charts ---------- */
function renderOverviewCharts(){
  // Publications by Year (bar + cumulative line)
  const ctxY = document.getElementById('chartByYear').getContext('2d');
  const byYear={}; for (const p of filtered){ if (p.year) byYear[p.year]=(byYear[p.year]||0)+1; }
  const labelsY = Object.keys(byYear).sort((a,b)=>a-b);
  const dataY   = labelsY.map(y=>byYear[y]);
  const cumY    = dataY.reduce((acc,v,i)=>{ acc.push((acc[i-1]||0)+v); return acc; },[]);
  if (chartByYear) chartByYear.destroy();
  chartByYear = new Chart(ctxY, {
    type:'bar',
    data:{ labels:labelsY, datasets:[
      { label:'Publications', data:dataY, borderRadius:12, borderSkipped:false, backgroundColor:'#8b5cf6' },
      { label:'Cumulative', type:'line', data:cumY, yAxisID:'y1', borderColor:clr.gray, tension:.25, pointRadius:2 }
    ] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{position:'top'}, shadowPlugin:{}, tooltip:{mode:'index', intersect:false} },
      scales:{
        x:{ grid:{ display:false }, ticks:{ color:'#334155' } },
        y:{ grid:{ color:'#e2e8f0' }, ticks:{ color:'#334155' }, beginAtZero:true },
        y1:{ position:'right', grid:{ drawOnChartArea:false }, ticks:{ color:'#334155' }, beginAtZero:true }
      }
    }
  });

  // IF-related + matrices
  renderIFAndMatrices();

  // Types by Year
  renderTypesYear();

  // Subjects
  renderSubjects();

  // Home authors
  renderHomeAuthors();

  // Retractions over time
  renderRetract();
}

/* ---- IF charts + matrices ---- */
function quartileOf(p){ return p.quartile || resolveQuartile(p) || ''; }
function resolveQuartile(p){
  const issns=(p.issns||[]).map(normIssn).filter(Boolean);
  for (const id of issns){ if (sjrByIssn.has(id)) return sjrByIssn.get(id); }
  const t=normTitle(p.journal||''); if (t && sjrByTitle.has(t)) return sjrByTitle.get(t);
  return '';
}
// IF-only helper (ignore SJR score)
function metricIFForJournal(journal, issnSet){
  let best=null;
  const add = (rec)=>{ if (!rec) return; const value = parseNum(rec.if); if (value && (!best || value>best.value)) best={value}; };
  if (issnSet){ for (const id of issnSet){ add(sjrMetaByIssn.get(id)); } }
  add(sjrMetaByTitle.get(normTitle(journal)));
  return best;
}

function renderIFAndMatrices(){
  // Aggregate by journal
  const byJournal = new Map(); // journal -> {issns:Set, count, cites}
  for (const p of filtered){
    const j=(p.journal||'').trim(); if (!j) continue;
    const o = byJournal.get(j) || {issns:new Set(), count:0, cites:0};
    (p.issns||[]).forEach(x=>o.issns.add(normIssn(x)));
    o.count++; o.cites += Number(p.citations||0);
    byJournal.set(j,o);
  }

  // Build rows with IF
  const rows=[];
  for (const [j,o] of byJournal.entries()){
    const meta = metricIFForJournal(j, o.issns);
    if (meta && meta.value>0) rows.push({journal:j, ifv:meta.value, count:o.count, cites:o.cites, quartile: (sjrByTitle.get(normTitle(j)) || '')});
  }
  IFcount = rows.length;
  document.getElementById('kpiIF').textContent = num(IFcount);

  /* ---- Top by IF (bar colored by quartile) ---- */
  const ctxTop = document.getElementById('chartIFTop').getContext('2d');
  if (chartIFTop) chartIFTop.destroy();
  const noteTop = document.getElementById('ifTopNote');
  if (!rows.length){
    noteTop.textContent = 'No IF data found in your uploaded file (try including an “Impact Factor / JIF” column).';
    setFocusEnabled('focusIFTop', false);
  }else{
    noteTop.textContent = 'Bars colored by quartile (Q1–Q4) when available.';
    const top = rows.sort((a,b)=>b.ifv-a.ifv).slice(0,12);
    const cfgTop = (ctx, isFocus=false)=>({
      type:'bar',
      data:{ labels:top.map(r=>r.journal),
             datasets:[{ label:'Impact Factor (IF)', data:top.map(r=>r.ifv),
                         borderRadius:12, borderSkipped:false,
                         backgroundColor: top.map(r => qColor(r.quartile)) }]},
      options:{
        indexAxis:'y', responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, shadowPlugin:{},
                  tooltip:{ callbacks:{ label: (cx)=> `IF: ${cx.parsed.x}${top[cx.dataIndex].quartile?` · ${top[cx.dataIndex].quartile}`:''}` } } },
        scales:{ x:{ beginAtZero:true, grid:{ color:'#e2e8f0' }, ticks:{ color:'#334155' } },
                 y:{ grid:{ display:false }, ticks:{ color:'#334155' } } }
      }
    });
    chartIFTop = new Chart(ctxTop, cfgTop(ctxTop));
    setFocusEnabled('focusIFTop', true, 'Journal Impact — Top by IF (from upload)', cfgTop);
  }

  /* ---- Top Journals — Total Citations (MATRIX) ----
     For top 12 journals by total publications: columns are citation ranges; cell value is number of papers in that range. */
  const ctxMat1 = document.getElementById('chartCitMatrix').getContext('2d');
  if (chartCitMatrix) chartCitMatrix.destroy();

  const ranges = [
    {label:'0', min:0, max:0},
    {label:'1–5', min:1, max:5},
    {label:'6–10', min:6, max:10},
    {label:'11–20', min:11, max:20},
    {label:'21–50', min:21, max:50},
    {label:'51–100', min:51, max:100},
    {label:'100+', min:101, max:Infinity},
  ];
  const topJ = [...byJournal.entries()].sort((a,b)=>b[1].count-a[1].count).slice(0,12).map(([j])=>j);

  // Build cell counts
  const cellCounts = new Map(); // key `${row}_${col}` -> count
  for (const p of filtered){
    const j=(p.journal||'').trim(); if (!j || !topJ.includes(j)) continue;
    const c = Number(p.citations||0);
    const col = ranges.findIndex(r => c>=r.min && c<=r.max);
    if (col<0) continue;
    const key = `${topJ.indexOf(j)}_${col}`;
    cellCounts.set(key, (cellCounts.get(key)||0) + 1);
  }
  const cells = [];
  for (let r=0;r<topJ.length;r++){
    for (let c=0;c<ranges.length;c++){
      const v = cellCounts.get(`${r}_${c}`) || 0;
      cells.push({x:c, y:r, v});
    }
  }
  const maxV = Math.max(1, ...cells.map(c=>c.v));
  const colorFor = v => `rgba(99,102,241,${0.15 + 0.85*(v/maxV)})`;

  const cfgMat1 = (ctx, isFocus=false)=>({
    type:'matrix',
    data:{
      datasets:[{
        label:'Counts',
        data:cells,
        backgroundColor: ctx => colorFor(ctx.raw.v),
        width: ({chart}) => (chart.chartArea?.width || 600) / (ranges.length+0.5),
        height: ({chart}) => (chart.chartArea?.height || 400) / (topJ.length+0.5),
        borderWidth:1, borderColor:'#fff'
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{
        callbacks:{ title:(it)=>{ const r=it[0].raw; return `${topJ[r.y]} · ${ranges[r.x].label}`; },
                    label:(it)=> `Publications: ${it.raw.v}` } } },
      scales:{
        x:{ type:'linear', min:-0.5, max:ranges.length-0.5, ticks:{ callback:(v)=>ranges[Number(v)]?.label||'', color:'#334155' }, grid:{display:false} },
        y:{ type:'linear', min:-0.5, max:topJ.length-0.5, ticks:{ callback:(v)=>topJ[Number(v)]||'', color:'#334155' }, grid:{display:false} }
      }
    }
  });
  chartCitMatrix = new Chart(ctxMat1, cfgMat1(ctxMat1));
  setFocusEnabled('focusCitMatrix', true, 'Top Journals — Total Citations (matrix)', cfgMat1);

  /* ---- IF × Publications (MATRIX) ----
     2D histogram: columns = IF bins, rows = publication-count bins. Cell value = number of journals in that bin. */
  const ctxMat2 = document.getElementById('chartIFMatrix').getContext('2d');
  if (chartIFMatrix) chartIFMatrix.destroy();
  const note2 = document.getElementById('ifBubNote');

  if (!rows.length){
    note2.textContent = 'No IF data found in your uploaded file.';
    setFocusEnabled('focusIFMatrix', false);
  }else{
    note2.textContent = '';
    const ifBins = [0,2,4,6,8,10,12,14,16,18,Infinity];
    const ifLbls = ['<2','2–4','4–6','6–8','8–10','10–12','12–14','14–16','16–18','18+'];
    const pubBins = [0,5,10,20,40,80,Infinity];
    const pubLbls = ['1–5','6–10','11–20','21–40','41–80','80+'];

    const cells2 = new Map(); // `${row}_${col}` -> count of journals
    for (const r of rows){
      const ix = ifBins.findIndex((b,i)=> r.ifv>=b && r.ifv<(ifBins[i+1]||Infinity));
      const iy = pubBins.findIndex((b,i)=> r.count>b && r.count<=(pubBins[i+1]||Infinity));
      const key = `${iy}_${ix}`;
      cells2.set(key, (cells2.get(key)||0)+1);
    }
    const data2=[]; for (let y=0;y<pubLbls.length;y++){ for (let x=0;x<ifLbls.length;x++){ const v=cells2.get(`${y}_${x}`)||0; data2.push({x,y,v}); } }
    const max2 = Math.max(1, ...data2.map(c=>c.v));
    const color2 = v => `rgba(20,184,166,${0.12 + 0.88*(v/max2)})`;

    const cfgMat2 = (ctx, isFocus=false)=>({
      type:'matrix',
      data:{ datasets:[{
        data:data2, backgroundColor: c=>color2(c.raw.v), borderWidth:1, borderColor:'#fff',
        width: ({chart}) => (chart.chartArea?.width || 600) / (ifLbls.length+0.5),
        height: ({chart}) => (chart.chartArea?.height || 400) / (pubLbls.length+0.5),
      }]},
      options:{
        responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{
          callbacks:{ title:(it)=>{ const r=it[0].raw; return `IF ${ifLbls[r.x]} · Pubs ${pubLbls[r.y]}`; },
                      label:(it)=> `Journals: ${it.raw.v}` } } },
        scales:{
          x:{ type:'linear', min:-0.5, max:ifLbls.length-0.5, ticks:{ callback:(v)=>ifLbls[Number(v)]||'', color:'#334155' }, grid:{display:false} },
          y:{ type:'linear', reverse:true, min:-0.5, max:pubLbls.length-0.5, ticks:{ callback:(v)=>pubLbls[Number(v)]||'', color:'#334155' }, grid:{display:false} }
        }
      }
    });
    chartIFMatrix = new Chart(ctxMat2, cfgMat2(ctxMat2));
    setFocusEnabled('focusIFMatrix', true, 'Journal Impact — IF × Publications (matrix)', cfgMat2);
  }
}

/* ---- Remaining charts ---- */
function renderTypesYear(){
  const ctx = document.getElementById('chartTypesYear').getContext('2d');
  const map=new Map(); // year -> {type->count}
  const setTypes=new Set();
  for (const p of filtered){
    const y=p.year; if (y==null) continue;
    const t=normalizeType(p.type || p.type_crossref);
    setTypes.add(t);
    const row=map.get(y)||{}; row[t]=(row[t]||0)+1; map.set(y,row);
  }
  const years=[...map.keys()].sort((a,b)=>a-b);
  const types=[...setTypes];
  const datasets = types.map((t,i)=>({
    label:labelForType(t),
    data:years.map(y=> (map.get(y)||{})[t]||0 ),
    stack:'types',
    backgroundColor:`hsl(${(i*47)%360} 70% 55% / .85)`
  }));
  if (chartTypesYear) chartTypesYear.destroy();
  chartTypesYear = new Chart(ctx, {
    type:'bar',
    data:{ labels:years, datasets },
    options:{ responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{position:'top'}, shadowPlugin:{} },
      scales:{ x:{ stacked:true, grid:{display:false}, ticks:{color:'#334155'} }, y:{ stacked:true, beginAtZero:true, grid:{ color:'#e2e8f0' }, ticks:{color:'#334155'} } }
    }
  });
}

function renderSubjects(){
  const ctx = document.getElementById('chartSubjects').getContext('2d');
  const counts=new Map();
  for (const p of filtered){
    const subjects = extractSubjectsList(p);
    for (const s of subjects){ counts.set(s,(counts.get(s)||0)+1); }
  }
  const top=[...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);
  if (chartSubjects) chartSubjects.destroy();
  chartSubjects = new Chart(ctx, {
    type:'bar',
    data:{ labels: top.map(x=>x[0]), datasets:[{label:'Count', data:top.map(x=>x[1]), borderRadius:12, borderSkipped:false, backgroundColor:'#8b5cf6'}]},
    options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, shadowPlugin:{} },
      scales:{ x:{ grid:{ color:'#e2e8f0' }, ticks:{color:'#334155'}, beginAtZero:true }, y:{ grid:{ display:false }, ticks:{color:'#334155'} } }
    }
  });
}

function renderHomeAuthors(){
  const ctx = document.getElementById('chartHomeAuthors').getContext('2d');
  const counts=new Map();
  for (const p of filtered){
    const arr = Array.isArray(p.home_authors)?p.home_authors:deriveHomeAuthors(p);
    for (const a of arr){ counts.set(a,(counts.get(a)||0)+1); }
  }
  const top=[...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,15);
  if (chartHomeAuthors) chartHomeAuthors.destroy();
  chartHomeAuthors = new Chart(ctx, {
    type:'bar',
    data:{ labels: top.map(x=>x[0]), datasets:[{label:'Pubs', data:top.map(x=>x[1]), borderRadius:12, borderSkipped:false, backgroundColor:'#14b8a6'}]},
    options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, shadowPlugin:{} },
      scales:{ x:{ grid:{ color:'#e2e8f0' }, ticks:{color:'#334155'}, beginAtZero:true }, y:{ grid:{ display:false }, ticks:{color:'#334155'} } }
    }
  });
}

function renderRetract(){
  const ctx = document.getElementById('chartRetract').getContext('2d');
  const byYearFlag=new Map(), byYearNotice=new Map();
  for (const p of filtered){
    if (!p.year) continue;
    if (p.is_retracted) byYearFlag.set(p.year,(byYearFlag.get(p.year)||0)+1);
    if (p.retraction_notice) byYearNotice.set(p.year,(byYearNotice.get(p.year)||0)+1);
  }
  const years=[...new Set([...byYearFlag.keys(),...byYearNotice.keys()])].sort((a,b)=>a-b);
  if (chartRetract) chartRetract.destroy();
  chartRetract = new Chart(ctx, {
    type:'line',
    data:{ labels:years, datasets:[
      { label:'OpenAlex retracted', data:years.map(y=>byYearFlag.get(y)||0), borderColor:clr.q4, tension:.25, pointRadius:2 },
      { label:'Retraction notices (title)', data:years.map(y=>byYearNotice.get(y)||0), borderColor:clr.q3, tension:.25, pointRadius:2 }
    ]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'top'}, shadowPlugin:{} },
      scales:{ x:{ grid:{ display:false }, ticks:{color:'#334155'} }, y:{ beginAtZero:true, grid:{ color:'#e2e8f0' }, ticks:{color:'#334155'} } }
    }
  });
}

/* ---------- SDG chart ---------- */
let chartSDG=null;
function renderSDGChart(){
  const el = document.getElementById('chartSDG'); if (!el) return;
  const ctx = el.getContext('2d');
  const counts = new Array(18).fill(0);
  for (const p of filtered){ for (const id of (p.sdg_tags||[])) counts[id]++; }
  if (chartSDG) chartSDG.destroy();
  const labels = SDG_LIST.map(s=>`${s.id}`), data = SDG_LIST.map(s=>counts[s.id]||0), colors = SDG_LIST.map(s=>SDG_COLORS[s.id]);
  chartSDG = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{ label:'Count', data, borderRadius:12, borderSkipped:false, backgroundColor:colors }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, shadowPlugin:{}, tooltip:{mode:'index', intersect:false} },
      scales:{ x:{ grid:{ display:false }, ticks:{ color:'#334155' } }, y:{ grid:{ color:'#e2e8f0' }, ticks:{ color:'#334155' }, beginAtZero:true } }
    }
  });
}
function renderSDGBadges(ids){ if (!ids.length) return ''; return ids.map(id=>`<span class="badge" style="border-color:${SDG_COLORS[id]};background:#fff">${id}</span>`).join(' '); }

/* ---------- Export helpers ---------- */
function exportCSV(){
  if (!filtered.length) return;
  const fileSuffix = buildRangeSuffix();
  const header = selectedColumns.map(c=>c.label);
  const csv = [header.join(',')].concat(
    filtered.map(r => selectedColumns.map(c => q(textForExport(c.key, r))).join(','))
  ).join('\n');
  downloadBlob(`publications_${fileSuffix}.csv`, csv, 'text/csv');
}
function exportJSON(){
  if (!filtered.length) return;
  const fileSuffix = buildRangeSuffix();
  const rows = filtered.map(r=>{
    const obj={}; for (const c of selectedColumns){ obj[c.key] = rawForExport(c.key, r); } return obj;
  });
  downloadBlob(`publications_${fileSuffix}.json`, JSON.stringify(rows,null,2), 'application/json');
}
function buildRangeSuffix(){
  const y1 = document.getElementById('yearFrom')?.value || '';
  const y2 = document.getElementById('yearTo')?.value   || '';
  if (y1 && y2) return `${y1}-${y2}`;
  if (y1 && !y2) return `${y1}-and-newer`;
  if (!y1 && y2) return `up-to-${y2}`;
  return 'all-years';
}
function textForExport(key,p){
  switch(key){
    case 'authors': return (Array.isArray(p.authors)?p.authors:deriveAuthors(p)).join('; ');
    case 'home_authors': return (Array.isArray(p.home_authors)?p.home_authors:deriveHomeAuthors(p)).join('; ');
    case 'issns':   return (p.issns||[]).join('; ');
    case 'subjects':return extractSubjects(p);
    case 'sdg_tags':return (p.sdg_tags||[]).join('; ');
    case 'retraction_info': return stripHtml(renderRetractionInfo(p));
    case 'is_retracted': return p.is_retracted ? 'Yes' : 'No';
    case 'type': return labelForType(normalizeType(p.type || p.type_crossref));
    default: return rawForExport(key, p) ?? '';
  }
}
function rawForExport(key,p){
  if (key==='subjects') return extractSubjects(p);
  if (key==='retraction_info') return stripHtml(renderRetractionInfo(p));
  if (key==='authors') return Array.isArray(p.authors)?p.authors:deriveAuthors(p);
  if (key==='home_authors') return Array.isArray(p.home_authors)?p.home_authors:deriveHomeAuthors(p);
  if (key==='type') return labelForType(normalizeType(p.type || p.type_crossref));
  return p[key];
}
function downloadBlob(name, content, type) { const blob=new Blob([content],{type}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

/* ---------- Misc utils ---------- */
function extractSubjects(p){
  if (Array.isArray(p.subjects) && p.subjects.length) return p.subjects.slice(0,3).join(', ');
  if (Array.isArray(p.concepts) && p.concepts.length){
    const arr = p.concepts.map(c=>c.display_name||c.name||'').filter(Boolean).slice(0,3); return arr.join(', ');
  }
  return '';
}
function extractSubjectsList(p){
  if (Array.isArray(p.subjects) && p.subjects.length) return p.subjects.slice(0,1);
  if (Array.isArray(p.concepts) && p.concepts.length) return p.concepts.map(c=>c.display_name||c.name||'').filter(Boolean).slice(0,1);
  return [];
}
const q = s => `"${String(s).replace(/"/g,'""')}"`;
function stripHtml(html){ const d=document.createElement('div'); d.innerHTML=html; return d.textContent||d.innerText||''; }
function smartSplit(line,delim){ const out=[]; let cur=''; let inQ=false; for (let i=0;i<line.length;i++){ const ch=line[i]; if (ch==='\"'){ inQ=!inQ; continue; } if (ch===delim && !inQ){ out.push(cur.trim()); cur=''; continue; } cur+=ch; } out.push(cur.trim()); return out; }
function findIndex(arr,pred){ for (let i=0;i<arr.length;i++){ if (pred(arr[i])) return i; } return -1; }
function extractIssns(cell){ return [...new Set(String(cell||'').split(/[\/,;|\s]+/).map(normIssn).filter(Boolean))]; }

/* ---------- Retraction info rendering ---------- */
function renderRetractionInfo(p){
  const parts=[];
  if (p.retraction_notice){
    parts.push('<span class="badge" style="border-color:#ef4444;background:#fff;color:#b91c1c">Retraction notice</span>');
    if (p.retraction_of){
      const t = esc(p.retraction_of.title || '');
      const d = p.retraction_of.doi ? `<a href="https://doi.org/${p.retraction_of.doi}" target="_blank">${esc(p.retraction_of.doi)}</a>` : '';
      parts.push(`<div class="text-xs text-slate-600 mt-1">of: ${t} ${d}</div>`);
    }
  }
  if (p.is_retracted){
    parts.push('<span class="badge" style="border-color:#ef4444;background:#fff;color:#b91c1c">Retracted (OpenAlex)</span>');
    if (p.retracted_by){
      const t = esc(p.retracted_by.title || '');
      const d = p.retracted_by.doi ? `<a href="https://doi.org/${p.retracted_by.doi}" target="_blank">${esc(p.retracted_by.doi)}</a>` : '';
      parts.push(`<div class="text-xs text-slate-600 mt-1">by: ${t} ${d}</div>`);
    }
  }
  return parts.join(' ') || '';
}

/* ---------- Quartiles & IF upload ---------- */
document.getElementById('sjrFile').addEventListener('change', async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  const name=file.name.toLowerCase(); const text=await file.text();
  sjrByIssn.clear(); sjrByTitle.clear(); sjrMetaByIssn.clear(); sjrMetaByTitle.clear(); haveSJR=false; IFcount=0;
  try{
    if (name.endsWith('.json')) {
      const arr=JSON.parse(text); for (const row of arr) addQuartileRow(row);
    } else if (name.endsWith('.csv')){
      parseCSV(text, addQuartileRow);
    } else { throw new Error('Unsupported file type'); }
    haveSJR = (sjrByIssn.size + sjrByTitle.size) > 0;
    // Count IF entries
    const setIF = new Set([...sjrMetaByIssn.values(), ...sjrMetaByTitle.values()].map(v=>parseNum(v.if)).filter(Boolean));
    IFcount = setIF.size || 0;
    document.getElementById('sjrStatus').textContent = `Loaded ${sjrByIssn.size} ISSN entries and ${sjrByTitle.size} title entries · IF entries detected: ${num(IFcount)}`;
    applyFilters();
    updateCoverage();
  }catch(err){
    document.getElementById('sjrStatus').textContent = 'Failed: ' + err.message;
  }
});

/* addQuartileRow + parseCSV */
function addQuartileRow(row){
  const q = normQuartile(
    row.quartile || row['SJR Best Quartile'] || row['Best Quartile'] || row['JIF Quartile'] || row.Quarter || row.Q || row.q || ''
  );
  const title = normTitle(row.title || row.Title || row['Source title'] || row.Journal || '');
  const issnCell = row.issn || row.ISSN || row['ISSN / e-ISSN'] || row['ISSN print'] || row['ISSN (print)'] || row['ISSN/eISSN'] || '';
  const issns = extractIssns(issnCell);

  const IFval = row['Impact Factor'] || row['Impact factor'] || row['ImpactFactor'] || row['JCR Impact Factor'] ||
                row['JCR IF'] || row['JIF'] || row['IF'] || row['2-year Impact Factor'] ||
                row['Impact Factor (2023)'] || row['Impact Factor (2024)'] || row['Impact Factor (latest)'] || row.IF || '';
  const jif = parseNum(IFval);
  const meta = { q, if: (jif ?? null) };

  if (q){ if (issns.length){ for (const id of issns) sjrByIssn.set(id, q); } if (title) sjrByTitle.set(title, q); }
  if (issns.length){ for (const id of issns) sjrMetaByIssn.set(id, meta); }
  if (title) sjrMetaByTitle.set(title, meta);
}
function parseCSV(text, onRow){
  const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
  if (!lines.length) throw new Error('Empty CSV');

  const hdrRaw = lines.shift();
  const delim = (hdrRaw.match(/;/g)||[]).length > (hdrRaw.match(/,/g)||[]).length ? ';' : ',';
  const header = smartSplit(hdrRaw, delim).map(h => h.trim());

  const idxTitle = findIndex(header, h => /^(title|journal|source\s*title)$/i.test(h));
  const idxIssn  = findIndex(header, h => /issn/i.test(h));
  const idxQuart = findIndex(header, h => /(quartile|best\s*quartile|sjr\s*best\s*quartile|^q$|jif\s*quartile)/i.test(h));

  let idxIF = -1;
  for (let i = 0; i < header.length; i++){
    const hl = header[i].toLowerCase();
    if (/(impact).*(factor)/.test(hl) || /(factor).*(impact)/.test(hl)) { idxIF = i; break; }
    if (/\bjcr\b.*impact.*factor/.test(hl)) { idxIF = i; break; }
    if (/\bjif\b/.test(hl)) { idxIF = i; break; }
    if (/^if$/.test(hl)) { idxIF = i; break; }
  }

  if (idxQuart < 0 && idxTitle < 0 && idxIssn < 0 && idxIF < 0) {
    throw new Error('Cannot find Title/ISSN/Quartile/IF columns');
  }

  for (const line of lines){
    const cols = smartSplit(line, delim);
    onRow({
      title: idxTitle >= 0 ? cols[idxTitle] : '',
      issn:  idxIssn  >= 0 ? cols[idxIssn]  : '',
      quartile: idxQuart >= 0 ? cols[idxQuart] : '',
      'Impact Factor': idxIF >= 0 ? cols[idxIF] : ''
    });
  }
}

/* ---------- Coverage ---------- */
function updateCoverage(){
  let mapped=0,total=filtered.length; for (const p of filtered) if (quartileOf(p)) mapped++;
  const pct= total? Math.round(mapped*100/total):0;
  const el=document.getElementById('mapCoverage'); if (el) el.textContent = `${mapped} / ${total} in current view mapped (${pct}%)`;
}

/* ---------- SDG helpers ---------- */
function renderSDGBadges(ids){
  if (!ids.length) return '';
  return ids.map(id=>`<span class="badge" style="border-color:${SDG_COLORS[id]};background:#fff">${id}</span>`).join(' ');
}

/* ---------- Retraction info export helpers ---------- */
function renderRetractionInfoExport(p){ return stripHtml(renderRetractionInfo(p)); }

/* ---------- Open UI behaviors ---------- */
// Close dropdowns on outside click
document.addEventListener('click', (e)=>{
  const panels=[['columnsPanel','colBtn'],['typePanel','typeBtn']];
  for (const [pid,bid] of panels){
    const panel=document.getElementById(pid); const btn=document.getElementById(bid);
    if (!panel || panel.classList.contains('hidden')) continue;
    if (!panel.contains(e.target) && !btn.contains(e.target)) panel.classList.add('hidden');
  }
});

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', ()=>{ buildSDGLegend(); autoLoad(); });
</script>
</body>
</html>
