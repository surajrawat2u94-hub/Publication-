<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Publication Data</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- Day.js + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .thin-scrollbar::-webkit-scrollbar{height:8px;width:8px}
    .thin-scrollbar::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:6px}
    .thin-scrollbar::-webkit-scrollbar-track{background:#F8FAFC}
    .tab-active{color:#111827;border-color:#6366F1;background:linear-gradient(180deg,#fff, #f8fafc)}
    .tab-inactive{color:#6B7280;border-color:transparent}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">

  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-indigo-600 text-white grid place-content-center">
          <i data-lucide="library"></i>
        </div>
        <div>
          <h1 class="text-lg font-semibold tracking-tight">Publication Data</h1>
          <div id="lastSynced" class="text-xs text-slate-500">Loading…</div>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-2 text-xs text-slate-500">
        <span class="px-2 py-1 rounded-lg border border-slate-200 bg-white">Static JSON · No live API</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="border-t border-slate-200 bg-white">
      <div class="max-w-7xl mx-auto px-4">
        <nav class="flex gap-2">
          <button id="tabOverview" class="px-4 py-3 text-sm border-b-2 tab-active" onclick="switchTab('overview')">
            Overview
          </button>
          <button id="tabPublications" class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('publications')">
            Publications
          </button>
          <button id="tabQuartiles" class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('quartiles')">
            Quartiles
          </button>
        </nav>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="max-w-7xl mx-auto px-4 py-6">

    <!-- OVERVIEW TAB -->
    <section id="view-overview" class="space-y-6">
      <!-- KPIs -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white border border-slate-200 rounded-2xl p-4">
          <div class="text-xs text-slate-500">Total items</div>
          <div id="kpiTotal" class="mt-1 text-2xl font-semibold">—</div>
        </div>
        <div class="bg-white border border-slate-200 rounded-2xl p-4">
          <div class="text-xs text-slate-500">Current view</div>
          <div id="kpiView" class="mt-1 text-2xl font-semibold">—</div>
        </div>
        <div class="bg-white border border-slate-200 rounded-2xl p-4">
          <div class="text-xs text-slate-500">Retracted (view)</div>
          <div id="kpiRetr" class="mt-1 text-2xl font-semibold">—</div>
        </div>
        <div class="bg-white border border-slate-200 rounded-2xl p-4">
          <div class="text-xs text-slate-500">Distinct journals (view)</div>
          <div id="kpiJournals" class="mt-1 text-2xl font-semibold">—</div>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="bg-white border border-slate-200 rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Publications by Year</h3>
            <span id="rangeText" class="text-xs text-slate-500"></span>
          </div>
          <div class="mt-2 h-[260px]">
            <canvas id="chartByYear"></canvas>
          </div>
        </div>
        <div class="bg-white border border-slate-200 rounded-2xl p-4">
          <h3 class="font-semibold">Top Journals (view)</h3>
          <div class="mt-2 h-[260px]">
            <canvas id="chartTopJournals"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- PUBLICATIONS TAB -->
    <section id="view-publications" class="hidden space-y-4">
      <!-- Controls -->
      <div class="bg-white border border-slate-200 rounded-2xl p-4">
        <div class="flex flex-wrap items-end gap-3">
          <div>
            <label class="block text-xs font-medium text-slate-600">Search</label>
            <input id="searchBox" class="px-3 py-2 rounded-xl border border-slate-300 text-sm"
                   placeholder="Title / author / journal" oninput="applyFilters(1)"/>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-600">Year</label>
            <select id="yearFilter" class="px-3 py-2 rounded-xl border border-slate-300 text-sm"
                    onchange="applyFilters(1)"><option value="">All years</option></select>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-600">Retraction</label>
            <select id="retractionFilter" class="px-3 py-2 rounded-xl border border-slate-300 text-sm"
                    onchange="applyFilters(1)">
              <option value="">All</option>
              <option value="exclude">Exclude retracted</option>
              <option value="only">Only retracted</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-600">Rows per page</label>
            <select id="pageSize" class="px-3 py-2 rounded-xl border border-slate-300 text-sm"
                    onchange="changePageSize()">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
          </div>
          <div class="ml-auto flex items-center gap-2">
            <button class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm" onclick="exportCSV()">Export CSV</button>
            <button class="px-3 py-2 rounded-xl bg-indigo-50 text-indigo-700 border border-indigo-200 text-sm"
                    onclick="exportJSON()">Export JSON</button>
          </div>
        </div>
      </div>

      <!-- Table + Pager -->
      <div class="bg-white border border-slate-200 rounded-2xl">
        <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
          <div class="font-semibold">All Publications</div>
          <div class="text-xs text-slate-500" id="countInfo"></div>
        </div>
        <div class="overflow-x-auto thin-scrollbar">
          <table class="w-full text-sm" id="pubTable">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="text-left px-4 py-2">Year</th>
                <th class="text-left px-4 py-2">Title</th>
                <th class="text-left px-4 py-2">Journal</th>
                <th class="text-left px-4 py-2">Authors</th>
                <th class="text-left px-4 py-2">Citations</th>
                <th class="text-left px-4 py-2">Quartile</th>
                <th class="text-left px-4 py-2">Retracted?</th>
              </tr>
            </thead>
            <tbody id="pubBody"></tbody>
          </table>
        </div>

        <div class="px-4 py-3 flex items-center justify-between">
          <div class="text-xs text-slate-500" id="pageInfo">Page 1 / 1</div>
          <div class="flex gap-2">
            <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goFirst()">« First</button>
            <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goPrev()">‹ Prev</button>
            <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goNext()">Next ›</button>
            <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goLast()">Last »</button>
          </div>
        </div>
      </div>
    </section>

    <!-- QUARTILES TAB -->
    <section id="view-quartiles" class="hidden space-y-4">
      <div class="bg-white border border-slate-200 rounded-2xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold">Quartile Mapping</h3>
            <p class="text-xs text-slate-500">
              Upload SJR quartiles as <code>.csv</code> (columns: Title, ISSN, Quartile) or <code>.json</code>
              (array of objects with <code>title</code>/<code>issn</code>/<code>quartile</code>).
            </p>
          </div>
          <div class="flex items-center gap-2">
            <input id="sjrFile" type="file" accept=".csv,.json" class="hidden" />
            <button class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-300 text-sm" onclick="document.getElementById('sjrFile').click()">
              <i data-lucide="upload"></i> Upload Quartiles
            </button>
          </div>
        </div>
        <div id="sjrStatus" class="mt-2 text-xs text-slate-500"></div>
      </div>

      <div class="bg-white border border-slate-200 rounded-2xl p-4">
        <h4 class="font-semibold mb-2">Coverage in current view</h4>
        <div class="text-sm" id="mapCoverage">—</div>
      </div>
    </section>

  </main>

  <footer class="text-center text-xs text-slate-500 pb-8">
    Data from <code>institution_data.json</code> · Quartiles are client-side mapped
  </footer>

<script>
  lucide.createIcons();

  // ---------- State ----------
  let all = [];            // all publications
  let filtered = [];       // after filters/search
  let currentPage = 1;
  let pageSize = 50;

  // Quartile mapping
  const sjrByIssn = new Map();   // ISSN -> Q
  const sjrByTitle = new Map();  // normalized title -> Q
  let haveSJR = false;

  // Charts
  let chartByYear = null;
  let chartTopJournals = null;

  // ---------- Tabs ----------
  function switchTab(name){
    const tabs = ["overview","publications","quartiles"];
    for (const t of tabs) {
      document.getElementById(`view-${t}`).classList.toggle('hidden', t!==name);
      document.getElementById(`tab${t[0].toUpperCase()+t.slice(1)}`).classList.toggle('tab-active', t===name);
      document.getElementById(`tab${t[0].toUpperCase()+t.slice(1)}`).classList.toggle('tab-inactive', t!==name);
    }
  }

  // ---------- Load data ----------
  async function autoLoad(){
    try{
      const res = await fetch('institution_data.json', { cache: 'no-store' });
      if(!res.ok) throw new Error('institution_data.json not found');
      const j = await res.json();

      // last synced
      document.getElementById('lastSynced').textContent =
        j.updated ? `Last synced: ${dayjs(j.updated).format('DD MMM YYYY, HH:mm')}` : '';

      all = Array.isArray(j.items) ? j.items : [];
      document.getElementById('kpiTotal').textContent = num(all.length);

      // Year filter options
      const years = [...new Set(all.map(x=>x.year).filter(Boolean))].sort((a,b)=>b-a);
      const ySel = document.getElementById('yearFilter');
      ySel.innerHTML = '<option value="">All years</option>' + years.map(y=>`<option>${y}</option>`).join('');

      // set page size from UI
      pageSize = parseInt(document.getElementById('pageSize').value, 10) || 50;

      // initial view
      applyFilters(1);
    }catch(e){
      document.getElementById('lastSynced').textContent = 'Error: '+e.message;
      console.error(e);
    }
  }

  // ---------- Filters, search, pagination ----------
  function applyFilters(goToPage=1){
    const q = (document.getElementById('searchBox')?.value || '').toLowerCase().trim();
    const year = document.getElementById('yearFilter')?.value || '';
    const retract = document.getElementById('retractionFilter')?.value || '';

    filtered = all.filter(p=>{
      if (year && String(p.year)!==year) return false;
      if (retract==='exclude' && p.is_retracted) return false;
      if (retract==='only' && !p.is_retracted) return false;
      if (q) {
        const hay = [
          p.title||'',
          p.journal||'',
          ...(p.authors||[])
        ].join(' ').toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });

    // attach quartiles where available
    if (haveSJR) {
      for (const p of filtered) {
        p.quartile = resolveQuartile(p);
      }
    }

    // KPIs
    document.getElementById('kpiView').textContent = num(filtered.length);
    document.getElementById('kpiRetr').textContent = num(filtered.filter(x=>x.is_retracted).length);
    const journals = new Set(filtered.map(x=>(x.journal||'').trim()).filter(Boolean));
    document.getElementById('kpiJournals').textContent = num(journals.size);

    if (goToPage===1) currentPage = 1;
    renderPage();
    renderOverviewCharts();
  }

  function changePageSize(){
    pageSize = parseInt(document.getElementById('pageSize').value,10) || 50;
    currentPage = 1;
    renderPage();
  }

  function totalPages(){ return Math.max(1, Math.ceil(filtered.length / pageSize)); }
  function goFirst(){ currentPage = 1; renderPage(); }
  function goPrev(){ if(currentPage>1) currentPage--; renderPage(); }
  function goNext(){ if(currentPage<totalPages()) currentPage++; renderPage(); }
  function goLast(){ currentPage = totalPages(); renderPage(); }

  function renderPage(){
    const start = (currentPage-1)*pageSize;
    const end = Math.min(start+pageSize, filtered.length);
    const rows = filtered.slice(start,end);

    const tbody = document.getElementById('pubBody');
    tbody.innerHTML = '';
    for (const p of rows) {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-slate-100 hover:bg-slate-50';
      tr.innerHTML = `
        <td class="px-4 py-2">${p.year ?? ''}</td>
        <td class="px-4 py-2">${p.url ? `<a class="text-indigo-600 hover:underline" href="${p.url}" target="_blank">${esc(p.title||'')}</a>` : esc(p.title||'')}</td>
        <td class="px-4 py-2">${esc(p.journal||'')}</td>
        <td class="px-4 py-2">${esc((p.authors||[]).join(', '))}</td>
        <td class="px-4 py-2">${p.citations ?? 0}</td>
        <td class="px-4 py-2">${esc(p.quartile||'')}</td>
        <td class="px-4 py-2">${p.is_retracted ? '<span class="px-2 py-0.5 rounded-md bg-rose-50 text-rose-700 border border-rose-200 text-xs">Yes</span>' : 'No'}</td>
      `;
      tbody.appendChild(tr);
    }

    const info = `Page ${currentPage} / ${totalPages()}`;
    document.getElementById('pageInfo').textContent = info;

    const rangeText = filtered.length
      ? `Showing ${num(start+1)}–${num(end)} of ${num(filtered.length)} (filtered)`
      : `Showing 0 of 0`;
    document.getElementById('countInfo').textContent = rangeText;
    document.getElementById('rangeText').textContent = rangeText;
  }

  // ---------- Charts (Overview) ----------
  function renderOverviewCharts(){
    // by year
    const byYear = {};
    for (const p of filtered) {
      if (!p.year) continue;
      byYear[p.year] = (byYear[p.year]||0)+1;
    }
    const labelsY = Object.keys(byYear).sort((a,b)=>a-b);
    const dataY = labelsY.map(y=>byYear[y]);

    if (chartByYear) chartByYear.destroy();
    chartByYear = new Chart(document.getElementById('chartByYear'), {
      type: 'bar',
      data: { labels: labelsY, datasets: [{ label: 'Publications', data: dataY }] },
      options: { responsive: true, maintainAspectRatio: false, scales:{ y:{ beginAtZero:true } } }
    });

    // top journals
    const counts = {};
    for (const p of filtered) {
      const j = (p.journal||'').trim();
      if (!j) continue;
      counts[j] = (counts[j]||0)+1;
    }
    const top = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const labelsJ = top.map(x=>x[0]);
    const dataJ = top.map(x=>x[1]);

    if (chartTopJournals) chartTopJournals.destroy();
    chartTopJournals = new Chart(document.getElementById('chartTopJournals'), {
      type: 'bar',
      data: { labels: labelsJ, datasets: [{ label: 'Count', data: dataJ }] },
      options: { responsive: true, maintainAspectRatio: false, indexAxis:'y', scales:{ x:{ beginAtZero:true } } }
    });
  }

  // ---------- Quartiles upload / mapping ----------
  document.getElementById('sjrFile').addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if (!file) return;
    const name = file.name.toLowerCase();
    const text = await file.text();

    sjrByIssn.clear(); sjrByTitle.clear(); haveSJR=false;

    try{
      if (name.endsWith('.json')) {
        const arr = JSON.parse(text);
        for (const row of arr) addQuartileRow(row);
      } else if (name.endsWith('.csv')) {
        parseCSV(text, addQuartileRow);
      } else {
        throw new Error('Unsupported file type');
      }
      haveSJR = (sjrByIssn.size + sjrByTitle.size) > 0;
      document.getElementById('sjrStatus').textContent =
        `Loaded ${sjrByIssn.size} ISSN entries and ${sjrByTitle.size} title entries`;
      // re-apply to inject quartiles
      applyFilters();
      updateCoverage();
    }catch(err){
      document.getElementById('sjrStatus').textContent = 'Failed: '+err.message;
    }
  });

  function addQuartileRow(row){
    if (!row) return;
    const q = normQuartile(row.quartile || row.Quarter || row.Q || row.q || '');
    const title = normTitle(row.title || row.Title || row.Journal || '');
    const issn = normIssn(row.issn || row.ISSN || row.issn_print || row.ISSN_print || '');
    if (issn && q) sjrByIssn.set(issn, q);
    if (title && q) sjrByTitle.set(title, q);
  }

  function parseCSV(text, onRow){
    const lines = text.split(/\r?\n/).filter(Boolean);
    const header = lines.shift().split(',').map(h=>h.trim().toLowerCase());
    const idxTitle = header.findIndex(h=>/title|journal/.test(h));
    const idxIssn  = header.findIndex(h=>/issn/.test(h));
    const idxQuart = header.findIndex(h=>/quartile|q$/.test(h));
    if (idxQuart<0 || (idxTitle<0 && idxIssn<0)) throw new Error('CSV must include Title/ISSN and Quartile columns');
    for (const line of lines){
      const cols = splitCsv(line);
      onRow({
        title: idxTitle>=0 ? cols[idxTitle] : '',
        issn:  idxIssn>=0 ? cols[idxIssn] : '',
        quartile: idxQuart>=0 ? cols[idxQuart] : ''
      });
    }
  }

  // CSV splitter that respects quoted commas
  function splitCsv(line){
    const out=[]; let cur=''; let inQ=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (ch==='\"'){ inQ = !inQ; continue; }
      if (ch===',' && !inQ){ out.push(cur.trim()); cur=''; continue; }
      cur+=ch;
    }
    out.push(cur.trim()); return out;
  }

  function resolveQuartile(p){
    // prefer ISSN match (exact), then title (normalized)
    const issns = (p.issns||[]).map(normIssn).filter(Boolean);
    for (const id of issns){ if (sjrByIssn.has(id)) return sjrByIssn.get(id); }
    const t = normTitle(p.journal||'');
    if (t && sjrByTitle.has(t)) return sjrByTitle.get(t);
    return '';
  }

  function updateCoverage(){
    let mapped=0, total=filtered.length;
    for (const p of filtered) if (p.quartile) mapped++;
    const pct = total? Math.round(mapped*100/total):0;
    document.getElementById('mapCoverage').textContent =
      `${mapped} / ${total} in current view mapped (${pct}%)`;
  }

  // ---------- Export ----------
  function exportCSV(){
    if (!filtered.length) return;
    const start=(currentPage-1)*pageSize, end=Math.min(start+pageSize, filtered.length);
    const rows=filtered.slice(start,end);
    const header=['year','title','journal','authors','citations','quartile','retracted','doi','url'];
    const csv=[header.join(',')].concat(rows.map(r=>[
      r.year||'',
      q(r.title||''),
      q(r.journal||''),
      q((r.authors||[]).join('; ')),
      r.citations??0,
      r.quartile||'',
      r.is_retracted?'Yes':'No',
      r.doi||'',
      r.url||''
    ].join(','))).join('\n');
    downloadBlob('publications_view.csv', csv, 'text/csv');
  }
  function exportJSON(){
    const start=(currentPage-1)*pageSize, end=Math.min(start+pageSize, filtered.length);
    const rows=filtered.slice(start,end);
    downloadBlob('publications_view.json', JSON.stringify(rows,null,2), 'application/json');
  }

  // ---------- Utils ----------
  function esc(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function q(s){ return `"${String(s).replace(/"/g,'""')}"`; }
  function downloadBlob(name, content, type){
    const blob = new Blob([content],{type}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
  }
  function num(n){ return (n||0).toLocaleString(); }
  function normTitle(t){ return String(t||'').toLowerCase().replace(/\s+/g,' ').trim(); }
  function normIssn(s){
    const x=String(s||'').replace(/[^0-9xX]/g,'').toUpperCase();
    return x.length===8? x.slice(0,4)+'-'+x.slice(4): (x.length===7? x.slice(0,3)+'-'+x.slice(3): '');
  }
  function normQuartile(q){
    const s=String(q||'').toUpperCase().trim();
    return /^Q[1-4]$/.test(s) ? s : '';
  }

  // Init
  document.addEventListener('DOMContentLoaded', autoLoad);
</script>
</body>
</html>
