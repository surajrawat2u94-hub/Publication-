<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Publication Data</title>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 0.5rem; }
    .filters { margin: 1rem 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 0.9rem; }
    th { background: #f4f4f4; }
    #lastSynced { color: #666; font-size: 0.85rem; margin-left: 1rem; }
  </style>
</head>
<body>
  <h1>Publication Data <span id="lastSynced"></span></h1>
  <div class="filters">
    <button onclick="loadData()">Load publications</button>
    <select id="yearFilter" onchange="applyFilters()">
      <option value="">All Years</option>
    </select>
    <select id="retractionFilter" onchange="applyFilters()">
      <option value="">All</option>
      <option value="exclude">Exclude retracted</option>
      <option value="only">Only retracted</option>
    </select>
  </div>

  <canvas id="yearChart" width="600" height="200"></canvas>
  <div id="count"></div>
  <table id="pubTable">
    <thead>
      <tr>
        <th>Year</th>
        <th>Title</th>
        <th>Journal</th>
        <th>Authors</th>
        <th>Citations</th>
        <th>Retracted?</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
let publications = [];

async function loadData() {
  try {
    // âœ… Updated to load institution_data.json
    const res = await fetch('institution_data.json', { cache: 'no-store' });
    if (!res.ok) throw new Error("File not found");
    const j = await res.json();
    publications = j.items || [];
    document.getElementById("count").textContent = "Total: " + j.count;

    if (j.updated) {
      document.getElementById("lastSynced").textContent =
        "(Last synced: " + dayjs(j.updated).format('DD MMM YYYY, HH:mm') + ")";
    }

    populateYearFilter();
    applyFilters();
  } catch (e) {
    alert("Failed to load publications: " + e.message);
  }
}

function populateYearFilter() {
  const years = [...new Set(publications.map(p => p.year).filter(Boolean))].sort((a,b)=>b-a);
  const select = document.getElementById("yearFilter");
  select.innerHTML = '<option value="">All Years</option>';
  years.forEach(y => {
    select.innerHTML += `<option value="${y}">${y}</option>`;
  });
}

function applyFilters() {
  const yearSel = document.getElementById("yearFilter").value;
  const retractSel = document.getElementById("retractionFilter").value;

  let data = publications;
  if (yearSel) data = data.filter(p => String(p.year) === yearSel);
  if (retractSel === "exclude") data = data.filter(p => !p.is_retracted);
  if (retractSel === "only") data = data.filter(p => p.is_retracted);

  renderTable(data);
  renderChart(data);
}

function renderTable(data) {
  const tbody = document.querySelector("#pubTable tbody");
  tbody.innerHTML = "";
  data.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.year || ""}</td>
      <td><a href="${p.url}" target="_blank">${p.title}</a></td>
      <td>${p.journal || ""}</td>
      <td>${(p.authors || []).join(", ")}</td>
      <td>${p.citations}</td>
      <td>${p.is_retracted ? "Yes" : "No"}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderChart(data) {
  const ctx = document.getElementById("yearChart").getContext("2d");
  const grouped = {};
  data.forEach(p => {
    if (p.year) grouped[p.year] = (grouped[p.year] || 0) + 1;
  });
  const labels = Object.keys(grouped).sort();
  const counts = labels.map(y => grouped[y]);
  if (window.yearChartObj) window.yearChartObj.destroy();
  window.yearChartObj = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: "Publications", data: counts }] },
  });
}
</script>
</body>
</html>
