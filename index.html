<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Publications Portal</title>

<!-- Tailwind (utility CSS) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Lucide icons -->
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

<!-- Day.js + Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 10px 20px rgba(2,6,23,.06)}
  .tab-active{color:#111827;border-bottom:2px solid #7c3aed}
  .tab-inactive{color:#6b7280;border-bottom:2px solid transparent}
  .thin-scrollbar::-webkit-scrollbar{height:8px;width:8px}
  .thin-scrollbar::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px}
  .badge{display:inline-flex;align-items:center;padding:.15rem .45rem;border-radius:999px;border:1px solid #e2e8f0;background:#f8fafc;font-size:.72rem}
</style>
</head>
<body class="bg-slate-50 text-slate-900">

<!-- Header -->
<header class="sticky top-0 z-30 bg-gradient-to-r from-indigo-600 via-fuchsia-600 to-sky-600 text-white">
  <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-2xl bg-white/15 grid place-content-center shadow-inner">
        <i data-lucide="panel-top" class="text-white"></i>
      </div>
      <div>
        <h1 class="text-lg font-semibold">AI Publications Portal</h1>
        <div id="lastSynced" class="text-xs opacity-90">Loading…</div>
      </div>
    </div>
    <div class="hidden md:block text-xs bg-white/15 rounded-lg px-2 py-1 border border-white/20">
      Static JSON · No live API
    </div>
  </div>
  <div class="bg-white text-sm">
    <div class="max-w-7xl mx-auto px-4">
      <nav class="flex gap-2">
        <button id="tabOverview" class="px-4 py-3 tab-active"   onclick="switchTab('overview')">Overview</button>
        <button id="tabPublications" class="px-4 py-3 tab-inactive" onclick="switchTab('publications')">Publications</button>
      </nav>
    </div>
  </div>
</header>

<!-- Content -->
<main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

  <!-- OVERVIEW -->
  <section id="view-overview" class="space-y-6">
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
      <div class="card p-4">
        <div class="text-xs text-slate-500">Total items</div>
        <div id="kpiTotal" class="mt-1 text-2xl font-semibold">—</div>
      </div>
      <div class="card p-4">
        <div class="text-xs text-slate-500">Current view</div>
        <div id="kpiView" class="mt-1 text-2xl font-semibold">—</div>
      </div>
      <div class="card p-4">
        <div class="text-xs text-slate-500">Retracted (view)</div>
        <div id="kpiRetr" class="mt-1 text-2xl font-semibold">—</div>
      </div>
      <div class="card p-4">
        <div class="text-xs text-slate-500">Distinct journals (view)</div>
        <div id="kpiJournals" class="mt-1 text-2xl font-semibold">—</div>
      </div>
      <div class="card p-4">
        <div class="text-xs text-slate-500">Types in view</div>
        <div id="kpiTypes" class="mt-1 text-2xl font-semibold">—</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Publications by Year</h3>
        </div>
        <div class="mt-2 h-[280px]"><canvas id="chartByYear"></canvas></div>
      </div>

      <div class="card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Top Journals — Publications & Citations</h3>
        </div>
        <div class="mt-2 h-[280px]"><canvas id="chartTopJournals"></canvas></div>
      </div>
    </div>

    <div class="grid grid-cols-1 gap-4">
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Publishers — Distinct Journals</h3>
        </div>
        <div class="mt-2 h-[320px]"><canvas id="chartPublishers"></canvas></div>
        <div class="text-xs text-slate-500 mt-2">
          Counts unique journal titles per publishing house (heuristic mapping).
        </div>
      </div>
    </div>
  </section>

  <!-- PUBLICATIONS -->
  <section id="view-publications" class="hidden space-y-4">
    <div class="card p-4">
      <div class="flex flex-wrap items-end gap-3">
        <div>
          <label class="block text-xs font-medium text-slate-600">Search</label>
          <input id="searchBox" class="px-3 py-2 rounded-xl border border-slate-300 text-sm"
                 placeholder="Title / author / journal / DOI" oninput="applyFilters(1)" />
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-600">Year (from)</label>
          <select id="yearFrom" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="applyFilters(1)">
            <option value="">All</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600">Year (to)</label>
          <select id="yearTo" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="applyFilters(1)">
            <option value="">All</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-600">Type</label>
          <button id="typeBtn" class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-300 text-sm min-w-[180px]"
                  onclick="toggleTypePanel()"><span id="typeBtnLabel">All types</span></button>
          <div id="typePanel" class="absolute hidden bg-white border border-slate-200 rounded-xl shadow-lg w-64 p-3 mt-2">
            <div class="text-xs text-slate-500 mb-2">Select one or more</div>
            <div id="typeList" class="grid grid-cols-1 gap-y-1 text-sm max-h-64 overflow-auto pr-1"></div>
            <div class="flex justify-between gap-2 mt-3">
              <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="clearTypeSelection()">Clear</button>
              <button class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white" onclick="applyTypeSelection()">Apply</button>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-600">Rows per page</label>
          <select id="pageSize" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="changePageSize()">
            <option value="25">25</option><option value="50" selected>50</option><option value="100">100</option>
          </select>
        </div>

        <div class="ml-auto text-xs text-slate-500" id="countInfo"></div>
      </div>
    </div>

    <div class="card">
      <div class="overflow-x-auto thin-scrollbar">
        <table class="w-full text-sm" id="pubTable">
          <thead class="bg-slate-50 text-slate-600">
            <tr>
              <th class="text-left px-4 py-2">Year</th>
              <th class="text-left px-4 py-2">Title</th>
              <th class="text-left px-4 py-2">Journal</th>
              <th class="text-left px-4 py-2">Publisher</th>
              <th class="text-left px-4 py-2">Home authors</th>
              <th class="text-left px-4 py-2">Citations</th>
              <th class="text-left px-4 py-2">Type</th>
              <th class="text-left px-4 py-2">Retraction</th>
            </tr>
          </thead>
          <tbody id="pubBody"></tbody>
        </table>
      </div>
      <div class="px-4 py-3 flex items-center justify-between">
        <div class="text-xs text-slate-500" id="pageInfo">Page 1 / 1</div>
        <div class="flex gap-2">
          <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goFirst()">« First</button>
          <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goPrev()">‹ Prev</button>
          <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goNext()">Next ›</button>
          <button class="px-3 py-1.5 rounded-lg border border-slate-300" onclick="goLast()">Last »</button>
        </div>
      </div>
    </div>
  </section>
</main>

<footer class="text-center text-xs text-slate-500 pb-8">
  Data from <code>institution_data.json</code>
</footer>

<script>
/* ---------- Icons ---------- */
lucide.createIcons();

/* ---------- Chart defaults ---------- */
Chart.defaults.font.family = "'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
const clr = { indigo:'#6366f1', purple:'#a855f7', teal:'#14b8a6', cyan:'#06b6d4', gray:'#334155' };
const gradH = (ctx,a,b)=>{ const g=ctx.createLinearGradient(0,0,ctx.canvas.width,0); g.addColorStop(0,a); g.addColorStop(1,b); return g; };

/* ---------- App state ---------- */
let all = [];
let filtered = [];
let currentPage = 1;
let pageSize = 50;

const HOME_ROR = "04q2jes40";
const HOME_KW  = ['university of petroleum','energy studies','upes'];

const selectedTypes = new Set();
let knownTypes = []; // {key,label,count}

/* ---------- Helpers ---------- */
const esc = s => String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
const num = n => (n||0).toLocaleString();

function normType(t){
  const s = String(t||'').toLowerCase();
  if (s === 'journal-article' || s === 'article') return 'article';
  if (s.includes('proceed')) return 'proceedings-article';
  if (s === 'book-chapter' || s.includes('chapter')) return 'book-chapter';
  if (s.startsWith('book')) return 'book';
  if (s.includes('review')) return 'review';
  if (s.includes('preprint')) return 'preprint';
  if (s.includes('dataset')) return 'dataset';
  return s || 'other';
}
function labelType(key){
  return ({
    'article':'Article',
    'proceedings-article':'Conference',
    'book':'Book',
    'book-chapter':'Book Chapter',
    'review':'Review',
    'preprint':'Preprint',
    'dataset':'Dataset',
    'other':'Other'
  })[key] || key;
}

/* ---------- Publisher normalizer ---------- */
function unifyPublisherName(s){
  const t = String(s||'').trim();
  if (!t) return '';
  const x = t.toLowerCase();
  if (x.includes('elsevier') || x.includes('sciencedirect') || x.includes('cell press') || x.includes('lancet')) return 'Elsevier';
  if (x.includes('springer') || x.includes('nature') || x.includes('bmc')) return 'Springer Nature';
  if (x.includes('taylor') || x.includes('informa')) return 'Taylor & Francis';
  if (x.includes('wiley')) return 'Wiley';
  if (x.includes('sage')) return 'SAGE';
  if (x.includes('mdpi')) return 'MDPI';
  if (x.includes('ieee')) return 'IEEE';
  if (x.includes('acm')) return 'ACM';
  if (x.includes('frontiers')) return 'Frontiers';
  if (x.includes('hindawi')) return 'Hindawi';
  if (x.includes('emerald')) return 'Emerald';
  if (x.includes('de gruyter')) return 'De Gruyter';
  if (x.includes('oxford')) return 'Oxford Univ Press';
  if (x.includes('cambridge')) return 'Cambridge Univ Press';
  if (x.includes('iop')) return 'IOP Publishing';
  if (x.includes('aip')) return 'AIP Publishing';
  if (x.includes('royal society of chemistry') || /\brsc\b/.test(x)) return 'Royal Society of Chemistry';
  if (x.includes('plos')) return 'PLOS';
  if (x.includes('ssrn')) return 'SSRN';
  if (x.includes('research square')) return 'Research Square';
  return t;
}
function inferPublisherFromJournal(journal){
  const j = ' ' + String(journal||'').toLowerCase() + ' ';
  if (j.includes(' ieee ') || j.trim().startsWith('ieee ')) return 'IEEE';
  if (j.includes('frontiers in ')) return 'Frontiers';
  if (j.includes('plos ')) return 'PLOS';
  if (j.includes('bmj ')) return 'BMJ';
  if (j.includes('mdpi')) return 'MDPI';
  if (j.includes('acm ')) return 'ACM';
  if (j.includes('springer')) return 'Springer Nature';
  if (j.includes('wiley')) return 'Wiley';
  if (j.includes('taylor') || j.includes('francis')) return 'Taylor & Francis';
  if (j.includes('elsevier')) return 'Elsevier';
  return '';
}
function getPublisher(p){
  const hv  = p.host_venue || {};
  const src = (p.primary_location && p.primary_location.source) || {};
  const candidates = [
    p.publisher,
    hv.publisher, hv.publisher_line, hv.publisher_display_name,
    src.publisher, src.host_organization_name
  ];
  for (const c of candidates){
    if (typeof c === 'string' && c.trim()) return unifyPublisherName(c);
  }
  return unifyPublisherName(inferPublisherFromJournal(p.journal || (src.display_name||hv.display_name||'')));
}

/* ---------- Home authors (UPES) ---------- */
function deriveHomeAuthors(p){
  const out = [];
  const auth = Array.isArray(p.authorships) ? p.authorships : [];
  for (const a of auth){
    const nm = (a.author && a.author.display_name) || a.display_name;
    const insts = Array.isArray(a.institutions) ? a.institutions : [];
    const matchROR = insts.some(i => String((i.ror||'').split('/').pop()) === HOME_ROR);
    const matchKW  = insts.some(i => HOME_KW.some(k => String(i.display_name||'').toLowerCase().includes(k)));
    if (nm && (matchROR || matchKW)) out.push(nm);
  }
  return [...new Set(out)];
}

/* ---------- UI: tab switch ---------- */
function switchTab(name){
  const tabs=['overview','publications'];
  for (const t of tabs){
    document.getElementById(`view-${t}`).classList.toggle('hidden', t!==name);
    const btn = document.getElementById(`tab${t[0].toUpperCase()+t.slice(1)}`);
    btn.classList.toggle('tab-active', t===name);
    btn.classList.toggle('tab-inactive', t!==name);
  }
}

/* ---------- Load JSON ---------- */
async function autoLoad(){
  try{
    const res = await fetch('institution_data.json', {cache:'no-store'});
    const j = await res.json();
    document.getElementById('lastSynced').textContent =
      j.updated ? `Last synced: ${dayjs(j.updated).format('DD MMM YYYY, HH:mm')}` : '';
    all = (j.items || []).map(w => ({
      id: w.id,
      title: w.display_name || w.title || '',
      journal: ((w.primary_location && w.primary_location.source && w.primary_location.source.display_name) ||
                (w.host_venue && w.host_venue.display_name) || ''),
      year: w.publication_year || null,
      type: normType(w.type || w.type_crossref),
      citations: w.cited_by_count || 0,
      doi: w.doi || '',
      url: w.doi ? `https://doi.org/${w.doi}` : (w.primary_location && (w.primary_location.landing_page_url || w.primary_location.pdf_url) || ''),
      authorships: w.authorships || [],
      is_retracted: !!w.is_retracted,
      publisher: '' // filled below
    }));
    for (const p of all) p.publisher = getPublisher({ ...p, host_venue: wHost(p), primary_location: wPrim(p) });

    function wHost(p){ return { display_name: p.journal }; }
    function wPrim(p){ return { source:{ display_name: p.journal } }; }

    document.getElementById('kpiTotal').textContent = num(all.length);

    // Years
    const years = [...new Set(all.map(x=>x.year).filter(Boolean))].sort((a,b)=>a-b);
    const opts = ys => ['<option value="">All</option>'].concat(ys.map(y=>`<option value="${y}">${y}</option>`)).join('');
    document.getElementById('yearFrom').innerHTML = opts(years);
    document.getElementById('yearTo').innerHTML   = opts(years);

    // Types list (dynamic, Book vs Book Chapter separate)
    const counts = new Map();
    for (const p of all){ counts.set(p.type, (counts.get(p.type)||0)+1); }
    knownTypes = [...counts.entries()].sort((a,b)=>b[1]-a[1]).map(([k,c])=>({key:k,label:labelType(k),count:c}));
    buildTypePanel();

    applyFilters(1);
  }catch(e){
    document.getElementById('lastSynced').textContent = 'Failed to load JSON.';
    console.error(e);
  }
}

/* ---------- Type dropdown ---------- */
function buildTypePanel(){
  const box = document.getElementById('typeList'); if (!box) return;
  box.innerHTML = '';
  for (const t of knownTypes){
    const id = `type_${t.key.replace(/\W/g,'_')}`;
    box.insertAdjacentHTML('beforeend', `
      <label class="flex items-center gap-2">
        <input type="checkbox" id="${id}" />
        <span>${esc(t.label)} <span class="text-xs text-slate-400">(${num(t.count)})</span></span>
      </label>
    `);
  }
  updateTypeBtnLabel();
}
function toggleTypePanel(){
  document.getElementById('typePanel').classList.toggle('hidden');
}
function clearTypeSelection(){
  selectedTypes.clear();
  buildTypePanel();
  applyFilters(1);
}
function applyTypeSelection(){
  selectedTypes.clear();
  for (const t of knownTypes){
    const id = `type_${t.key.replace(/\W/g,'_')}`;
    const el = document.getElementById(id);
    if (el && el.checked) selectedTypes.add(t.key);
  }
  updateTypeBtnLabel();
  toggleTypePanel();
  applyFilters(1);
}
function updateTypeBtnLabel(){
  document.getElementById('typeBtnLabel').textContent = selectedTypes.size ? `${selectedTypes.size} selected` : 'All types';
}

/* ---------- Filters / search ---------- */
function applyFilters(goToPage=1){
  const q = (document.getElementById('searchBox')?.value || '').toLowerCase().trim();
  const y1 = parseInt(document.getElementById('yearFrom')?.value || '') || null;
  const y2 = parseInt(document.getElementById('yearTo')?.value || '') || null;

  filtered = all.filter(p=>{
    if (y1 && (p.year==null || p.year<y1)) return false;
    if (y2 && (p.year==null || p.year>y2)) return false;

    if (selectedTypes.size && !selectedTypes.has(p.type)) return false;

    if (q){
      const hay = [p.title,p.journal,p.publisher,p.doi,(deriveHomeAuthors(p)||[]).join(' ')].join(' ').toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  if (goToPage===1) currentPage=1;

  // KPIs
  document.getElementById('kpiView').textContent = num(filtered.length);
  document.getElementById('kpiRetr').textContent = num(filtered.filter(x=>x.is_retracted).length);
  document.getElementById('kpiJournals').textContent = num(new Set(filtered.map(x=>x.journal).filter(Boolean)).size);
  document.getElementById('kpiTypes').textContent = num(new Set(filtered.map(x=>x.type)).size);

  renderTable();
  renderOverviewCharts();
}

/* ---------- Table ---------- */
function renderTable(){
  const body = document.getElementById('pubBody');
  body.innerHTML = '';
  const start = (currentPage-1)*pageSize;
  const end = Math.min(start+pageSize, filtered.length);
  const rows = filtered.slice(start,end);

  for (const p of rows){
    const tr = document.createElement('tr');
    tr.className = 'border-b border-slate-100 hover:bg-slate-50';
    tr.innerHTML = `
      <td class="px-4 py-2 align-top">${p.year ?? ''}</td>
      <td class="px-4 py-2 align-top">${p.url ? `<a class="text-indigo-600" target="_blank" href="${p.url}">${esc(p.title)}</a>` : esc(p.title)}</td>
      <td class="px-4 py-2 align-top">${esc(p.journal||'')}</td>
      <td class="px-4 py-2 align-top">${esc(p.publisher||'Other/Unknown')}</td>
      <td class="px-4 py-2 align-top">${esc((deriveHomeAuthors(p)||[]).join(', '))}</td>
      <td class="px-4 py-2 align-top">${p.citations||0}</td>
      <td class="px-4 py-2 align-top">${esc(labelType(p.type))}</td>
      <td class="px-4 py-2 align-top">${p.is_retracted ? '<span class="badge" style="color:#b91c1c;border-color:#ef4444">Retracted</span>' : ''}</td>
    `;
    body.appendChild(tr);
  }

  document.getElementById('pageInfo').textContent = `Page ${currentPage} / ${totalPages()}`;
  document.getElementById('countInfo').textContent = rows.length
    ? `Showing ${num(start+1)}–${num(end)} of ${num(filtered.length)}`
    : `Showing 0 of 0`;
}
function totalPages(){ return Math.max(1, Math.ceil(filtered.length / pageSize)); }
function changePageSize(){ pageSize = parseInt(document.getElementById('pageSize').value,10) || 50; currentPage=1; renderTable(); }
function goFirst(){ currentPage=1; renderTable(); }
function goPrev(){ if (currentPage>1) currentPage--; renderTable(); }
function goNext(){ if (currentPage<totalPages()) currentPage++; renderTable(); }
function goLast(){ currentPage=totalPages(); renderTable(); }

/* ---------- Charts ---------- */
let chartByYear=null, chartTopJournals=null, chartPublishers=null;

function renderOverviewCharts(){
  // By Year
  const map = new Map();
  for (const p of filtered){ if (p.year!=null) map.set(p.year, (map.get(p.year)||0)+1); }
  const years = [...map.keys()].sort((a,b)=>a-b);
  const vals  = years.map(y=>map.get(y));
  const ctx1 = document.getElementById('chartByYear').getContext('2d');
  if (chartByYear) chartByYear.destroy();
  chartByYear = new Chart(ctx1, {
    type:'bar',
    data:{ labels:years, datasets:[{label:'Publications', data:vals, borderRadius:10, backgroundColor:gradH(ctx1, clr.indigo, clr.purple)}]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ x:{grid:{display:false}}, y:{beginAtZero:true, grid:{color:'#e2e8f0'}} } }
  });

  // Top Journals pubs & citations
  const agg = new Map(); // j -> {pubs,cites}
  for (const p of filtered){
    const j=(p.journal||'').trim(); if (!j) continue;
    const o=agg.get(j)||{pubs:0,cites:0}; o.pubs++; o.cites+=Number(p.citations||0); agg.set(j,o);
  }
  const top = [...agg.entries()].sort((a,b)=>b[1].pubs-a[1].pubs).slice(0,12);
  const labels = top.map(([j])=>j), pubs = top.map(([,o])=>o.pubs), cites = top.map(([,o])=>o.cites);
  const ctx2 = document.getElementById('chartTopJournals').getContext('2d');
  if (chartTopJournals) chartTopJournals.destroy();
  chartTopJournals = new Chart(ctx2, {
    type:'bar',
    data:{ labels, datasets:[
      {label:'Publications', data:pubs, yAxisID:'y',   backgroundColor:gradH(ctx2, clr.indigo, clr.purple), borderRadius:10},
      {label:'Citations',    data:cites,yAxisID:'y1',  backgroundColor:gradH(ctx2, clr.teal, clr.cyan),     borderRadius:10}
    ]},
    options:{ responsive:true, maintainAspectRatio:false,
      scales:{ x:{grid:{display:false}, ticks:{maxRotation:45,minRotation:45}},
               y:{beginAtZero:true, grid:{color:'#e2e8f0'}},
               y1:{position:'right', beginAtZero:true, grid:{drawOnChartArea:false}} }
    }
  });

  // Publishers — distinct journals
  const pmap = new Map(); // publisher -> Set(journals)
  for (const p of filtered){
    const pub = getPublisher(p) || 'Other/Unknown';
    const j = (p.journal||'').trim(); if (!j) continue;
    const s = pmap.get(pub) || new Set(); s.add(j); pmap.set(pub,s);
  }
  const rows = [...pmap.entries()].map(([pub,set])=>({pub,count:set.size})).sort((a,b)=>b.count-a.count).slice(0,12);
  const ctx3 = document.getElementById('chartPublishers').getContext('2d');
  if (chartPublishers) chartPublishers.destroy();
  chartPublishers = new Chart(ctx3, {
    type:'bar',
    data:{ labels:rows.map(r=>r.pub), datasets:[{label:'Distinct journals', data:rows.map(r=>r.count), borderRadius:10, backgroundColor:gradH(ctx3, clr.indigo, clr.purple)}]},
    options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
      scales:{ x:{beginAtZero:true, grid:{color:'#e2e8f0'}}, y:{grid:{display:false}} } }
  });
}

/* ---------- init ---------- */
document.addEventListener('click', (e)=>{
  const panel=document.getElementById('typePanel');
  const btn=document.getElementById('typeBtn');
  if (panel && !panel.classList.contains('hidden') && !panel.contains(e.target) && !btn.contains(e.target)){
    panel.classList.add('hidden');
  }
});
document.addEventListener('DOMContentLoaded', autoLoad);
</script>
</body>
</html>
