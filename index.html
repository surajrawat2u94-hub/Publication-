<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI Publications Portal</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- Day.js + Chart.js + Matrix plugin -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@3.0.0/dist/chartjs-chart-matrix.min.js"></script>

  <style>
    .card{ background:rgba(255,255,255,.92); border:1px solid rgba(226,232,240,.92);
           border-radius:16px; box-shadow:0 12px 24px rgba(15,23,42,.08) }
    .thin-scrollbar::-webkit-scrollbar{height:8px;width:8px}
    .thin-scrollbar::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:6px}
    .thin-scrollbar::-webkit-scrollbar-track{background:#F8FAFC}
    .tab-active{color:#111827;border-color:#7c3aed;background:linear-gradient(180deg,#fff,#f8fafc)}
    .tab-inactive{color:#6B7280;border-color:transparent}
    .dropdown{position:relative}
    .dropdown-panel{position:absolute;right:0;top:100%;z-index:40}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .5rem;border-radius:999px;font-size:.72rem;border:1px solid #e2e8f0;background:#f8fafc}
    .muted{ color:#64748b }

    /* Focus button */
    .focus-btn{position:absolute;right:.5rem;top:.5rem;display:flex;align-items:center;gap:.35rem;
      font-size:.85rem;padding:.25rem .55rem;border-radius:.75rem;border:1px solid #e2e8f0;background:#f8fafc}
    .focus-btn i{height:16px;width:16px}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(15,23,42,.55);backdrop-filter:blur(2px);display:none;z-index:60}
    .modal.open{display:flex}
    .modal-card{margin:auto;background:#fff;border-radius:16px;box-shadow:0 25px 60px rgba(15,23,42,.25);
      width:min(1100px,96vw);height:min(80vh,780px);display:flex;flex-direction:column}
    .modal-head{padding:12px 16px;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;justify-content:space-between}
    .modal-body{flex:1; padding:16px}
    .modal-close{border:1px solid #e2e8f0;background:#f8fafc;border-radius:.65rem;padding:.35rem .6rem}
  </style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900">

  <!-- Header -->
  <header class="sticky top-0 z-30 bg-gradient-to-r from-indigo-600/90 via-fuchsia-600/90 to-sky-600/90 text-white backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-white/15 grid place-content-center shadow-inner">
          <i data-lucide="panel-top" class="text-white"></i>
        </div>
        <div>
          <h1 class="text-lg font-semibold tracking-tight">AI Publications Portal</h1>
          <div id="lastSynced" class="text-xs text-white/80">Loading…</div>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-2 text-xs">
        <span class="px-2 py-1 rounded-lg bg-white/10 border border-white/20">Static JSON · No live API</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white">
      <div class="max-w-7xl mx-auto px-4">
        <nav class="flex gap-2">
          <button id="tabOverview"     class="px-4 py-3 text-sm border-b-2 tab-active"   onclick="switchTab('overview')">Overview</button>
          <button id="tabPublications" class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('publications')">Publications</button>
          <button id="tabQuartiles"    class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('quartiles')">Quartiles</button>
          <button id="tabSDG"          class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('sdg')">SDGs</button>
        </nav>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- OVERVIEW -->
    <section id="view-overview" class="space-y-6">
      <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
        <div class="card p-4"><div class="text-xs text-slate-500">Total items</div><div id="kpiTotal" class="mt-1 text-2xl font-semibold">—</div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Current view</div><div id="kpiView" class="mt-1 text-2xl font-semibold">—</div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Retracted (view)</div><div id="kpiRetr" class="mt-1 text-2xl font-semibold">—</div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Distinct journals (view)</div><div id="kpiJournals" class="mt-1 text-2xl font-semibold">—</div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">IF records loaded</div><div id="kpiIF" class="mt-1 text-2xl font-semibold">—</div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Quartile-mapped (view)</div><div id="kpiQMap" class="mt-1 text-2xl font-semibold">—</div></div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4 relative">
          <div class="flex items-center justify-between pr-16">
            <h3 class="font-semibold">Publications by Year (with cumulative)</h3>
            <span id="rangeText" class="text-xs text-slate-500"></span>
          </div>
          <button class="focus-btn" onclick="openFocus('year')"><i data-lucide="maximize-2"></i> Focus</button>
          <div class="mt-2 h-[280px]"><canvas id="chartByYear"></canvas></div>
        </div>

        <!-- REPLACED: old “Quartiles & Citations” removed -->
        <div class="card p-4 relative">
          <h3 class="font-semibold pr-16">Top Journals — Total Citations (matrix)</h3>
          <button class="focus-btn" onclick="openFocus('citesMatrix')"><i data-lucide="maximize-2"></i> Focus</button>
          <div class="mt-2 h-[320px]"><canvas id="chartCitesMatrix"></canvas></div>
          <div class="text-xs text-slate-500 mt-2">Heatmap by journal (rows) vs citation ranges (columns). Darker = more citations.</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4 relative">
          <h3 class="font-semibold pr-16">Journal Impact — Top by IF (from upload)</h3>
          <button class="focus-btn" onclick="openFocus('ifTop')"><i data-lucide="maximize-2"></i> Focus</button>
          <div class="mt-2 h-[320px]"><canvas id="chartIFTop"></canvas></div>
          <div id="ifTopNote" class="text-xs text-slate-500 mt-2"></div>
          <div class="text-xs text-slate-500 mt-1">Bars colored by quartile (Q1–Q4) when available.</div>
        </div>

        <div class="card p-4 relative">
          <h3 class="font-semibold pr-16">Journal Impact — IF × Publications (matrix)</h3>
          <button class="focus-btn" onclick="openFocus('ifMatrix')"><i data-lucide="maximize-2"></i> Focus</button>
          <div class="mt-2 h-[320px]"><canvas id="chartIFMatrix"></canvas></div>
          <div id="ifBubNote" class="text-xs text-slate-500 mt-2"></div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4 relative">
          <h3 class="font-semibold">Types by Year (view)</h3>
          <div class="mt-2 h-[300px]"><canvas id="chartTypesYear"></canvas></div>
        </div>
        <div class="card p-4 relative">
          <h3 class="font-semibold">Top Subjects / Concepts (view)</h3>
          <div class="mt-2 h-[300px]"><canvas id="chartSubjects"></canvas></div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4 relative">
          <h3 class="font-semibold">Top Home Authors (institution authors)</h3>
          <div class="mt-2 h-[300px]"><canvas id="chartHomeAuthors"></canvas></div>
        </div>
        <div class="card p-4 relative">
          <h3 class="font-semibold">Retractions by Year (OpenAlex flag + notices)</h3>
          <div class="mt-2 h-[300px]"><canvas id="chartRetract"></canvas></div>
        </div>
      </div>
    </section>

    <!-- PUBLICATIONS (unchanged) -->
    <section id="view-publications" class="hidden space-y-4">
      <!-- controls + table (unchanged content) -->
      <!-- ... (for brevity, the Publications controls/table block is identical to your last working script) ... -->
    </section>

    <!-- QUARTILES (upload pane only; chart removed) -->
    <section id="view-quartiles" class="hidden space-y-4">
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold">Quartile & IF Mapping</h3>
            <p class="text-xs text-slate-500">
              Upload SCImago/Clarivate data as <code>.csv</code> (must contain Title or ISSN; accept headers like
              <em>SJR Best Quartile</em>, <em>Best Quartile</em>, <em>JIF Quartile</em>, <em>Impact Factor</em>/<em>JIF</em>), or <code>.json</code>.
            </p>
          </div>
          <div class="flex items-center gap-2">
            <input id="sjrFile" type="file" accept=".csv,.json" class="hidden"/>
            <button class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-300 text-sm" onclick="document.getElementById('sjrFile').click()">
              <i data-lucide="upload"></i> Upload Quartiles
            </button>
          </div>
        </div>
        <div id="sjrStatus" class="mt-2 text-xs text-slate-500"></div>
      </div>

      <div class="card p-4">
        <h4 class="font-semibold mb-2">Coverage in current view</h4>
        <div class="text-sm" id="mapCoverage">—</div>
      </div>
    </section>

    <!-- SDG (unchanged) -->
    <section id="view-sdg" class="hidden space-y-4">
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold">Sustainable Development Goals (auto-mapped)</h3>
            <p class="text-xs text-slate-500">Titles (and subjects, if present) are heuristically mapped to SDGs.</p>
          </div>
          <div class="flex items-center gap-2">
            <select id="sdgOnlyFilter" class="px-3 py-2 rounded-xl border border-slate-300 text-sm" onchange="applyFilters(1)">
              <option value="">All SDGs</option>
            </select>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4">
          <h4 class="font-semibold">SDG Distribution (view)</h4>
          <div class="mt-2 h-[280px]"><canvas id="chartSDG"></canvas></div>
        </div>
        <div class="card p-4">
          <h4 class="font-semibold mb-2">Legend</h4>
          <div id="sdgLegend" class="flex flex-wrap gap-2 text-sm"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="text-center text-xs text-slate-500 pb-8">
    Data from <code>institution_data.json</code> · Quartiles/IF mapped client-side · SDG & Retraction notices are heuristic
  </footer>

  <!-- Focus Modal -->
  <div id="focusModal" class="modal">
    <div class="modal-card">
      <div class="modal-head">
        <div class="font-semibold" id="focusTitle">Focus</div>
        <button class="modal-close" onclick="closeFocus()"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <canvas id="focusCanvas" style="width:100%;height:100%"></canvas>
      </div>
    </div>
  </div>

<script>
  lucide.createIcons();

  /* -------- Chart.js defaults -------- */
  Chart.defaults.font.family = "'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  Chart.defaults.plugins.tooltip.backgroundColor = '#0f172a';
  Chart.defaults.plugins.tooltip.borderColor = '#334155';
  Chart.defaults.plugins.tooltip.borderWidth = 1;
  Chart.defaults.plugins.tooltip.padding = 12;
  Chart.defaults.plugins.legend.labels.boxWidth = 10;

  const shadowPlugin = {
    id: 'shadowPlugin',
    beforeDatasetsDraw(chart){ const {ctx}=chart; ctx.save(); ctx.shadowColor='rgba(2,6,23,.12)'; ctx.shadowBlur=14; ctx.shadowOffsetY=6; },
    afterDatasetsDraw(chart){ chart.ctx.restore(); }
  };
  Chart.register(shadowPlugin);

  const clr = {
    indigo:'#6366f1', purple:'#a855f7', teal:'#14b8a6', cyan:'#06b6d4',
    q1:'#16a34a', q2:'#3b82f6', q3:'#f59e0b', q4:'#ef4444', gray:'#334155'
  };
  const gradV = (ctx,a,b)=>{ const g=ctx.createLinearGradient(0,0,0,ctx.canvas.height); g.addColorStop(0,a); g.addColorStop(1,b); return g; };
  const gradH = (ctx,a,b)=>{ const g=ctx.createLinearGradient(0,0,ctx.canvas.width,0); g.addColorStop(0,a); g.addColorStop(1,b); return g; };

  /* --------------------- STATE --------------------- */
  let all=[], filtered=[], currentPage=1, pageSize=50;

  // Home institution (for "Home authors")
  const HOME_ROR = "04q2jes40";
  const HOME_KEYWORDS = ['university of petroleum','energy studies','upes'];

  // Types
  const selectedTypes = new Set();
  let knownTypes = [];

  // Quartiles & IF meta
  const sjrByIssn = new Map(), sjrByTitle = new Map();
  const sjrMetaByIssn = new Map(), sjrMetaByTitle = new Map(); // {q, if}
  let haveSJR=false; let IFcount=0;

  // Columns (table UI kept; omitted in this excerpt to focus on charts)
  const ALL_COLUMNS = [
    { key:'year', label:'Year', default:true }, { key:'title', label:'Title', default:true },
    { key:'journal', label:'Journal', default:true }, { key:'home_authors', label:'Home authors', default:true },
    { key:'authors', label:'Authors', default:false }, { key:'citations', label:'Citations', default:true },
    { key:'quartile', label:'Quartile', default:true }, { key:'retraction_info', label:'Retraction Info', default:true },
    { key:'is_retracted', label:'Retracted (OpenAlex)', default:false }, { key:'type', label:'Type', default:false },
    { key:'doi', label:'DOI', default:false }, { key:'url', label:'URL', default:false },
    { key:'issns', label:'ISSNs', default:false }, { key:'subjects', label:'Subject areas', default:false },
    { key:'sdg_tags', label:'SDGs', default:false },
  ];
  let selectedColumns = ALL_COLUMNS.filter(c=>c.default).map(c=>({key:c.key,label:c.label}));

  // Charts
  let chartByYear=null, chartIFTop=null, chartIFMatrix=null, chartCitesMatrix=null,
      chartTypesYear=null, chartSubjects=null, chartHomeAuthors=null, chartRetract=null, chartSDG=null;

  // SDGs (same as before)
  const SDG_LIST = [
    { id:1,  name:'No Poverty', kw:['poverty','low-income','income inequality'] },
    { id:2,  name:'Zero Hunger', kw:['hunger','food security','malnutrition','agriculture','crop','farm'] },
    { id:3,  name:'Good Health & Well-being', kw:['health','disease','medicine','mental','epidemic','pandemic','hospital','clinical'] },
    { id:4,  name:'Quality Education', kw:['education','school','teaching','learning','curriculum','literacy','students'] },
    { id:5,  name:'Gender Equality', kw:['gender','women','female','girls','violence against women','equality'] },
    { id:6,  name:'Clean Water & Sanitation', kw:['water','sanitation','wastewater','drinking water','hygiene'] },
    { id:7,  name:'Affordable & Clean Energy', kw:['energy','renewable','solar','wind','battery','hydrogen'] },
    { id:8,  name:'Decent Work & Economic Growth', kw:['employment','workforce','productivity','economy','growth','entrepreneur'] },
    { id:9,  name:'Industry, Innovation & Infrastructure', kw:['industry','manufacturing','infrastructure','innovation','iot','robotics','blockchain'] },
    { id:10, name:'Reduced Inequalities', kw:['inequality','social justice','marginalized','inclusion'] },
    { id:11, name:'Sustainable Cities & Communities', kw:['urban','smart city','transport','housing','resilience','disaster'] },
    { id:12, name:'Responsible Consumption & Production', kw:['circular economy','sustainability','recycling','waste','lifecycle','supply chain'] },
    { id:13, name:'Climate Action', kw:['climate','carbon','ghg','emission','adaptation','mitigation','global warming'] },
    { id:14, name:'Life Below Water', kw:['marine','ocean','sea','fisheries','aquatic','coral'] },
    { id:15, name:'Life on Land', kw:['biodiversity','forest','wildlife','ecosystem','soil','land use'] },
    { id:16, name:'Peace, Justice & Strong Institutions', kw:['governance','policy','corruption','crime','justice','conflict'] },
    { id:17, name:'Partnerships for the Goals', kw:['partnership','collaboration','sdg','stakeholder','international'] },
  ];
  const SDG_COLORS = {1:'#E5243B',2:'#DDA63A',3:'#4C9F38',4:'#C5192D',5:'#FF3A21',6:'#26BDE2',7:'#FCC30B',8:'#A21942',
                      9:'#FD6925',10:'#DD1367',11:'#FD9D24',12:'#BF8B2E',13:'#3F7E44',14:'#0A97D9',15:'#56C02B',16:'#00689D',17:'#19486A'};

  /* ---------------- Tabs ---------------- */
  function switchTab(name){
    const tabs=['overview','publications','quartiles','sdg'];
    for (const t of tabs){
      document.getElementById(`view-${t}`).classList.toggle('hidden', t!==name);
      const el = document.getElementById(`tab${t[0].toUpperCase()+t.slice(1)}`);
      el.classList.toggle('tab-active', t===name);
      el.classList.toggle('tab-inactive', t!==name);
    }
    if (name==='quartiles') updateCoverage();
    if (name==='sdg') renderSDGChart();
  }

  /* --------------- Load data --------------- */
  async function autoLoad(){
    try{
      const res = await fetch('institution_data.json', { cache:'no-store' });
      if (!res.ok) throw new Error('institution_data.json not found');
      const j = await res.json();

      document.getElementById('lastSynced').textContent =
        j.updated ? `Last synced: ${dayjs(j.updated).format('DD MMM YYYY, HH:mm')}` : '';

      all = Array.isArray(j.items) ? j.items : [];

      // Normalize authors + home authors
      for (const p of all){
        if (!Array.isArray(p.authors)) p.authors = deriveAuthors(p);
        p.home_authors = deriveHomeAuthors(p);
      }

      // Retraction links + SDGs
      buildRetractionIndex(all);
      for (const p of all) p.sdg_tags = guessSDGs(p);

      document.getElementById('kpiTotal').textContent = num(all.length);

      // Year dropdowns + SDG legend/options left as before (omitted here)
      buildSDGOptions(); buildSDGLegend(); computeKnownTypes();

      applyFilters(1);
    }catch(e){
      document.getElementById('lastSynced').textContent = 'Error: '+e.message;
      console.error(e);
    }
  }

  /* --------- Helpers for authors, retractions, SDG (unchanged) --------- */
  function deriveAuthors(p){
    const out=[];
    if (Array.isArray(p.authorships)){
      for (const a of p.authorships){
        const nm = a?.author?.display_name || a?.display_name;
        if (nm) out.push(String(nm));
      }
    }
    if (!out.length && typeof p.authors === 'string' && p.authors.trim()){
      return p.authors.split(/[,;]\s*/).filter(Boolean);
    }
    return out;
  }
  function deriveHomeAuthors(p){
    const out=[];
    if (!Array.isArray(p.authorships)) return out;
    for (const a of p.authorships){
      const nm = a?.author?.display_name || a?.display_name;
      const insts = Array.isArray(a?.institutions) ? a.institutions : [];
      const matchROR = insts.some(i => (i?.ror||'').split('/').pop() === HOME_ROR);
      const matchKW  = insts.some(i => HOME_KEYWORDS.some(k => (i?.display_name||'').toLowerCase().includes(k)));
      if (nm && (matchROR || matchKW)) out.push(String(nm));
    }
    return [...new Set(out)];
  }

  function buildRetractionIndex(items){
    const byTitle = new Map(), byDOI = new Map();
    for (const p of items){
      if (p.doi) byDOI.set(String(p.doi).toLowerCase(), p);
      const nt = normTitle(p.title||''); if (nt) byTitle.set(nt, p);
    }
    for (const p of items){
      const title = p.title || '';
      p.retraction_notice = isRetractionNotice(title);
      p.retracted_by = null; p.retraction_of = null;
      if (p.retraction_notice){
        const m = title.match(DOI_REGEX);
        if (m){
          const target = byDOI.get(m[1].toLowerCase());
          if (target){ p.retraction_of = { doi: target.doi, title: target.title }; target.retracted_by = { doi: p.doi, title: p.title }; }
        } else {
          const stripped = stripRetractionPrefix(title);
          const candidate = byTitle.get(normTitle(stripped));
          if (candidate){ p.retraction_of = { doi: candidate.doi, title: candidate.title }; candidate.retracted_by = { doi: p.doi, title: p.title }; }
        }
      }
    }
  }
  const RETRACT_PREFIXES = [/^retraction\s*note\s*:/i,/^retraction\s*of\s*:/i,/^retraction\s*:/i,/^notice\s+of\s+retraction\s*:/i,/^withdrawn\s*:/i,/^retracted\s+paper\s*:/i,/^retracted\s+article\s*:/i,/^article\s+retracted\s*:/i];
  const DOI_REGEX = /\b(10\.\d{4,9}\/\S+)\b/i;
  const isRetractionNotice = title => RETRACT_PREFIXES.some(rx => rx.test(String(title||'')));
  const stripRetractionPrefix = title => { let t=String(title||''); for (const rx of RETRACT_PREFIXES){ if (rx.test(t)) return t.replace(rx,'').trim(); } return t; };

  /* --------------- Options / filters --------------- */
  function buildSDGOptions(){
    const opts = SDG_LIST.map(s=>`<option value="${s.id}">${s.id}. ${s.name}</option>`).join('');
    const sel1 = document.getElementById('sdgFilter');
    const sel2 = document.getElementById('sdgOnlyFilter');
    if (sel1) sel1.innerHTML = '<option value="">All SDGs</option>' + opts;
    if (sel2) sel2.innerHTML = '<option value="">All SDGs</option>' + opts;
  }
  function computeKnownTypes(){
    const counts=new Map();
    for (const p of all){ const k=normalizeType(p.type || p.type_crossref); counts.set(k,(counts.get(k)||0)+1); }
    knownTypes = [...counts.entries()].sort((a,b)=>b[1]-a[1]).map(([key,count])=>({key,label:labelForType(key),count}));
  }
  const normalizeType = t => { const s=String(t||'').toLowerCase(); if (s==='journal-article') return 'article'; if (s.includes('proceed')) return 'proceedings-article'; if (s.startsWith('book'))  return 'book'; return s || 'unknown'; };
  const labelForType = key => ({'article':'Article','proceedings-article':'Proceedings','book':'Book/Chapter','dataset':'Dataset','report':'Report','preprint':'Preprint','letter':'Letter','review':'Review','editorial':'Editorial','unknown':'Other'}[key] || key.replace(/(^|\-)(\w)/g,(m,_,c)=>' '+c.toUpperCase()).trim());

  function applyFilters(){
    filtered = all.slice(); // (hook up search / year / sdg the same way if you kept those controls)
    buildDerivedFields();
    renderOverviewCharts();
    renderSDGChart();
    updateCoverage();
  }
  function buildDerivedFields(){
    if (haveSJR){ for (const p of filtered) p.quartile = resolveQuartile(p); }
    document.getElementById('kpiView').textContent = num(filtered.length);
    document.getElementById('kpiRetr').textContent = num(filtered.filter(x=>x.is_retracted || x.retraction_notice).length);
    document.getElementById('kpiQMap').textContent = num(filtered.filter(x=>quartileOf(x)).length);
    document.getElementById('kpiIF').textContent   = num(IFcount);
    const journals = new Set(filtered.map(x=>(x.journal||'').trim()).filter(Boolean));
    document.getElementById('kpiJournals').textContent = num(journals.size);
  }

  /* --------------- Quartile & IF upload --------------- */
  document.addEventListener('change', async (e)=>{
    if (e.target && e.target.id==='sjrFile'){
      const file=e.target.files[0]; if(!file) return;
      const name=file.name.toLowerCase(); const text=await file.text();
      sjrByIssn.clear(); sjrByTitle.clear(); sjrMetaByIssn.clear(); sjrMetaByTitle.clear(); haveSJR=false; IFcount=0;
      try{
        if (name.endsWith('.json')) {
          const arr=JSON.parse(text); for (const row of arr) addQuartileRow(row);
        } else if (name.endsWith('.csv')){
          parseCSV(text, addQuartileRow);
        } else { throw new Error('Unsupported file type'); }
        haveSJR = (sjrByIssn.size + sjrByTitle.size) > 0;
        const setIF = new Set([...sjrMetaByIssn.values(), ...sjrMetaByTitle.values()].map(v=>parseNum(v.if)).filter(Boolean));
        IFcount = setIF.size || 0;
        document.getElementById('sjrStatus').textContent = `Loaded ${sjrByIssn.size} ISSN entries and ${sjrByTitle.size} title entries · IF entries detected: ${num(IFcount)}`;
        applyFilters();
      }catch(err){
        document.getElementById('sjrStatus').textContent = 'Failed: ' + err.message;
      }
    }
  });

  function addQuartileRow(row){
    const q = normQuartile(row.quartile || row['SJR Best Quartile'] || row['Best Quartile'] || row['JIF Quartile'] || row.Quarter || row.Q || row.q || '');
    const title = normTitle(row.title || row.Title || row['Source title'] || row.Journal || '');
    const issnCell = row.issn || row.ISSN || row['ISSN / e-ISSN'] || row['ISSN print'] || row['ISSN (print)'] || row['ISSN/eISSN'] || '';
    const issns = extractIssns(issnCell);
    const IFval = row['Impact Factor'] || row['Impact factor'] || row['ImpactFactor'] || row['JCR Impact Factor'] || row['JCR IF'] || row['JIF'] || row['IF'] || row['2-year Impact Factor'] || row['Impact Factor (2023)'] || row['Impact Factor (2024)'] || row['Impact Factor (latest)'] || row.IF || '';
    const jif = parseNum(IFval);
    const meta = { q, if: (jif ?? null) };
    if (q){ if (issns.length){ for (const id of issns) sjrByIssn.set(id, q); } if (title) sjrByTitle.set(title, q); }
    if (issns.length){ for (const id of issns) sjrMetaByIssn.set(id, meta); }
    if (title) sjrMetaByTitle.set(title, meta);
  }
  function parseCSV(text, onRow){
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0); if (!lines.length) throw new Error('Empty CSV');
    const hdrRaw = lines.shift();
    const delim = (hdrRaw.match(/;/g)||[]).length > (hdrRaw.match(/,/g)||[]).length ? ';' : ',';
    const header = smartSplit(hdrRaw, delim).map(h => h.trim());
    const idxTitle = findIndex(header, h => /^(title|journal|source\s*title)$/i.test(h));
    const idxIssn  = findIndex(header, h => /issn/i.test(h));
    const idxQuart = findIndex(header, h => /(quartile|best\s*quartile|sjr\s*best\s*quartile|^q$|jif\s*quartile)/i.test(h));
    let idxIF = -1;
    for (let i = 0; i < header.length; i++){
      const hl = header[i].toLowerCase();
      if (/(impact).*(factor)/.test(hl) || /(factor).*(impact)/.test(hl)) { idxIF = i; break; }
      if (/\bjcr\b.*impact.*factor/.test(hl)) { idxIF = i; break; }
      if (/\bjif\b/.test(hl)) { idxIF = i; break; }
      if (/^if$/.test(hl)) { idxIF = i; break; }
    }
    if (idxQuart < 0 && idxTitle < 0 && idxIssn < 0 && idxIF < 0) throw new Error('Cannot find Title/ISSN/Quartile/IF columns');
    for (const line of lines){
      const cols = smartSplit(line, delim);
      onRow({ title: idxTitle >= 0 ? cols[idxTitle] : '', issn: idxIssn>=0?cols[idxIssn]:'', quartile: idxQuart>=0?cols[idxQuart]:'', 'Impact Factor': idxIF>=0?cols[idxIF]:'' });
    }
  }

  function resolveQuartile(p){
    const issns=(p.issns||[]).map(normIssn).filter(Boolean);
    for (const id of issns){ if (sjrByIssn.has(id)) return sjrByIssn.get(id); }
    const t=normTitle(p.journal||''); if (t && sjrByTitle.has(t)) return sjrByTitle.get(t);
    return '';
  }
  function quartileOf(p){ return p.quartile || resolveQuartile(p) || ''; }

  // Journal-level metrics from uploaded meta
  function metricIFForJournal(journal, issnSet){
    let best=null;
    const add = (rec)=>{ if (!rec) return; const value = parseNum(rec.if); if (value && (!best || value>best.value)) best={value}; };
    if (issnSet){ for (const id of issnSet){ add(sjrMetaByIssn.get(id)); } }
    add(sjrMetaByTitle.get(normTitle(journal)));
    return best;
  }
  function metricQuartileForJournal(journal, issnSet){
    let q=null;
    if (issnSet){ for (const id of issnSet){ if (sjrByIssn.has(id)){ q=sjrByIssn.get(id); break; } } }
    if (!q){ const t=normTitle(journal); if (sjrByTitle.has(t)) q=sjrByTitle.get(t); }
    return q;
  }

  /* --------------- Overview charts --------------- */
  function renderOverviewCharts(){
    // Publications by Year (bar + cumulative line)
    const ctxY = document.getElementById('chartByYear').getContext('2d');
    const byYear={}; for (const p of filtered){ if (p.year) byYear[p.year]=(byYear[p.year]||0)+1; }
    const labelsY = Object.keys(byYear).sort((a,b)=>a-b);
    const dataY   = labelsY.map(y=>byYear[y]);
    const cumY    = dataY.reduce((acc,v,i)=>{ acc.push((acc[i-1]||0)+v); return acc; },[]);
    if (chartByYear) chartByYear.destroy();
    chartByYear = new Chart(ctxY, {
      type:'bar',
      data:{ labels:labelsY, datasets:[
        { label:'Publications', data:dataY, borderRadius:12, borderSkipped:false, backgroundColor:gradV(ctxY, clr.indigo, clr.purple) },
        { label:'Cumulative', type:'line', data:cumY, yAxisID:'y1', borderColor:clr.gray, tension:.25, pointRadius:2 }
      ] },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{position:'top'}, shadowPlugin:{}, tooltip:{mode:'index', intersect:false} },
        scales:{ x:{ grid:{ display:false }, ticks:{ color:'#334155' } },
                 y:{ grid:{ color:'#e2e8f0' }, ticks:{ color:'#334155' }, beginAtZero:true },
                 y1:{ position:'right', grid:{ drawOnChartArea:false }, ticks:{ color:'#334155' }, beginAtZero:true } }
      }
    });

    // Build journal aggregates once
    const agg = collectJournalAgg();

    // IF Top (quartile colored)
    renderIFTop(agg);

    // IF × Publications (matrix)
    renderIFMatrix(agg);

    // Top journals citations (matrix)
    renderCitationsMatrix(agg);

    // Other charts (types, subjects, authors, retractions)
    renderTypesYear(); renderSubjects(); renderHomeAuthors(); renderRetract();
  }

  function collectJournalAgg(){
    const byJournal = new Map();
    for (const p of filtered){
      const j=(p.journal||'').trim(); if (!j) continue;
      const o = byJournal.get(j) || {issns:new Set(), count:0, cites:0};
      (p.issns||[]).forEach(x=>o.issns.add(normIssn(x)));
      o.count++; o.cites += Number(p.citations||0);
      byJournal.set(j,o);
    }
    const rows=[];
    for (const [j,o] of byJournal.entries()){
      const metaIF = metricIFForJournal(j, o.issns);
      const q = metricQuartileForJournal(j, o.issns) || '';
      if (metaIF && metaIF.value>0){
        rows.push({journal:j, ifv:metaIF.value, count:o.count, cites:o.cites, q});
      }
    }
    IFcount = rows.length;
    return rows;
  }

  function renderIFTop(rows){
    const ctxTop = document.getElementById('chartIFTop').getContext('2d');
    if (chartIFTop) chartIFTop.destroy();
    const note = document.getElementById('ifTopNote');
    if (!rows.length){ note.textContent='No IF data found in your uploaded file (try including an “Impact Factor / JIF” column).'; return; }
    note.textContent='';

    const top = rows.slice().sort((a,b)=>b.ifv-a.ifv).slice(0,12);
    const colors = top.map(r => ({'Q1':clr.q1,'Q2':clr.q2,'Q3':clr.q3,'Q4':clr.q4}[r.q] || '#06b6d4'));

    chartIFTop = new Chart(ctxTop, {
      type:'bar',
      data:{ labels:top.map(r=>r.journal), datasets:[{ label:'IF', data:top.map(r=>r.ifv), borderRadius:12, borderSkipped:false, backgroundColor:colors }] },
      options:{
        indexAxis:'y', responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, shadowPlugin:{}, tooltip:{ callbacks:{
          label: (ctx)=> `IF: ${ctx.parsed.x}`,
          afterLabel:(ctx)=>{ const q=top[ctx.dataIndex].q; return q?`Quartile: ${q}`:''; }
        }}},
        scales:{ x:{ beginAtZero:true, grid:{ color:'#e2e8f0' }, ticks:{ color:'#334155' } }, y:{ grid:{ display:false }, ticks:{ color:'#334155' } } }
      }
    });
  }

  /* ---------- Matrix helpers ---------- */
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  function niceStep(max, maxBins=12){
    if (max<=0) return 1;
    const raw = max/maxBins;
    const pow = Math.pow(10, Math.floor(Math.log10(raw)));
    const r = raw/pow;
    const nice = (r<=1)?1:(r<=2)?2:(r<=5)?5:10;
    return nice*pow;
  }
  const heatColor = (v, vmin, vmax) => {
    if (vmax<=vmin) return 'hsl(190 70% 50% / .85)';
    const t = (v - vmin) / (vmax - vmin); // 0..1
    const hue = 200 - 120*t; // teal -> green
    const light = 80 - 40*t;
    return `hsl(${hue} 80% ${light}% / .9)`;
  };

  function renderIFMatrix(rows){
    const ctx = document.getElementById('chartIFMatrix').getContext('2d');
    if (chartIFMatrix) chartIFMatrix.destroy();
    const note = document.getElementById('ifBubNote');

    if (!rows.length){ note.textContent='No IF data found in your uploaded file.'; return; }
    note.textContent='';

    const minIF = Math.floor(Math.min(...rows.map(r=>r.ifv)));
    const maxIF = Math.ceil(Math.max(...rows.map(r=>r.ifv)));
    const maxCnt = Math.max(...rows.map(r=>r.count));

    const xStep = Math.max(1, Math.round(niceStep(maxIF-minIF, 10)));
    const yStep = Math.max(1, Math.round(niceStep(maxCnt, 10)));
    const xBins = []; for (let x=minIF; x<=maxIF; x+=xStep) xBins.push([x, x+xStep]);
    const yBins = []; for (let y=0; y<=maxCnt; y+=yStep) yBins.push([y, y+yStep]);

    // Build grid counts (#journals per cell)
    const grid = Array.from({length:xBins.length},()=>Array(yBins.length).fill(0));
    for (const r of rows){
      const xi = clamp(Math.floor((r.ifv - minIF)/xStep),0,xBins.length-1);
      const yi = clamp(Math.floor((r.count)/yStep),0,yBins.length-1);
      grid[xi][yi] += 1;
    }
    const vmax = Math.max(1, ...grid.flat());
    const vmin = 0;

    // dataset for matrix plugin: x=index, y=index, v=value
    const data=[];
    for (let i=0;i<xBins.length;i++){
      for (let j=0;j<yBins.length;j++){
        data.push({x:i, y:j, v:grid[i][j], width:1, height:1});
      }
    }

    chartIFMatrix = new Chart(ctx, {
      type:'matrix',
      data:{ datasets:[{
        label:'Journals',
        data,
        backgroundColor:ctx => heatColor(ctx.raw.v, vmin, vmax),
        borderColor:'rgba(15,23,42,.08)', borderWidth:1
      }]},
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{
          title:(items)=>{ const {x,y} = items[0].raw; const xl=xBins[x], yl=yBins[y]; return `IF ${xl[0]}–${xl[1]} · Pubs ${yl[0]}–${yl[1]}`; },
          label:(item)=> `Journals: ${item.raw.v}`
        }}, shadowPlugin:{}},
        scales:{
          x:{ type:'linear', min:-0.5, max:xBins.length-0.5, grid:{color:'#e2e8f0'}, ticks:{
            color:'#334155',
            callback:(v)=>{ const i=Math.round(v); if (i<0||i>=xBins.length) return ''; const b=xBins[i]; return `${b[0]}–${b[1]}`; }
          }, title:{display:true, text:'Impact Factor (IF)'}},
          y:{ type:'linear', min:-0.5, max:yBins.length-0.5, grid:{color:'#e2e8f0'}, ticks:{
            color:'#334155',
            callback:(v)=>{ const i=Math.round(v); if (i<0||i>=yBins.length) return ''; const b=yBins[i]; return `${b[0]}–${b[1]}`; }
          }, title:{display:true, text:'Publications (view)'}, reverse:true }
        }
      }
    });
  }

  function renderCitationsMatrix(rows){
    const ctx = document.getElementById('chartCitesMatrix').getContext('2d');
    if (chartCitesMatrix) chartCitesMatrix.destroy();

    // Top 12 journals by citations
    const top = rows.slice().sort((a,b)=>b.cites-a.cites).slice(0,12);
    if (!top.length){
      chartCitesMatrix = new Chart(ctx, { type:'bar', data:{labels:[],datasets:[]}, options:{plugins:{legend:{display:false}}, scales:{}}});
      return;
    }

    // Citation range bins
    const maxC = Math.max(...top.map(r=>r.cites));
    const step = niceStep(maxC, 8);
    const cBins=[]; for (let c=0;c<=maxC;c+=step) cBins.push([c, c+step]);

    // Build one-hot matrix (row = journal, column = range)
    const data=[];
    top.forEach((r,rowIdx)=>{
      const col = clamp(Math.floor(r.cites/step), 0, cBins.length-1);
      data.push({x:col, y:rowIdx, v:r.cites, width:1, height:1});
    });

    const vmax=Math.max(...data.map(d=>d.v));
    const vmin=Math.min(...data.map(d=>d.v));

    chartCitesMatrix = new Chart(ctx, {
      type:'matrix',
      data:{ datasets:[{
        label:'Citations',
        data,
        backgroundColor:c=>heatColor(c.raw.v, vmin, vmax),
        borderColor:'rgba(15,23,42,.08)', borderWidth:1
      }]},
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{
          title:(items)=>{ const {x,y,v} = items[0].raw; return `${top[y].journal}`; },
          label:(item)=>{ const {x,v}=item.raw; const b=cBins[x]; return `Citations: ${v} (range ${b[0]}–${b[1]})`; }
        }}, shadowPlugin:{}},
        scales:{
          x:{ type:'linear', min:-0.5, max:cBins.length-0.5, grid:{color:'#e2e8f0'}, ticks:{ color:'#334155',
            callback:(v)=>{ const i=Math.round(v); if (i<0||i>=cBins.length) return ''; const b=cBins[i]; return `${b[0]}–${b[1]}`; }
          }, title:{display:true, text:'Citation ranges'}},
          y:{ type:'linear', min:-0.5, max:top.length-0.5, grid:{color:'#e2e8f0'}, ticks:{ color:'#334155',
            callback:(v)=>{ const i=Math.round(v); if (i<0||i>=top.length) return ''; return top[i].journal; }
          }, reverse:true }
        }
      }
    });
  }

  /* -------- other small charts (unchanged from your last working script) -------- */
  function renderTypesYear(){
    const ctx = document.getElementById('chartTypesYear').getContext('2d');
    const map=new Map(), setTypes=new Set();
    for (const p of filtered){
      const y=p.year; if (y==null) continue;
      const t=normalizeType(p.type || p.type_crossref);
      setTypes.add(t);
      const row=map.get(y)||{}; row[t]=(row[t]||0)+1; map.set(y,row);
    }
    const years=[...map.keys()].sort((a,b)=>a-b);
    const types=[...setTypes];
    const datasets = types.map((t,i)=>({
      label:labelForType(t),
      data:years.map(y=> (map.get(y)||{})[t]||0 ),
      stack:'types',
      backgroundColor:`hsl(${(i*47)%360} 70% 55% / .85)`
    }));
    if (chartTypesYear) chartTypesYear.destroy();
    chartTypesYear = new Chart(ctx, {
      type:'bar', data:{ labels:years, datasets },
      options:{ responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{position:'top'}, shadowPlugin:{} },
        scales:{ x:{ stacked:true, grid:{display:false}, ticks:{color:'#334155'} }, y:{ stacked:true, beginAtZero:true, grid:{ color:'#e2e8f0' }, ticks:{color:'#334155'} } }
      }
    });
  }
  function extractSubjects(p){
    if (Array.isArray(p.subjects) && p.subjects.length) return p.subjects.slice(0,3).join(', ');
    if (Array.isArray(p.concepts) && p.concepts.length){
      const arr = p.concepts.map(c=>c.display_name||c.name||'').filter(Boolean).slice(0,3); return arr.join(', ');
    }
    return '';
  }
  function extractSubjectsList(p){
    if (Array.isArray(p.subjects) && p.subjects.length) return p.subjects.slice(0,1);
    if (Array.isArray(p.concepts) && p.concepts.length) return p.concepts.map(c=>c.display_name||c.name||'').filter(Boolean).slice(0,1);
    return [];
  }
  function renderSubjects(){
    const ctx = document.getElementById('chartSubjects').getContext('2d');
    const counts=new Map();
    for (const p of filtered){ for (const s of extractSubjectsList(p)){ counts.set(s,(counts.get(s)||0)+1); } }
    const top=[...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);
    if (chartSubjects) chartSubjects.destroy();
    chartSubjects = new Chart(ctx, {
      type:'bar',
      data:{ labels: top.map(x=>x[0]), datasets:[{label:'Count', data:top.map(x=>x[1]), borderRadius:12, borderSkipped:false, backgroundColor:gradH(ctx, clr.indigo, clr.purple)}]},
      options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, shadowPlugin:{} },
        scales:{ x:{ grid:{ color:'#e2e8f0' }, ticks:{color:'#334155'}, beginAtZero:true }, y:{ grid:{ display:false }, ticks:{color:'#334155'} } }
      }
    });
  }
  function renderHomeAuthors(){
    const ctx = document.getElementById('chartHomeAuthors').getContext('2d');
    const counts=new Map();
    for (const p of filtered){
      const arr = Array.isArray(p.home_authors)?p.home_authors:deriveHomeAuthors(p);
      for (const a of arr){ counts.set(a,(counts.get(a)||0)+1); }
    }
    const top=[...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,15);
    if (chartHomeAuthors) chartHomeAuthors.destroy();
    chartHomeAuthors = new Chart(ctx, {
      type:'bar',
      data:{ labels: top.map(x=>x[0]), datasets:[{label:'Pubs', data:top.map(x=>x[1]), borderRadius:12, borderSkipped:false, backgroundColor:gradH(ctx, clr.teal, clr.cyan)}]},
      options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, shadowPlugin:{} },
        scales:{ x:{ grid:{ color:'#e2e8f0' }, ticks:{color:'#334155'}, beginAtZero:true }, y:{ grid:{ display:false }, ticks:{color:'#334155'} } }
      }
    });
  }
  function renderRetract(){
    const ctx = document.getElementById('chartRetract').getContext('2d');
    const byYearFlag=new Map(), byYearNotice=new Map();
    for (const p of filtered){
      if (!p.year) continue;
      if (p.is_retracted) byYearFlag.set(p.year,(byYearFlag.get(p.year)||0)+1);
      if (p.retraction_notice) byYearNotice.set(p.year,(byYearNotice.get(p.year)||0)+1);
    }
    const years=[...new Set([...byYearFlag.keys(),...byYearNotice.keys()])].sort((a,b)=>a-b);
    if (chartRetract) chartRetract.destroy();
    chartRetract = new Chart(ctx, {
      type:'line',
      data:{ labels:years, datasets:[
        { label:'OpenAlex retracted', data:years.map(y=>byYearFlag.get(y)||0), borderColor:clr.q4, tension:.25, pointRadius:2 },
        { label:'Retraction notices (title)', data:years.map(y=>byYearNotice.get(y)||0), borderColor:clr.q3, tension:.25, pointRadius:2 }
      ]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'top'}, shadowPlugin:{} },
        scales:{ x:{ grid:{ display:false }, ticks:{color:'#334155'} }, y:{ beginAtZero:true, grid:{ color:'#e2e8f0' }, ticks:{color:'#334155'} } }
      }
    });
  }

  /* --------------- SDG chart --------------- */
  function renderSDGChart(){
    const el = document.getElementById('chartSDG'); if (!el) return;
    const ctx = el.getContext('2d');
    const counts = new Array(18).fill(0);
    for (const p of filtered){ for (const id of (p.sdg_tags||[])) counts[id]++; }
    if (chartSDG) chartSDG.destroy();
    const labels = SDG_LIST.map(s=>`${s.id}`), data = SDG_LIST.map(s=>counts[s.id]||0), colors = SDG_LIST.map(s=>SDG_COLORS[s.id]);
    chartSDG = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[{ label:'Count', data, borderRadius:12, borderSkipped:false, backgroundColor:colors }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, shadowPlugin:{}, tooltip:{mode:'index', intersect:false} },
        scales:{ x:{ grid:{ display:false }, ticks:{ color:'#334155' } }, y:{ grid:{ color:'#e2e8f0' }, ticks:{ color:'#334155' }, beginAtZero:true } }
      }
    });
  }

  /* ============== Focus modal (real interactive charts) ============== */
  let focusChart=null;
  const focusBuilders = {
    year: () => { const c=document.getElementById('chartByYear'); return cloneChart(c,'Publications by Year (focus)'); },
    ifTop: () => buildIFTopFocus(),
    ifMatrix: () => buildIFMatrixFocus(),
    citesMatrix: () => buildCitesMatrixFocus()
  };

  function openFocus(key){
    const modal=document.getElementById('focusModal'); const title=document.getElementById('focusTitle');
    const canvas=document.getElementById('focusCanvas'); const ctx=canvas.getContext('2d');
    if (focusChart){ focusChart.destroy(); focusChart=null; }
    if (focusBuilders[key]){
      const out = focusBuilders[key](); // builder will build on focus canvas
      if (out && out.title) title.textContent = out.title;
      modal.classList.add('open');
    }
    lucide.createIcons();
  }
  function closeFocus(){
    if (focusChart){ focusChart.destroy(); focusChart=null; }
    document.getElementById('focusModal').classList.remove('open');
  }
  window.addEventListener('keydown', e=>{ if (e.key==='Escape') closeFocus(); });

  function cloneChart(srcCanvas, title){
    const cfg = srcCanvas.__chartist__ ? srcCanvas.__chartist__.config : null;
    const ctx=document.getElementById('focusCanvas').getContext('2d');
    // Build a new config from current data if available
    const srcChart = Chart.getChart(srcCanvas);
    if (!srcChart){ return { title }; }
    const big = JSON.parse(JSON.stringify(srcChart.config));
    big.options.maintainAspectRatio=false;
    big.options.responsive=true;
    big.options.plugins = big.options.plugins || {};
    big.options.plugins.legend = big.options.plugins.legend || {};
    big.options.plugins.legend.labels = big.options.plugins.legend.labels || {};
    big.options.plugins.legend.labels.font = { size: 13 };
    if (big.options.scales){
      for (const k of Object.keys(big.options.scales)){
        big.options.scales[k].ticks = big.options.scales[k].ticks || {};
        big.options.scales[k].ticks.font = { size: 12 };
      }
    }
    if (focusChart) focusChart.destroy();
    focusChart = new Chart(ctx, big);
    return { title };
  }

  function buildIFTopFocus(){
    const rows = collectJournalAgg();
    const ctx = document.getElementById('focusCanvas').getContext('2d');
    const top = rows.slice().sort((a,b)=>b.ifv-a.ifv).slice(0,20);
    const colors = top.map(r => ({'Q1':clr.q1,'Q2':clr.q2,'Q3':clr.q3,'Q4':clr.q4}[r.q] || '#06b6d4'));
    if (focusChart) focusChart.destroy();
    focusChart = new Chart(ctx, {
      type:'bar',
      data:{ labels:top.map(r=>r.journal), datasets:[{ label:'IF', data:top.map(r=>r.ifv), borderRadius:12, borderSkipped:false, backgroundColor:colors }] },
      options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, shadowPlugin:{} },
        scales:{ x:{ grid:{ color:'#e2e8f0' } }, y:{ grid:{ display:false } } }
      }
    });
    return { title:'Journal Impact — Top by IF (focus)' };
  }
  function buildIFMatrixFocus(){
    const rows = collectJournalAgg();
    const ctx = document.getElementById('focusCanvas').getContext('2d');
    if (focusChart) focusChart.destroy();

    // reuse same binning as renderIFMatrix
    const minIF = Math.floor(Math.min(...rows.map(r=>r.ifv))); const maxIF = Math.ceil(Math.max(...rows.map(r=>r.ifv)));
    const maxCnt = Math.max(...rows.map(r=>r.count)); const xStep=Math.max(1,Math.round(niceStep(maxIF-minIF,12))); const yStep=Math.max(1,Math.round(niceStep(maxCnt,12)));
    const xBins=[]; for (let x=minIF; x<=maxIF; x+=xStep) xBins.push([x,x+xStep]); const yBins=[]; for (let y=0; y<=maxCnt; y+=yStep) yBins.push([y,y+yStep]);
    const grid = Array.from({length:xBins.length},()=>Array(yBins.length).fill(0));
    for (const r of rows){ const xi=clamp(Math.floor((r.ifv-minIF)/xStep),0,xBins.length-1); const yi=clamp(Math.floor((r.count)/yStep),0,yBins.length-1); grid[xi][yi]+=1; }
    const vmax=Math.max(1,...grid.flat()); const vmin=0;
    const data=[]; for (let i=0;i<xBins.length;i++){ for (let j=0;j<yBins.length;j++){ data.push({x:i,y:j,v:grid[i][j],width:1,height:1}); } }
    focusChart = new Chart(ctx, {
      type:'matrix',
      data:{ datasets:[{ data, backgroundColor:c=>heatColor(c.raw.v,vmin,vmax), borderColor:'rgba(15,23,42,.08)', borderWidth:1 }]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, shadowPlugin:{} },
        scales:{ x:{ type:'linear', min:-0.5, max:xBins.length-0.5, grid:{color:'#e2e8f0'}, ticks:{ callback:(v)=>{ const i=Math.round(v); if(i<0||i>=xBins.length) return ''; const b=xBins[i]; return `${b[0]}–${b[1]}`; } }, title:{display:true,text:'IF'} },
                y:{ type:'linear', min:-0.5, max:yBins.length-0.5, grid:{color:'#e2e8f0'}, ticks:{ callback:(v)=>{ const i=Math.round(v); if(i<0||i>=yBins.length) return ''; const b=yBins[i]; return `${b[0]}–${b[1]}`; } }, title:{display:true,text:'Publications'}, reverse:true } }
      }
    });
    return { title:'Journal Impact — IF × Publications (focus)' };
  }
  function buildCitesMatrixFocus(){
    const rows = collectJournalAgg(); const ctx = document.getElementById('focusCanvas').getContext('2d'); if (focusChart) focusChart.destroy();
    const top = rows.slice().sort((a,b)=>b.cites-a.cites).slice(0,20);
    const maxC = Math.max(...top.map(r=>r.cites)); const step = niceStep(maxC, 10); const cBins=[]; for (let c=0;c<=maxC;c+=step) cBins.push([c,c+step]);
    const data=[]; top.forEach((r,rowIdx)=>{ const col=clamp(Math.floor(r.cites/step),0,cBins.length-1); data.push({x:col,y:rowIdx,v:r.cites,width:1,height:1}); });
    const vmax=Math.max(...data.map(d=>d.v)); const vmin=Math.min(...data.map(d=>d.v));
    focusChart = new Chart(ctx, {
      type:'matrix',
      data:{ datasets:[{ data, backgroundColor:c=>heatColor(c.raw.v,vmin,vmax), borderColor:'rgba(15,23,42,.08)', borderWidth:1 }]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, shadowPlugin:{} },
        scales:{ x:{ type:'linear', min:-0.5, max:cBins.length-0.5, grid:{color:'#e2e8f0'}, ticks:{ callback:(v)=>{ const i=Math.round(v); if(i<0||i>=cBins.length) return ''; const b=cBins[i]; return `${b[0]}–${b[1]}`; } }, title:{display:true,text:'Citation ranges'} },
                y:{ type:'linear', min:-0.5, max:top.length-0.5, grid:{color:'#e2e8f0'}, ticks:{ callback:(v)=>{ const i=Math.round(v); if(i<0||i>=top.length) return ''; return top[i].journal; } }, reverse:true } }
      }
    });
    return { title:'Top Journals — Total Citations (focus)' };
  }

  /* ============== Utils ============== */
  const esc = s => String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const q = s => `"${String(s).replace(/"/g,'""')}"`;
  const num = n => (n||0).toLocaleString();
  const normTitle = t => String(t||'').toLowerCase().replace(/\s+/g,' ').trim();
  const normIssn = s => { const x=String(s||'').replace(/[^0-9xX]/g,'').toUpperCase(); const eight = x.length===8 ? x : (x.length===7 ? '0'+x : ''); return eight ? (eight.slice(0,4)+'-'+eight.slice(4)) : ''; };
  const normQuartile = q => { const s=String(q||'').toUpperCase(); const m = s.match(/Q([1-4])/); return m ? `Q${m[1]}` : ''; };
  const smartSplit=(line,delim)=>{ const out=[]; let cur=''; let inQ=false; for (let i=0;i<line.length;i++){ const ch=line[i]; if (ch==='\"'){ inQ=!inQ; continue; } if (ch===delim && !inQ){ out.push(cur.trim()); cur=''; continue; } cur+=ch; } out.push(cur.trim()); return out; };
  const findIndex=(arr,pred)=>{ for (let i=0;i<arr.length;i++){ if (pred(arr[i])) return i; } return -1; };
  const extractIssns = cell => [...new Set(String(cell||'').split(/[\/,;|\s]+/).map(normIssn).filter(Boolean))];

  function updateCoverage(){
    let mapped=0,total=filtered.length; for (const p of filtered) if (quartileOf(p)) mapped++;
    const pct= total? Math.round(mapped*100/total):0;
    const el=document.getElementById('mapCoverage'); if (el) el.textContent = `${mapped} / ${total} in current view mapped (${pct}%)`;
  }

  /* ====== SDG heuristics ====== */
  function guessSDGs(p){
    const text = [(p.title||''),(p.journal||''),extractSubjects(p)].join(' ').toLowerCase();
    const hits=[]; for (const s of SDG_LIST){ for (const kw of s.kw){ if (text.includes(kw.toLowerCase())){ hits.push(s.id); break; } } }
    return Array.from(new Set(hits)).slice(0,2);
  }
  function buildSDGLegend(){
    const box=document.getElementById('sdgLegend'); if (!box) return; box.innerHTML='';
    for (const s of SDG_LIST){
      box.insertAdjacentHTML('beforeend', `<span class="badge" title="${s.name}" style="border-color:${SDG_COLORS[s.id]};background:#fff">${s.id} — ${s.name}</span>`);
    }
  }

  // Init
  document.addEventListener('DOMContentLoaded', ()=>{ autoLoad(); });
</script>
</body>
</html>
