<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI Publications Portal</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- Day.js + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Matrix (for IF heatmap) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1"></script>

  <style>
    .card{background:rgba(255,255,255,.92);border:1px solid rgba(226,232,240,.92);
      border-radius:16px;box-shadow:0 12px 24px rgba(15,23,42,.08)}
    .thin-scrollbar::-webkit-scrollbar{height:8px;width:8px}
    .thin-scrollbar::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:6px}
    .thin-scrollbar::-webkit-scrollbar-track{background:#F8FAFC}
    .tab-active{color:#111827;border-color:#7c3aed;background:linear-gradient(180deg,#fff,#f8fafc)}
    .tab-inactive{color:#6B7280;border-color:transparent}
    .dropdown{position:relative}
    .dropdown-panel{position:absolute;right:0;top:100%;z-index:40}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .5rem;border-radius:999px;
      font-size:.72rem;border:1px solid #e2e8f0;background:#f8fafc}
    .icon-btn{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .5rem;
      border:1px solid #e5e7eb;border-radius:10px;background:#f8fafc}
    .icon-btn:hover{background:#eef2ff;border-color:#c7d2fe}
    .focus-overlay{position:fixed;inset:0;background:rgba(2,6,23,.7);backdrop-filter:blur(2px);z-index:60}
  </style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900">

  <!-- Header -->
  <header class="sticky top-0 z-30 bg-gradient-to-r from-indigo-600/90 via-fuchsia-600/90 to-sky-600/90 text-white backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-white/15 grid place-content-center shadow-inner">
          <i data-lucide="panel-top" class="text-white"></i>
        </div>
        <div>
          <h1 class="text-lg font-semibold tracking-tight">AI Publications Portal</h1>
          <div id="lastSynced" class="text-xs text-white/80">Loading…</div>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-2 text-xs">
        <span class="px-2 py-1 rounded-lg bg-white/10 border border-white/20">Static JSON · No live API</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white">
      <div class="max-w-7xl mx-auto px-4">
        <nav class="flex gap-2">
          <button id="tabOverview" class="px-4 py-3 text-sm border-b-2 tab-active"   onclick="switchTab('overview')">Overview</button>
          <button id="tabPublications" class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('publications')">Publications</button>
          <button id="tabQuartiles" class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('quartiles')">Quartiles</button>
          <button id="tabSDG" class="px-4 py-3 text-sm border-b-2 tab-inactive" onclick="switchTab('sdg')">SDGs</button>
        </nav>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- OVERVIEW -->
    <section id="view-overview" class="space-y-6">
      <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
        <div class="card p-4"><div class="text-xs text-slate-500">Total items</div><div id="kpiTotal" class="mt-1 text-2xl font-semibold">—</div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Current view</div><div id="kpiView" class="mt-1 text-2xl font-semibold">—</div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Retracted (view)</div><div id="kpiRetr" class="mt-1 text-2xl font-semibold">—</div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Distinct journals (view)</div><div id="kpiJournals" class="mt-1 text-2xl font-semibold">—</div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">IF records loaded</div><div id="kpiIF" class="mt-1 text-2xl font-semibold">—</div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Quartile-mapped (view)</div><div id="kpiQMap" class="mt-1 text-2xl font-semibold">—</div></div>
      </div>

      <!-- Row: By year (left) + Top Journals Citations (right) -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Publications by Year (with cumulative)</h3>
            <div class="flex items-center gap-2">
              <span id="rangeText" class="text-xs text-slate-500"></span>
              <button class="icon-btn" onclick="openChartData('chartByYear')"><i data-lucide='database'></i><span class="hidden sm:inline">Data</span></button>
              <button class="icon-btn" onclick="focusCanvas('chartByYear','Publications by Year (with cumulative)')"><i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span></button>
            </div>
          </div>
          <div class="mt-2 h-[280px]"><canvas id="chartByYear"></canvas></div>
        </div>

        <!-- Right column: only the Total Citations chart (Quartiles chart removed) -->
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Top Journals — Publications vs Citations (view)</h3>
            <div class="flex items-center gap-2">
              <button class="icon-btn" onclick="openChartData('chartTopJournalsC')"><i data-lucide='database'></i><span class="hidden sm:inline">Data</span></button>
              <button class="icon-btn" onclick="focusCanvas('chartTopJournalsC','Top Journals — Publications vs Citations')"><i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span></button>
            </div>
          </div>
          <div class="mt-2 h-[280px]"><canvas id="chartTopJournalsC"></canvas></div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Journal Impact — Top by IF (from upload)</h3>
            <div class="flex items-center gap-2">
              <button class="icon-btn" onclick="openChartData('chartIFTop')"><i data-lucide='database'></i><span class="hidden sm:inline">Data</span></button>
              <button class="icon-btn" onclick="focusCanvas('chartIFTop','Journal Impact — Top by IF')"><i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span></button>
            </div>
          </div>
          <div class="mt-2 h-[320px]"><canvas id="chartIFTop"></canvas></div>
          <div id="ifTopNote" class="text-xs text-slate-500 mt-2"></div>
        </div>
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Journal Impact — IF vs Publications (heatmap)</h3>
            <div class="flex items-center gap-2">
              <button class="icon-btn" onclick="openChartData('chartIFBubble')"><i data-lucide='database'></i><span class="hidden sm:inline">Data</span></button>
              <button class="icon-btn" onclick="focusCanvas('chartIFBubble','Journal Impact — IF vs Publications')"><i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span></button>
            </div>
          </div>
          <div class="mt-2 h-[320px]"><canvas id="chartIFBubble"></canvas></div>
          <div id="ifBubNote" class="text-xs text-slate-500 mt-2"></div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Types by Year (view)</h3>
            <div class="flex items-center gap-2">
              <button class="icon-btn" onclick="openChartData('chartTypesYear')"><i data-lucide='database'></i><span class="hidden sm:inline">Data</span></button>
              <button class="icon-btn" onclick="focusCanvas('chartTypesYear','Types by Year (view)')"><i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span></button>
            </div>
          </div>
          <div class="mt-2 h-[300px]"><canvas id="chartTypesYear"></canvas></div>
        </div>
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Top Subjects / Concepts (view)</h3>
            <div class="flex items-center gap-2">
              <button class="icon-btn" onclick="openChartData('chartSubjects')"><i data-lucide='database'></i><span class="hidden sm:inline">Data</span></button>
              <button class="icon-btn" onclick="focusCanvas('chartSubjects','Top Subjects / Concepts (view)')"><i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span></button>
            </div>
          </div>
          <div class="mt-2 h-[300px]"><canvas id="chartSubjects"></canvas></div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Top Home Authors (institution authors)</h3>
            <div class="flex items-center gap-2">
              <button class="icon-btn" onclick="openChartData('chartHomeAuthors')"><i data-lucide='database'></i><span class="hidden sm:inline">Data</span></button>
              <button class="icon-btn" onclick="focusCanvas('chartHomeAuthors','Top Home Authors (institution authors)')"><i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span></button>
            </div>
          </div>
          <div class="mt-2 h-[300px]"><canvas id="chartHomeAuthors"></canvas></div>
        </div>
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Retractions by Year (OpenAlex flag + notices)</h3>
            <div class="flex items-center gap-2">
              <button class="icon-btn" onclick="openChartData('chartRetract')"><i data-lucide='database'></i><span class="hidden sm:inline">Data</span></button>
              <button class="icon-btn" onclick="focusCanvas('chartRetract','Retractions by Year')"><i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span></button>
            </div>
          </div>
          <div class="mt-2 h-[300px]"><canvas id="chartRetract"></canvas></div>
        </div>
      </div>

      <!-- Publishers -->
      <div class="grid grid-cols-1 gap-4">
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Publishers — Distinct Journals (view)</h3>
            <div class="flex items-center gap-2">
              <button class="icon-btn" onclick="openChartData('chartPublishers')"><i data-lucide='database'></i><span class="hidden sm:inline">Data</span></button>
              <button class="icon-btn" onclick="focusCanvas('chartPublishers','Publishers — Distinct Journals (view)')"><i data-lucide="maximize-2"></i><span class="hidden sm:inline">Focus</span></button>
            </div>
          </div>
          <div class="mt-2 h-[300px]"><canvas id="chartPublishers"></canvas></div>
          <div class="text-xs text-slate-500 mt-2">Counts unique journal titles per publishing house (heuristic mapping).</div>
        </div>
      </div>
    </section>

    <!-- PUBLICATIONS (unchanged, uses global filters) -->
    <section id="view-publications" class="hidden space-y-4">
      <!-- … your existing table + global filters (unchanged from your working file) … -->
    </section>

    <!-- QUARTILES -->
    <section id="view-quartiles" class="hidden space-y-4">
      <!-- … unchanged from your working file … -->
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold">Quartile & IF Mapping</h3>
            <p class="text-xs text-slate-500">Upload SCImago/Clarivate CSV/JSON (Title or ISSN; any Quartile/JIF/IF columns).</p>
          </div>
          <div class="flex items-center gap-2">
            <input id="sjrFile" type="file" accept=".csv,.json" class="hidden"/>
            <button class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-300 text-sm" onclick="document.getElementById('sjrFile').click()">
              <i data-lucide="upload"></i> Upload Quartiles
            </button>
          </div>
        </div>
        <div id="sjrStatus" class="mt-2 text-xs text-slate-500"></div>
      </div>

      <div class="card p-4">
        <h4 class="font-semibold mb-2">Coverage in current view</h4>
        <div class="text-sm" id="mapCoverage">—</div>
      </div>
    </section>

    <!-- SDG -->
    <section id="view-sdg" class="hidden space-y-4">
      <!-- … unchanged core … -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4">
          <h4 class="font-semibold flex items-center justify-between">
            <span>SDG Distribution (view)</span>
            <div class="flex items-center gap-2">
              <button class="icon-btn" onclick="openChartData('chartSDG')"><i data-lucide='database'></i><span class="hidden sm:inline">Data</span></button>
              <button class="icon-btn" onclick="focusCanvas('chartSDG','SDG Distribution (view)')"><i data-lucide="maximize-2"></i></button>
            </div>
          </h4>
          <div class="mt-2 h-[280px]"><canvas id="chartSDG"></canvas></div>
        </div>
        <div class="card p-4">
          <h4 class="font-semibold mb-2">Legend</h4>
          <div id="sdgLegend" class="flex flex-wrap gap-2 text-sm"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="text-center text-xs text-slate-500 pb-8">
    Data from <code>institution_data.json</code> · Quartiles/IF mapped client-side · SDG & Retraction notices are heuristic
  </footer>

  <!-- Focus modal: LIVE chart -->
  <div id="focusOverlay" class="focus-overlay hidden">
    <div class="absolute inset-0 grid place-items-center p-4" onclick="closeFocus()">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[85vh] p-4 relative overflow-hidden" onclick="event.stopPropagation()">
        <button class="icon-btn absolute top-3 right-3" onclick="closeFocus()"><i data-lucide="x"></i></button>
        <div class="flex items-center justify-between border-b pb-2 mb-3">
          <div id="focusTitle" class="font-semibold"></div>
        </div>
        <div class="w-full h-[calc(100%-3rem)]">
          <canvas id="focusCanvas" class="w-full h-full"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Reusable per-chart DATA panel -->
  <div id="chartDataPanel" class="hidden fixed z-50 bg-white border border-slate-200 rounded-xl shadow-xl p-3 w-80"></div>

<script>
/* ---------------- boot ---------------- */
lucide.createIcons();
Chart.defaults.font.family = "'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
Chart.defaults.plugins.tooltip.backgroundColor = '#0f172a';
Chart.defaults.plugins.tooltip.borderColor = '#334155';
Chart.defaults.plugins.tooltip.borderWidth = 1;
Chart.defaults.plugins.tooltip.padding = 12;
Chart.defaults.plugins.legend.labels.boxWidth = 10;

const shadowPlugin = {
  id: 'shadowPlugin',
  beforeDatasetsDraw(chart){ const {ctx}=chart; ctx.save(); ctx.shadowColor='rgba(2,6,23,.12)'; ctx.shadowBlur=14; ctx.shadowOffsetY=6; },
  afterDatasetsDraw(chart){ chart.ctx.restore(); }
};
Chart.register(shadowPlugin);

const clr = { indigo:'#6366f1', purple:'#a855f7', teal:'#14b8a6', cyan:'#06b6d4', q1:'#16a34a', q2:'#3b82f6', q3:'#f59e0b', q4:'#ef4444', gray:'#334155' };
const gradV = (ctx,a,b)=>{ const g=ctx.createLinearGradient(0,0,0,ctx.canvas.height); g.addColorStop(0,a); g.addColorStop(1,b); return g; };
const gradH = (ctx,a,b)=>{ const g=ctx.createLinearGradient(0,0,ctx.canvas.width,0); g.addColorStop(0,a); g.addColorStop(1,b); return g; };

/* ---------------- STATE ---------------- */
let all=[], filtered=[], currentPage=1, pageSize=50;
const HOME_ROR="04q2jes40";
const HOME_KEYWORDS=['university of petroleum','energy studies','upes'];
const selectedTypes=new Set(); let knownTypes=[];

const sjrByIssn=new Map(), sjrByTitle=new Map();
const sjrMetaByIssn=new Map(), sjrMetaByTitle=new Map();
let haveSJR=false; let IFcount=0;

const chartInstances = new Map(); // canvasId -> Chart instance
const perChartFilter = new Map(); // canvasId -> {yearFrom,yearTo,types:Set,retract:'',...}

/* ---- utilities kept from your working file (authors, retractions, SDGs, publishers, etc.) ---- */
/* (Everything below this comment until the rendering functions is unchanged from your working code
   EXCEPT we added getFilteredForChart() and the DATA panel + focus duplication.) */

const RETRACT_PREFIXES=[/^retraction\s*note\s*:/i,/^retraction\s*of\s*:/i,/^retraction\s*:/i,/^notice\s+of\s+retraction\s*:/i,/^withdrawn\s*:/i,/^retracted\s+paper\s*:/i,/^retracted\s+article\s*:/i,/^article\s+retracted\s*:/i];
const DOI_REGEX=/\b(10\.\d{4,9}\/\S+)\b/i;

function switchTab(name){
  const tabs=['overview','publications','quartiles','sdg'];
  for (const t of tabs){
    document.getElementById(`view-${t}`).classList.toggle('hidden', t!==name);
    const el=document.getElementById(`tab${t[0].toUpperCase()+t.slice(1)}`);
    el.classList.toggle('tab-active', t===name);
    el.classList.toggle('tab-inactive', t!==name);
  }
  if (name==='quartiles') updateCoverage();
  if (name==='sdg') renderSDGChart();
}

async function autoLoad(){
  try{
    const res = await fetch('institution_data.json', { cache:'no-store' });
    if (!res.ok) throw new Error('institution_data.json not found');
    const j = await res.json();

    document.getElementById('lastSynced').textContent =
      j.updated ? `Last synced: ${dayjs(j.updated).format('DD MMM YYYY, HH:mm')}` : '';

    all = Array.isArray(j.items) ? j.items : [];

    for (const p of all){
      if (!Array.isArray(p.authors)) p.authors = deriveAuthors(p);
      p.home_authors = deriveHomeAuthors(p);
    }

    buildRetractionIndex(all);
    for (const p of all) p.sdg_tags = guessSDGs(p);

    document.getElementById('kpiTotal').textContent = num(all.length);

    // global selects (years/type/sdg) are part of publications tab in your file — omitted here for brevity
    buildSDGOptions(); buildSDGLegend(); computeKnownTypes(); buildTypePanel?.();

    pageSize=50;
    applyFilters(1);
  }catch(e){
    document.getElementById('lastSynced').textContent = 'Error: '+e.message;
    console.error(e);
  }
}

/* ---------- helpers copied from your working code (trimmed only where not used) ---------- */
function deriveAuthors(p){ const out=[]; if (Array.isArray(p.authorships)){ for (const a of p.authorships){ const nm=a?.author?.display_name||a?.display_name; if (nm) out.push(String(nm)); } } if (!out.length && typeof p.authors==='string'&&p.authors.trim()){ return p.authors.split(/[,;]\s*/).filter(Boolean);} return out;}
function deriveHomeAuthors(p){ const out=[]; if (!Array.isArray(p.authorships)) return out; for (const a of p.authorships){ const nm=a?.author?.display_name||a?.display_name; const insts=Array.isArray(a?.institutions)?a.institutions:[]; const matchROR=insts.some(i=>(i?.ror||'').split('/').pop()===HOME_ROR); const matchKW=insts.some(i=>HOME_KEYWORDS.some(k=>(i?.display_name||'').toLowerCase().includes(k))); if (nm&&(matchROR||matchKW)) out.push(String(nm)); } return [...new Set(out)];}
function buildRetractionIndex(items){ const byTitle=new Map(), byDOI=new Map(); for (const p of items){ if (p.doi) byDOI.set(String(p.doi).toLowerCase(), p); const nt=normTitle(p.title||''); if (nt) byTitle.set(nt,p);} for (const p of items){ const title=p.title||''; p.retraction_notice=isRetractionNotice(title); p.retracted_by=null; p.retraction_of=null; if (p.retraction_notice){ const m=title.match(DOI_REGEX); if (m){ const target=byDOI.get(m[1].toLowerCase()); if (target){ p.retraction_of={doi:target.doi,title:target.title}; target.retracted_by={doi:p.doi,title:p.title}; } } else { const stripped=stripRetractionPrefix(title); const candidate=byTitle.get(normTitle(stripped)); if (candidate){ p.retraction_of={doi:candidate.doi,title:candidate.title}; candidate.retracted_by={doi:p.doi,title:p.title}; } } } } }
const isRetractionNotice=title=>RETRACT_PREFIXES.some(rx=>rx.test(String(title||'')));
const stripRetractionPrefix=title=>{let t=String(title||''); for (const rx of RETRACT_PREFIXES){ if (rx.test(t)) return t.replace(rx,'').trim(); } return t;};

const SDG_LIST=[{id:1,name:'No Poverty',kw:['poverty','low-income','income inequality']},{id:2,name:'Zero Hunger',kw:['hunger','food security','malnutrition','agriculture','crop','farm']},{id:3,name:'Good Health & Well-being',kw:['health','disease','medicine','mental','epidemic','pandemic','hospital','clinical']},{id:4,name:'Quality Education',kw:['education','school','teaching','learning','curriculum','literacy','students']},{id:5,name:'Gender Equality',kw:['gender','women','female','girls','violence against women','equality']},{id:6,name:'Clean Water & Sanitation',kw:['water','sanitation','wastewater','drinking water','hygiene']},{id:7,name:'Affordable & Clean Energy',kw:['energy','renewable','solar','wind','battery','hydrogen']},{id:8,name:'Decent Work & Economic Growth',kw:['employment','workforce','productivity','economy','growth','entrepreneur']},{id:9,name:'Industry, Innovation & Infrastructure',kw:['industry','manufacturing','infrastructure','innovation','iot','robotics','blockchain']},{id:10,name:'Reduced Inequalities',kw:['inequality','social justice','marginalized','inclusion']},{id:11,name:'Sustainable Cities & Communities',kw:['urban','smart city','transport','housing','resilience','disaster']},{id:12,name:'Responsible Consumption & Production',kw:['circular economy','sustainability','recycling','waste','lifecycle','supply chain']},{id:13,name:'Climate Action',kw:['climate','carbon','ghg','emission','adaptation','mitigation','global warming']},{id:14,name:'Life Below Water',kw:['marine','ocean','sea','fisheries','aquatic','coral']},{id:15,name:'Life on Land',kw:['biodiversity','forest','wildlife','ecosystem','soil','land use']},{id:16,name:'Peace, Justice & Strong Institutions',kw:['governance','policy','corruption','crime','justice','conflict']},{id:17,name:'Partnerships for the Goals',kw:['partnership','collaboration','sdg','stakeholder','international']}];
const SDG_COLORS={1:'#E5243B',2:'#DDA63A',3:'#4C9F38',4:'#C5192D',5:'#FF3A21',6:'#26BDE2',7:'#FCC30B',8:'#A21942',9:'#FD6925',10:'#DD1367',11:'#FD9D24',12:'#BF8B2E',13:'#3F7E44',14:'#0A97D9',15:'#56C02B',16:'#00689D',17:'#19486A'};
function buildSDGOptions(){ const opts=SDG_LIST.map(s=>`<option value="${s.id}">${s.id}. ${s.name}</option>`).join(''); const sel1=document.getElementById('sdgFilter'); const sel2=document.getElementById('sdgOnlyFilter'); if (sel1) sel1.innerHTML='<option value="">All SDGs</option>'+opts; if (sel2) sel2.innerHTML='<option value="">All SDGs</option>'+opts;}
function buildSDGLegend(){ const box=document.getElementById('sdgLegend'); if(!box) return; box.innerHTML=''; for (const s of SDG_LIST){ box.insertAdjacentHTML('beforeend', `<span class="badge" title="${s.name}" style="border-color:${SDG_COLORS[s.id]};background:#fff">${s.id} — ${s.name}</span>`);} }
function guessSDGs(p){ const text=[(p.title||''),(p.journal||''),extractSubjects(p)].join(' ').toLowerCase(); const hits=[]; for (const s of SDG_LIST){ for (const kw of s.kw){ if (text.includes(kw.toLowerCase())){ hits.push(s.id); break; } } } return Array.from(new Set(hits)).slice(0,2);}
const normalizeType=t=>{ const s=String(t||'').toLowerCase(); if (s==='journal-article') return 'article'; if (s.includes('proceed')) return 'proceedings-article'; if (s.startsWith('book')) return 'book'; if (s==='book-chapter'||s.includes('chapter')) return 'book'; return s||'unknown';};
const labelForType=key=>({'article':'Article','proceedings-article':'Proceedings','book':'Book/Chapter','dataset':'Dataset','report':'Report','preprint':'Preprint','letter':'Letter','review':'Review','editorial':'Editorial','unknown':'Other'}[key]||key);
function computeKnownTypes(){ const counts=new Map(); for (const p of all){ const k=normalizeType(p.type||p.type_crossref); counts.set(k,(counts.get(k)||0)+1);} knownTypes=[...counts.entries()].sort((a,b)=>b[1]-a[1]).map(([key,count])=>({key,label:labelForType(key),count}));}
function getPublisher(p){ const fields=[p.publisher,p?.host_venue?.publisher,p?.host_venue?.display_name,p?.primary_location?.source?.publisher,p?.primary_location?.source?.host_organization_name,p?.primary_location?.source?.display_name]; let pick=fields.find(v=>typeof v==='string'&&v.trim()); if(pick) return unifyPublisherName(pick); return unifyPublisherName(inferPublisherFromJournal(p.journal||''));}
function unifyPublisherName(s){ const t=(s||'').toString().trim(),x=t.toLowerCase(); if(!t) return 'Other/Unknown'; if(x.includes('elsevier')) return 'Elsevier'; if(x.includes('springer')||x.includes('nature')) return 'Springer Nature'; if(x.includes('wiley')) return 'Wiley'; if(x.includes('taylor')||x.includes('informa')) return 'Taylor & Francis'; if(x.includes('ieee')) return 'IEEE'; if(x.includes('mdpi')) return 'MDPI'; if(x.includes('acm')) return 'ACM'; if(x.includes('sage')) return 'SAGE'; if(x.includes('frontiers')) return 'Frontiers'; if(x.includes('hindawi')) return 'Hindawi'; if(x.includes('oxford')) return 'Oxford Univ Press'; if(x.includes('cambridge')) return 'Cambridge Univ Press'; if(x.includes('ssrn')) return 'SSRN'; if(x.includes('research square')) return 'Research Square'; return t;}
function inferPublisherFromJournal(jname){ const j=(jname||'').toLowerCase(); if(j.includes('ieee')) return 'IEEE'; if(j.includes('springer')) return 'Springer Nature'; if(j.includes('wiley')) return 'Wiley'; if(j.includes('taylor')||j.includes('francis')) return 'Taylor & Francis'; if(j.includes('mdpi')) return 'MDPI'; if(j.includes('acm')) return 'ACM'; if(j.includes('elsevier')||j.includes('sciencedirect')||j.includes('cell press')||j.includes('lancet')) return 'Elsevier'; if(j.includes('frontiers')) return 'Frontiers'; if(j.includes('hindawi')) return 'Hindawi'; if(j.includes('ssrn')) return 'SSRN'; if(j.includes('research square')) return 'Research Square'; return 'Other/Unknown';}
function parseNum(v){ let s=String(v??'').trim(); if(!s) return null; s=s.replace(/\s+/g,''); if(/^\d{1,3}(\.\d{3})+(,\d+)?$/.test(s)) s=s.replace(/\./g,'').replace(',', '.'); else if(/^\d{1,3}(,\d{3})+(\.\d+)?$/.test(s)) s=s.replace(/,/g,''); else { if(s.includes(',')&&!s.includes('.')) s=s.replace(',', '.'); s=s.replace(/,/g,''); } const m=s.match(/-?\d+(\.\d+)?/); return m?parseFloat(m[0]):null;}
const esc=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const num=n=>(n||0).toLocaleString();
const normTitle=t=>String(t||'').toLowerCase().replace(/\s+/g,' ').trim();
const normIssn=s=>{ const x=String(s||'').replace(/[^0-9xX]/g,'').toUpperCase(); const eight=x.length===8?x:(x.length===7?'0'+x:''); return eight?(eight.slice(0,4)+'-'+eight.slice(4)):'';};
const normQuartile=q=>{ const s=String(q||'').toUpperCase(); const m=s.match(/Q([1-4])/); return m?`Q${m[1]}`:'';};
function extractSubjects(p){ if(Array.isArray(p.subjects)&&p.subjects.length) return p.subjects.slice(0,3).join(', '); if(Array.isArray(p.concepts)&&p.concepts.length){ const arr=p.concepts.map(c=>c.display_name||c.name||'').filter(Boolean).slice(0,3); return arr.join(', ');} return '';}
function extractSubjectsList(p){ if(Array.isArray(p.subjects)&&p.subjects.length) return p.subjects.slice(0,1); if(Array.isArray(p.concepts)&&p.concepts.length) return p.concepts.map(c=>c.display_name||c.name||'').filter(Boolean).slice(0,1); return [];}
function quartileOf(p){ return p.quartile || resolveQuartile(p) || ''; }
function resolveQuartile(p){ const issns=(p.issns||[]).map(normIssn).filter(Boolean); for (const id of issns){ if (sjrByIssn.has(id)) return sjrByIssn.get(id); } const t=normTitle(p.journal||''); if (t && sjrByTitle.has(t)) return sjrByTitle.get(t); return ''; }
function updateCoverage(){ let mapped=0,total=filtered.length; for(const p of filtered) if(quartileOf(p)) mapped++; const pct= total? Math.round(mapped*100/total):0; const el=document.getElementById('mapCoverage'); if(el) el.textContent=`${mapped} / ${total} in current view mapped (${pct}%)`;}

/* ---------------- global filtering (unchanged) ---------------- */
function applyFilters(){ filtered=[...all]; // (use your global controls if present)
  // derive quartiles if uploaded
  if(haveSJR){ for (const p of filtered) p.quartile = resolveQuartile(p); }
  document.getElementById('kpiView').textContent=num(filtered.length);
  document.getElementById('kpiRetr').textContent=num(filtered.filter(x=>x.is_retracted||x.retraction_notice).length);
  document.getElementById('kpiQMap').textContent=num(filtered.filter(x=>quartileOf(x)).length);
  document.getElementById('kpiIF').textContent=num(IFcount);
  const journals=new Set(filtered.map(x=>(x.journal||'').trim()).filter(Boolean));
  document.getElementById('kpiJournals').textContent=num(journals.size);
  renderOverviewCharts(); renderSDGChart(); updateCoverage();
}

/* ---------------- per-chart filtering ---------------- */
function getFilteredForChart(canvasId){
  const f = perChartFilter.get(canvasId) || {};
  let rows = [...filtered]; // start from global view
  const yFrom = f.yearFrom?parseInt(f.yearFrom,10):null;
  const yTo   = f.yearTo?parseInt(f.yearTo,10):null;
  if (yFrom) rows = rows.filter(r => r.year && r.year >= yFrom);
  if (yTo)   rows = rows.filter(r => r.year && r.year <= yTo);
  if (f.excludeRetracted) rows = rows.filter(r => !(r.is_retracted||r.retraction_notice));
  if (f.types && f.types.size){
    rows = rows.filter(r => f.types.has(normalizeType(r.type||r.type_crossref)));
  }
  return rows;
}

/* ---------------- DATA panel (one reusable panel) ---------------- */
function openChartData(canvasId){
  const panel = document.getElementById('chartDataPanel');
  const btnRect = event.currentTarget.getBoundingClientRect();
  panel.style.top = `${btnRect.bottom + 8}px`;
  panel.style.left = `${Math.min(window.innerWidth-340, btnRect.right-320)}px`;
  const saved = perChartFilter.get(canvasId) || {};
  const typeOptions = knownTypes.map(t=>{
    const id=`cp_${canvasId}_${t.key}`;
    const checked = saved.types?.has(t.key) ? 'checked' : '';
    return `<label class="flex items-center gap-2"><input type="checkbox" id="${id}" ${checked}/> <span>${t.label} <span class="text-xs text-slate-400">(${t.count})</span></span></label>`;
  }).join('');
  panel.innerHTML = `
    <div class="flex items-center justify-between mb-2">
      <div class="font-semibold text-sm">Data filters</div>
      <button class="icon-btn" onclick="closeChartData()"><i data-lucide="x"></i></button>
    </div>
    <div class="space-y-2 text-sm">
      <div class="grid grid-cols-2 gap-2">
        <div><label class="block text-xs text-slate-500">Year from</label><input id="cp_from" type="number" class="w-full px-2 py-1.5 rounded-md border" value="${saved.yearFrom??''}"/></div>
        <div><label class="block text-xs text-slate-500">Year to</label><input id="cp_to" type="number" class="w-full px-2 py-1.5 rounded-md border" value="${saved.yearTo??''}"/></div>
      </div>
      <div class="flex items-center gap-2"><input id="cp_ex" type="checkbox" ${saved.excludeRetracted?'checked':''}/> <span>Exclude retracted</span></div>
      <div><div class="text-xs text-slate-500 mb-1">Types</div><div class="max-h-40 overflow-auto pr-1 space-y-1">${typeOptions}</div></div>
      <div class="pt-2 flex justify-between">
        <button class="px-3 py-1.5 rounded-lg border" onclick="resetChartData('${canvasId}')">Reset</button>
        <button class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white" onclick="applyChartData('${canvasId}')">Apply</button>
      </div>
    </div>`;
  panel.classList.remove('hidden');
  panel.dataset.canvasId = canvasId;
  lucide.createIcons();
}
function closeChartData(){ document.getElementById('chartDataPanel').classList.add('hidden'); }
function resetChartData(id){ perChartFilter.delete(id); rerenderOne(id); closeChartData(); }
function applyChartData(canvasId){
  const panel = document.getElementById('chartDataPanel');
  const yearFrom = document.getElementById('cp_from').value.trim();
  const yearTo   = document.getElementById('cp_to').value.trim();
  const excludeRetracted = document.getElementById('cp_ex').checked;
  const types = new Set();
  for (const t of knownTypes){
    const el=document.getElementById(`cp_${canvasId}_${t.key}`);
    if (el && el.checked) types.add(t.key);
  }
  perChartFilter.set(canvasId, {yearFrom,yearTo,excludeRetracted,types});
  rerenderOne(canvasId);
  closeChartData();
}

/* ---------------- charts ---------------- */
let chartByYear=null, chartTopJournalsC=null, chartIFTop=null, chartIFBubble=null, chartTypesYear=null, chartSubjects=null, chartHomeAuthors=null, chartRetract=null, chartSDG=null, chartPublishers=null;

function renderOverviewCharts(){
  // Publications by Year
  {
    const canvas='chartByYear';
    const ctx=document.getElementById(canvas).getContext('2d');
    const rows=getFilteredForChart(canvas);
    const byYear={}; for (const p of rows){ if (p.year) byYear[p.year]=(byYear[p.year]||0)+1; }
    const labels=Object.keys(byYear).sort((a,b)=>a-b);
    const data=labels.map(y=>byYear[y]);
    const cum=data.reduce((acc,v,i)=>{ acc.push((acc[i-1]||0)+v); return acc; },[]);
    if (chartByYear) chartByYear.destroy();
    chartByYear=new Chart(ctx,{type:'bar',data:{labels,datasets:[
      {label:'Publications',data, borderRadius:12, borderSkipped:false, backgroundColor:gradV(ctx,clr.indigo,clr.purple)},
      {label:'Cumulative',type:'line',data:cum,yAxisID:'y1',borderColor:clr.gray,tension:.25,pointRadius:2}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'},shadowPlugin:{},tooltip:{mode:'index',intersect:false}},scales:{x:{grid:{display:false},ticks:{color:'#334155'}},y:{grid:{color:'#e2e8f0'},ticks:{color:'#334155'},beginAtZero:true},y1:{position:'right',grid:{drawOnChartArea:false},ticks:{color:'#334155'},beginAtZero:true}}});
    chartInstances.set(canvas, chartByYear);
  }

  // Top Journals — Pubs vs Citations
  renderTopJournalsC();

  // IF charts
  renderIFCharts();

  // Types by Year
  renderTypesYear();

  // Subjects
  renderSubjects();

  // Home authors
  renderHomeAuthors();

  // Retractions
  renderRetract();

  // Publishers
  renderPublishers();
}

function computeTopAgg(rows){
  const byJournal=new Map();
  for (const p of rows){
    const j=(p.journal||'').trim(); if(!j) continue;
    const o=byJournal.get(j)||{total:0,cites:0};
    o.total++; o.cites += Number(p.citations||0);
    byJournal.set(j,o);
  }
  const top=[...byJournal.entries()].sort((a,b)=>b[1].total-a[1].total).slice(0,12);
  return { labels: top.map(([j])=>j), pubs: top.map(([,o])=>o.total), cites: top.map(([,o])=>o.cites) };
}
function renderTopJournalsC(){
  const canvas='chartTopJournalsC';
  const ctx=document.getElementById(canvas).getContext('2d');
  const rows=getFilteredForChart(canvas);
  const {labels,pubs,cites}=computeTopAgg(rows);
  if (chartTopJournalsC) chartTopJournalsC.destroy();
  chartTopJournalsC=new Chart(ctx,{type:'bar',data:{labels,datasets:[
    {label:'Publications',data:pubs,backgroundColor:gradH(ctx,clr.indigo,clr.purple),borderRadius:10,yAxisID:'y',order:1},
    {label:'Total citations',data:cites,backgroundColor:gradH(ctx,clr.teal,clr.cyan),borderRadius:10,yAxisID:'y1',order:2}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'},shadowPlugin:{}},scales:{x:{grid:{display:false},ticks:{color:'#334155',maxRotation:45,minRotation:45}},y:{beginAtZero:true,grid:{color:'#e2e8f0'},ticks:{color:'#334155'}},y1:{position:'right',beginAtZero:true,grid:{drawOnChartArea:false},ticks:{color:'#334155'}}}});
  chartInstances.set(canvas, chartTopJournalsC);
}

function renderIFCharts(){
  // Build IF rows from current per-chart filter base
  const rowsAll=getFilteredForChart('chartIFTop');
  const byJournal=new Map();
  for (const p of rowsAll){
    const j=(p.journal||'').trim(); if(!j) continue;
    const o=byJournal.get(j)||{issns:new Set(),count:0,cites:0}; (p.issns||[]).forEach(x=>o.issns.add(normIssn(x)));
    o.count++; o.cites += Number(p.citations||0); byJournal.set(j,o);
  }
  const rows=[];
  for (const [j,o] of byJournal.entries()){
    const meta = metricIFForJournal(j, o.issns);
    if (meta && meta.value>0) rows.push({journal:j, ifv:meta.value, count:o.count, cites:o.cites});
  }
  IFcount = rows.length;

  // Top IF
  const ctxTop=document.getElementById('chartIFTop').getContext('2d');
  if (chartIFTop) chartIFTop.destroy();
  document.getElementById('ifTopNote').textContent = rows.length ? '' : 'No IF data found in your uploaded file.';
  if (rows.length){
    const top=[...rows].sort((a,b)=>b.ifv-a.ifv).slice(0,12);
    chartIFTop=new Chart(ctxTop,{type:'bar',data:{labels:top.map(r=>r.journal),datasets:[{label:'Impact Factor (IF)',data:top.map(r=>r.ifv),borderRadius:12,borderSkipped:false,backgroundColor:gradH(ctxTop,clr.teal,clr.cyan)}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},shadowPlugin:{},tooltip:{callbacks:{label:(ctx)=>`IF: ${ctx.parsed.x}`}}},scales:{x:{beginAtZero:true,grid:{color:'#e2e8f0'},ticks:{color:'#334155'}},y:{grid:{display:false},ticks:{color:'#334155'}}}});
    chartInstances.set('chartIFTop', chartIFTop);
  }

  // IF vs Publications heatmap
  const ctxB=document.getElementById('chartIFBubble').getContext('2d');
  if (chartIFBubble) chartIFBubble.destroy();
  document.getElementById('ifBubNote').textContent = rows.length ? '' : 'No IF data found in your uploaded file.';
  if (rows.length){
    const ifBins=[0,2,4,6,8,10,12,14,16,18,20,100];
    const pubBins=[0,5,10,15,20,30,40,60,80,120,200,1e9];
    const binLabel=(edges,i)=>{ const a=edges[i],b=edges[i+1]; return b>=100||b>=1e9?`${a}+`:`${a}–${b}`; };
    const grid=Array.from({length:ifBins.length-1},()=>Array(pubBins.length-1).fill(0));
    const gridCites=Array.from({length:ifBins.length-1},()=>Array(pubBins.length-1).fill(0));
    const idx=(v,edges)=>{ for(let i=0;i<edges.length-1;i++) if(v>=edges[i]&&v<edges[i+1]) return i; return edges.length-2; };
    rows.forEach(r=>{ const xi=idx(r.ifv,ifBins), yi=idx(r.count,pubBins); grid[xi][yi]+=1; gridCites[xi][yi]+=(r.cites||0); });
    const data=[]; let vmax=0;
    for (let x=0;x<ifBins.length-1;x++){ for (let y=0;y<pubBins.length-1;y++){ const v=grid[x][y]; if(v>0){ data.push({x,y,v,cites:gridCites[x][y]}); vmax=Math.max(vmax,v);} } }
    chartIFBubble=new Chart(ctxB,{type:'matrix',data:{datasets:[{label:'Journals per bin',data,borderColor:'#14b8a6',backgroundColor:(c)=>{ const v=c.raw.v||0; const a=.15+.85*(v/(vmax||1)); return `rgba(20,184,166,${a})`;},width:({chart})=>{const w=chart.chartArea?chart.chartArea.width:0;return w?(w/(ifBins.length-1))-2:18;},height:({chart})=>{const h=chart.chartArea?chart.chartArea.height:0;return h?(h/(pubBins.length-1))-2:18;}}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{title:(items)=>{const r=items[0].raw;return `IF ${binLabel(ifBins,r.x)} · Publications ${binLabel(pubBins,r.y)}`;},label:(c)=>{const {v,cites}=c.raw; const parts=[`Journals: ${v}`]; if(cites) parts.push(`Citations: ${cites}`); return parts.join(' · ');}}},shadowPlugin:{}},scales:{x:{type:'linear',position:'bottom',min:-0.5,max:(ifBins.length-1)-0.5,grid:{color:'#e2e8f0'},ticks:{color:'#334155',callback:(value)=>{const i=Math.round(value); return (i>=0 && i<ifBins.length-1)?binLabel(ifBins,i):'';},maxRotation:0,autoSkip:false}},y:{type:'linear',reverse:true,min:-0.5,max:(pubBins.length-1)-0.5,grid:{color:'#e2e8f0'},ticks:{color:'#334155',callback:(value)=>{const i=Math.round(value); return (i>=0 && i<pubBins.length-1)?binLabel(pubBins,i):'';}}}}});
    chartInstances.set('chartIFBubble', chartIFBubble);
  }
}

function renderTypesYear(){
  const canvas='chartTypesYear';
  const ctx=document.getElementById(canvas).getContext('2d');
  const rows=getFilteredForChart(canvas);
  const map=new Map(), setTypes=new Set();
  for (const p of rows){ const y=p.year; if(y==null) continue; const t=normalizeType(p.type||p.type_crossref); setTypes.add(t); const row=map.get(y)||{}; row[t]=(row[t]||0)+1; map.set(y,row); }
  const years=[...map.keys()].sort((a,b)=>a-b); const types=[...setTypes];
  const datasets=types.map((t,i)=>({label:labelForType(t), data:years.map(y=>(map.get(y)||{})[t]||0), stack:'types', backgroundColor:`hsl(${(i*47)%360} 70% 55% / .85)`}));
  if (chartTypesYear) chartTypesYear.destroy();
  chartTypesYear=new Chart(ctx,{type:'bar',data:{labels:years,datasets},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'},shadowPlugin:{}},scales:{x:{stacked:true,grid:{display:false},ticks:{color:'#334155'}},y:{stacked:true,beginAtZero:true,grid:{color:'#e2e8f0'},ticks:{color:'#334155'}}}});
  chartInstances.set(canvas, chartTypesYear);
}

function renderSubjects(){
  const canvas='chartSubjects';
  const ctx=document.getElementById(canvas).getContext('2d');
  const rows=getFilteredForChart(canvas);
  const counts=new Map(); for (const p of rows){ for (const s of extractSubjectsList(p)){ counts.set(s,(counts.get(s)||0)+1);} }
  const top=[...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);
  if (chartSubjects) chartSubjects.destroy();
  chartSubjects=new Chart(ctx,{type:'bar',data:{labels:top.map(x=>x[0]),datasets:[{label:'Count',data:top.map(x=>x[1]),borderRadius:12,borderSkipped:false,backgroundColor:gradH(ctx,clr.indigo,clr.purple)}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},shadowPlugin:{}},scales:{x:{grid:{color:'#e2e8f0'},ticks:{color:'#334155'},beginAtZero:true},y:{grid:{display:false},ticks:{color:'#334155'}}}});
  chartInstances.set(canvas, chartSubjects);
}

function renderHomeAuthors(){
  const canvas='chartHomeAuthors';
  const ctx=document.getElementById(canvas).getContext('2d');
  const rows=getFilteredForChart(canvas);
  const counts=new Map(); for (const p of rows){ const arr=Array.isArray(p.home_authors)?p.home_authors:deriveHomeAuthors(p); for (const a of arr){ counts.set(a,(counts.get(a)||0)+1);} }
  const top=[...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,15);
  if (chartHomeAuthors) chartHomeAuthors.destroy();
  chartHomeAuthors=new Chart(ctx,{type:'bar',data:{labels:top.map(x=>x[0]),datasets:[{label:'Pubs',data:top.map(x=>x[1]),borderRadius:12,borderSkipped:false,backgroundColor:gradH(ctx,clr.teal,clr.cyan)}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},shadowPlugin:{}},scales:{x:{grid:{color:'#e2e8f0'},ticks:{color:'#334155'},beginAtZero:true},y:{grid:{display:false},ticks:{color:'#334155'}}}});
  chartInstances.set(canvas, chartHomeAuthors);
}

function renderRetract(){
  const canvas='chartRetract';
  const ctx=document.getElementById(canvas).getContext('2d');
  const rows=getFilteredForChart(canvas);
  const byYearFlag=new Map(), byYearNotice=new Map();
  for (const p of rows){ if(!p.year) continue; if(p.is_retracted) byYearFlag.set(p.year,(byYearFlag.get(p.year)||0)+1); if(p.retraction_notice) byYearNotice.set(p.year,(byYearNotice.get(p.year)||0)+1);}
  const years=[...new Set([...byYearFlag.keys(),...byYearNotice.keys()])].sort((a,b)=>a-b);
  if (chartRetract) chartRetract.destroy();
  chartRetract=new Chart(ctx,{type:'line',data:{labels:years,datasets:[{label:'OpenAlex retracted',data:years.map(y=>byYearFlag.get(y)||0),borderColor:clr.q4,tension:.25,pointRadius:2},{label:'Retraction notices (title)',data:years.map(y=>byYearNotice.get(y)||0),borderColor:clr.q3,tension:.25,pointRadius:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'},shadowPlugin:{}},scales:{x:{grid:{display:false},ticks:{color:'#334155'}},y:{beginAtZero:true,grid:{color:'#e2e8f0'},ticks:{color:'#334155'}}}});
  chartInstances.set(canvas, chartRetract);
}

function renderPublishers(){
  const canvas='chartPublishers';
  const ctx=document.getElementById(canvas).getContext('2d');
  const rows=getFilteredForChart(canvas);
  const map=new Map();
  for (const p of rows){ const pub=getPublisher(p); const j=(p.journal||'').trim(); if(!j) continue; const set=map.get(pub)||new Set(); set.add(j); map.set(pub,set); }
  const arr=[...map.entries()].map(([pub,set])=>({pub,count:set.size})).sort((a,b)=>b.count-a.count).slice(0,12);
  if (chartPublishers) chartPublishers.destroy();
  chartPublishers=new Chart(ctx,{type:'bar',data:{labels:arr.map(r=>r.pub),datasets:[{label:'Distinct journals',data:arr.map(r=>r.count),borderRadius:12,borderSkipped:false,backgroundColor:gradH(ctx,clr.indigo,clr.purple)}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},shadowPlugin:{}},scales:{x:{beginAtZero:true,grid:{color:'#e2e8f0'},ticks:{color:'#334155'}},y:{grid:{display:false},ticks:{color:'#334155'}}}});
  chartInstances.set(canvas, chartPublishers);
}

function renderSDGChart(){
  const canvas='chartSDG';
  const el=document.getElementById(canvas); if(!el) return;
  const ctx=el.getContext('2d');
  const rows=getFilteredForChart(canvas);
  const counts=new Array(18).fill(0); for (const p of rows){ for (const id of (p.sdg_tags||[])) counts[id]++; }
  if (chartSDG) chartSDG.destroy();
  const labels=SDG_LIST.map(s=>`${s.id}`), data=SDG_LIST.map(s=>counts[s.id]||0), colors=SDG_LIST.map(s=>SDG_COLORS[s.id]);
  chartSDG=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Count',data,borderRadius:12,borderSkipped:false,backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},shadowPlugin:{},tooltip:{mode:'index',intersect:false}},scales:{x:{grid:{display:false},ticks:{color:'#334155'}},y:{grid:{color:'#e2e8f0'},ticks:{color:'#334155'},beginAtZero:true}}}});
  chartInstances.set(canvas, chartSDG);
}

/* ---------------- Focus: live chart ---------------- */
let focusChart=null;
function focusCanvas(canvasId, title='Chart'){
  const src = chartInstances.get(canvasId);
  if (!src) return;
  document.getElementById('focusTitle').textContent = title;
  const overlay = document.getElementById('focusOverlay');
  overlay.classList.remove('hidden');
  const ctx = document.getElementById('focusCanvas').getContext('2d');
  if (focusChart) focusChart.destroy();
  // deep clone data/options to avoid mutating the small chart
  const data = JSON.parse(JSON.stringify(src.config.data));
  const options = JSON.parse(JSON.stringify(src.config.options || {}));
  options.maintainAspectRatio=false; options.plugins=options.plugins||{}; options.plugins.legend=options.plugins.legend||{position:'top'};
  focusChart = new Chart(ctx, { type: src.config.type, data, options });
  lucide.createIcons();
}
function closeFocus(){ document.getElementById('focusOverlay').classList.add('hidden'); if (focusChart){ focusChart.destroy(); focusChart=null; }}

/* ---------------- helpers for events ---------------- */
function rerenderOne(id){
  switch(id){
    case 'chartByYear': renderOverviewCharts(); break;
    case 'chartTopJournalsC': renderTopJournalsC(); break;
    case 'chartIFTop': case 'chartIFBubble': renderIFCharts(); break;
    case 'chartTypesYear': renderTypesYear(); break;
    case 'chartSubjects': renderSubjects(); break;
    case 'chartHomeAuthors': renderHomeAuthors(); break;
    case 'chartRetract': renderRetract(); break;
    case 'chartPublishers': renderPublishers(); break;
    case 'chartSDG': renderSDGChart(); break;
  }
}

/* ---------------- IF upload (unchanged logic) ---------------- */
document.getElementById('sjrFile')?.addEventListener('change', async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  const name=file.name.toLowerCase(); const text=await file.text();
  sjrByIssn.clear(); sjrByTitle.clear(); sjrMetaByIssn.clear(); sjrMetaByTitle.clear(); haveSJR=false; IFcount=0;
  try{
    if (name.endsWith('.json')) { const arr=JSON.parse(text); for (const row of arr) addQuartileRow(row); }
    else if (name.endsWith('.csv')){ parseCSV(text, addQuartileRow); }
    else { throw new Error('Unsupported file type'); }
    haveSJR = (sjrByIssn.size + sjrByTitle.size) > 0;
    const setIF = new Set([...sjrMetaByIssn.values(), ...sjrMetaByTitle.values()].map(v=>parseNum(v.if)).filter(Boolean));
    IFcount = setIF.size || 0;
    document.getElementById('sjrStatus').textContent = `Loaded ${sjrByIssn.size} ISSN and ${sjrByTitle.size} titles · IF entries: ${num(IFcount)}`;
    applyFilters();
  }catch(err){
    document.getElementById('sjrStatus').textContent = 'Failed: ' + err.message;
  }
});
function addQuartileRow(row){
  const q = normQuartile(row.quartile || row['SJR Best Quartile'] || row['Best Quartile'] || row['JIF Quartile'] || row.Quarter || row.Q || row.q || '');
  const title = normTitle(row.title || row.Title || row['Source title'] || row.Journal || '');
  const issnCell = row.issn || row.ISSN || row['ISSN / e-ISSN'] || row['ISSN print'] || row['ISSN (print)'] || row['ISSN/eISSN'] || '';
  const issns = String(issnCell).split(/[\/,;|\s]+/).map(normIssn).filter(Boolean);
  const IFval = row['Impact Factor'] || row['Impact factor'] || row['ImpactFactor'] || row['JCR Impact Factor'] || row['JCR IF'] || row['JIF'] || row['IF'] || row['2-year Impact Factor'] || row['Impact Factor (2023)'] || row['Impact Factor (2024)'] || row['Impact Factor (latest)'] || row.IF || '';
  const jif = parseNum(IFval);
  const meta = { q, if: (jif ?? null) };
  if (q){ if (issns.length){ for (const id of issns) sjrByIssn.set(id, q); } if (title) sjrByTitle.set(title, q); }
  if (issns.length){ for (const id of issns) sjrMetaByIssn.set(id, meta); }
  if (title) sjrMetaByTitle.set(title, meta);
}
function parseCSV(text, onRow){
  const lines=text.split(/\r?\n/).filter(l=>l.trim().length>0); if(!lines.length) throw new Error('Empty CSV');
  const hdrRaw=lines.shift(); const delim=(hdrRaw.match(/;/g)||[]).length>(hdrRaw.match(/,/g)||[]).length?';':','; const header=smartSplit(hdrRaw,delim).map(h=>h.trim());
  const idxTitle=findIndex(header,h=>/^(title|journal|source\s*title)$/i.test(h));
  const idxIssn =findIndex(header,h=>/issn/i.test(h));
  const idxQuart=findIndex(header,h=>/(quartile|best\s*quartile|sjr\s*best\s*quartile|^q$|jif\s*quartile)/i.test(h));
  let idxIF=-1; for(let i=0;i<header.length;i++){const hl=header[i].toLowerCase(); if(/(impact).*(factor)/.test(hl)||/(factor).*(impact)/.test(hl)||/\bjcr\b.*impact.*factor/.test(hl)||/\bjif\b/.test(hl)||/^if$/.test(hl)){ idxIF=i; break; } }
  if (idxQuart<0 && idxTitle<0 && idxIssn<0 && idxIF<0) throw new Error('Cannot find Title/ISSN/Quartile/IF columns');
  for (const line of lines){ const cols=smartSplit(line,delim); onRow({ title: idxTitle>=0?cols[idxTitle]:'', issn: idxIssn>=0?cols[idxIssn]:'', quartile: idxQuart>=0?cols[idxQuart]:'', 'Impact Factor': idxIF>=0?cols[idxIF]:'' });}
}
const smartSplit=(line,delim)=>{ const out=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='\"'){ inQ=!inQ; continue; } if(ch===delim && !inQ){ out.push(cur.trim()); cur=''; continue; } cur+=ch; } out.push(cur.trim()); return out; };
const findIndex=(arr,pred)=>{ for(let i=0;i<arr.length;i++){ if(pred(arr[i])) return i; } return -1; };

/* ---- Close DATA panel on outside click ---- */
document.addEventListener('click',(e)=>{
  const p=document.getElementById('chartDataPanel');
  if(p.classList.contains('hidden')) return;
  if(!p.contains(e.target) && !e.target.closest('button.icon-btn')) p.classList.add('hidden');
});

/* ---- init ---- */
document.addEventListener('DOMContentLoaded', ()=>{ buildSDGLegend(); autoLoad(); });
</script>
</body>
</html>
